<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCAT Command Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: #0c0d10;
      --bg-surface: #12131a;
      --bg-elevated: #1a1b25;
      --bg-hover: #22232f;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(255, 255, 255, 0.15);
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --focus: #0891B2;
      --growth: #4ade80;
      --energy: #fbbf24;
      --wisdom: #22D3EE;
      --calm: #06B6D4;
      --alert: #f87171;
      --cp: #60a5fa;
      --cars: #fbbf24;
      --bb: #4ade80;
      --ps: #c084fc;
      --gradient-start: #0c0d10;
      --gradient-end: #0c1a1c;
      --accent-glow: rgba(8, 145, 178, 0.08);
      --purple-glow: rgba(34, 211, 238, 0.08);
      --glass-bg: rgba(18, 19, 26, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { height: 100%; scroll-behavior: auto; }
    #main { overflow-anchor: none; }
    body {
      height: 100%;
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: linear-gradient(145deg, var(--gradient-start) 0%, #0e0f14 50%, var(--gradient-end) 100%);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(circle at 15% 25%, var(--accent-glow) 0%, transparent 35%),
        radial-gradient(circle at 85% 75%, var(--purple-glow) 0%, transparent 35%);
      pointer-events: none;
      z-index: 0;
    }

    /* ===== FLOATING PARTICLES ===== */
    #particles {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      opacity: 0.15;
      animation: float 25s infinite ease-in-out;
    }
    .particle:nth-child(odd) {
      background: var(--wisdom);
    }
    .particle:nth-child(even) {
      background: var(--focus);
    }
    .particle:nth-child(3n) {
      background: #fff;
      width: 2px;
      height: 2px;
      opacity: 0.1;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-30px) translateX(10px); }
      50% { transform: translateY(-10px) translateX(-10px); }
      75% { transform: translateY(-40px) translateX(5px); }
    }

    /* ===== CONFETTI ===== */
    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* ===== GRADIENT TEXT ===== */
    .gradient-text {
      background: linear-gradient(135deg, var(--focus) 0%, var(--wisdom) 50%, var(--growth) 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-shift 3s ease infinite;
    }
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* ===== 3D TILT CARDS ===== */
    .tilt-card {
      transform-style: preserve-3d;
      transform: perspective(1000px) rotateX(var(--rotateX, 0deg)) rotateY(var(--rotateY, 0deg));
      transition: transform 0.1s ease-out;
    }
    .tilt-card:hover {
      transition: transform 0.1s ease-out;
    }

    /* ===== CIRCULAR PROGRESS ===== */
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s ease;
    }

    /* ===== ANIMATED COUNTER ===== */
    .counter {
      display: inline-block;
      font-variant-numeric: tabular-nums;
    }

    /* ===== XP BAR ===== */
    .xp-bar {
      height: 6px;
      background: var(--bg-base);
      border-radius: 3px;
      overflow: hidden;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--energy), var(--growth));
      border-radius: 3px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .xp-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: xp-shine 2s infinite;
    }
    @keyframes xp-shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* ===== ACHIEVEMENT BADGE ===== */
    .achievement {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .achievement.locked {
      filter: grayscale(1) opacity(0.4);
    }
    .achievement:not(.locked):hover {
      transform: scale(1.15) rotate(5deg);
    }
    .achievement-glow {
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      background: conic-gradient(var(--focus), var(--wisdom), var(--growth), var(--energy), var(--focus));
      opacity: 0;
      animation: none;
      z-index: -1;
    }
    .achievement:not(.locked) .achievement-glow {
      opacity: 0.6;
      animation: rotate-glow 3s linear infinite;
    }
    @keyframes rotate-glow {
      to { transform: rotate(360deg); }
    }

    /* ===== HEATMAP ===== */
    .heatmap-cell {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      transition: all 0.2s ease;
    }
    .heatmap-cell:hover {
      transform: scale(1.4);
      z-index: 10;
      cursor: pointer;
    }
    .heatmap-cell.today {
      outline: 2px solid var(--focus);
      outline-offset: 1px;
    }
    .heatmap-cell.streak {
      border: 1px solid rgba(251,191,36,0.5);
    }
    .heatmap-tooltip {
      position: absolute;
      background: var(--bg-card);
      border-radius: 0.5rem;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-size: 0.875rem;
      z-index: 50;
      min-width: 150px;
      pointer-events: none;
    }

    /* ===== FOCUS MODE ===== */
    .focus-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-base);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .focus-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .focus-timer {
      font-family: 'Space Mono', monospace;
      font-size: 8rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--focus) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ===== KEYBOARD SHORTCUT HINT ===== */
    .kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 6px;
      background: var(--bg-base);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .shortcuts-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .shortcuts-modal.show {
      opacity: 1;
      visibility: visible;
    }

    /* ===== EXISTING STYLES (enhanced) ===== */
    .bg-warm {
      background: linear-gradient(145deg, #252a33 0%, #2a3039 50%, #252a33 100%);
      position: relative;
      z-index: 1;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

    .font-mono { font-family: 'Space Mono', monospace; }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(8, 145, 178, 0.06), transparent 40%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(8, 145, 178, 0.2), rgba(34, 211, 238, 0.2), transparent);
      opacity: 0.4;
      transition: opacity 0.3s;
    }
    .card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: 0 20px 40px -15px rgba(0,0,0,0.4);
    }
    .card:hover::after { opacity: 1; }
    .card:hover::before { opacity: 1; }

    .glow-card {
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .glow-card:hover { transform: translateY(-3px); }
    .glow-card.glow-blue:hover { box-shadow: 0 15px 30px -10px rgba(96, 165, 250, 0.25); border-color: rgba(96, 165, 250, 0.2); }
    .glow-card.glow-green:hover { box-shadow: 0 15px 30px -10px rgba(74, 222, 128, 0.25); border-color: rgba(74, 222, 128, 0.2); }
    .glow-card.glow-amber:hover { box-shadow: 0 15px 30px -10px rgba(251, 191, 36, 0.25); border-color: rgba(251, 191, 36, 0.2); }
    .glow-card.glow-purple:hover { box-shadow: 0 15px 30px -10px rgba(34, 211, 238, 0.25); border-color: rgba(34, 211, 238, 0.2); }
    .glow-card.glow-pink:hover { box-shadow: 0 15px 30px -10px rgba(244, 114, 182, 0.25); border-color: rgba(244, 114, 182, 0.2); }

    /* Section score cards with accent bar + glow */
    .section-score-card {
      position: relative;
      overflow: hidden;
    }
    .section-score-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 16px;
      right: 16px;
      height: 3px;
      background: var(--card-accent);
      border-radius: 0 0 9999px 9999px;
    }
    .section-score-card::after {
      content: '';
      position: absolute;
      top: -60%;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, var(--card-accent) 0%, transparent 70%);
      opacity: 0.08;
      pointer-events: none;
    }
    .section-score-card .score-delta {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 6px;
    }
    .section-score-card .score-delta.up {
      color: var(--growth);
      background: rgba(74, 222, 128, 0.1);
    }
    .section-score-card .score-delta.down {
      color: var(--alert);
      background: rgba(248, 113, 113, 0.1);
    }
    .section-score-card .score-delta.same {
      color: var(--text-muted);
      background: rgba(255,255,255,0.05);
    }

    .list-item {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .list-item:hover {
      background: var(--bg-elevated);
      border-color: var(--border-default);
      transform: translateX(4px);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary {
      background: linear-gradient(135deg, var(--focus) 0%, var(--calm) 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px -10px rgba(8, 145, 178, 0.4), 0 5px 20px -5px rgba(6, 182, 212, 0.25);
    }
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }
    .btn-secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }
    .btn-ghost:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .input {
      background: var(--bg-base);
      border: 1px solid var(--border-default);
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 0.875rem;
      color: var(--text-primary);
      transition: all 0.2s ease;
      outline: none;
      width: 100%;
    }
    .input:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.15);
    }
    .input::placeholder { color: var(--text-muted); }

    /* Date input calendar icon fix */
    input[type="date"] {
      color-scheme: dark;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    select.input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%237d786f' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 44px;
      cursor: pointer;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--text-muted);
      font-weight: 500;
      transition: all var(--transition-fast);
      cursor: pointer;
      position: relative;
    }
    .nav-item::before { display: none; }
    .nav-item:hover {
      color: var(--text-secondary);
      background: var(--bg-elevated);
    }
    .nav-item.active {
      color: var(--text-primary);
      background: var(--bg-surface);
      box-shadow: var(--shadow-sm);
    }

    .progress-track {
      height: 8px;
      background: var(--bg-base);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .stat-value {
      font-family: 'Space Mono', monospace;
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .chart-bar {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .chart-bar:hover {
      transform: scaleY(1.1);
      filter: brightness(1.2);
    }
    .chart-bar::before {
      content: attr(data-value);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      padding: 4px 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.2s ease;
      pointer-events: none;
    }
    .chart-bar:hover::before {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .topic-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    .topic-card:hover {
      background: var(--bg-hover);
      border-color: var(--border-hover);
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
    }

    .mastery-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }
    .mastery-btn::after {
      content: '';
      position: absolute;
      inset: -8px;
    }
    .mastery-btn:hover {
      transform: scale(1.15);
      z-index: 10;
    }
    .mastery-btn.selected {
      box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 12px;
      background: rgba(18, 19, 26, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border-default);
      color: var(--text-primary);
      font-weight: 500;
      transform: translateY(100px) scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .toast.show { transform: translateY(0) scale(1); opacity: 1; }
    .toast.success { border-left: 4px solid var(--growth); }
    .toast.error { border-left: 4px solid var(--alert); }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 100;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      transform: scale(0.9) translateY(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal-overlay.show .modal-content { transform: scale(1) translateY(0); }

    .streak-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #000;
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .streak-banner:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 30px -10px rgba(245, 158, 11, 0.4);
    }
    .streak-icon { animation: flame 1s ease infinite; }
    @keyframes flame {
      0%, 100% { transform: scale(1) rotate(-3deg); }
      50% { transform: scale(1.1) rotate(3deg); }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeUp 0.4s ease forwards; }
    .no-animate .animate-in,
    .no-animate .table-row,
    .no-animate .glow-card { animation: none !important; opacity: 1 !important; transform: none !important; }
    .delay-1 { animation-delay: 0.05s; opacity: 0; }
    .delay-2 { animation-delay: 0.1s; opacity: 0; }
    .delay-3 { animation-delay: 0.15s; opacity: 0; }
    .delay-4 { animation-delay: 0.2s; opacity: 0; }

    /* Staggered glass row entrance */
    @keyframes glassSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .glass-list .table-row {
      animation: glassSlideIn 0.3s ease forwards;
    }

    .section-tab {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.25s ease;
      cursor: pointer;
    }
    .section-tab:hover { transform: translateY(-2px); }
    .section-tab.active {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px -10px currentColor;
    }

    .timer-display {
      font-family: 'Space Mono', monospace;
      font-size: 4rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .timer-display.running { animation: pulse 2s ease infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Sleek glassmorphic table rows */
    .glass-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 16px;
    }

    .table-row {
      display: grid;
      align-items: center;
      padding: 14px 20px;
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 12px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .table-row::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(8, 145, 178, 0.02) 100%);
      opacity: 0;
      transition: opacity 0.25s ease;
      border-radius: 12px;
    }

    /* Subtle shimmer effect */
    .table-row::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.02),
        rgba(255, 255, 255, 0.04),
        rgba(255, 255, 255, 0.02),
        transparent
      );
      transform: skewX(-20deg);
      transition: left 0.5s ease;
      pointer-events: none;
    }

    .table-row:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.04);
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    }

    .table-row:hover::before {
      opacity: 1;
    }

    .table-row:hover::after {
      left: 150%;
    }

    .table-row > * {
      position: relative;
      z-index: 1;
    }

    .delete-btn {
      opacity: 0;
      transform: scale(0.9);
      transition: all 0.2s ease;
    }
    .table-row:hover .delete-btn {
      opacity: 0.5;
      transform: scale(1);
    }
    .delete-btn:hover {
      opacity: 1 !important;
      color: var(--alert) !important;
      transform: scale(1.1) !important;
    }

    /* Sleek glass header */
    .glass-header {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding: 14px 20px;
    }

    /* Empty state styling */
    .glass-list .empty-state {
      padding: 48px 24px;
      text-align: center;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.01);
      border-radius: 12px;
      border: 1px dashed rgba(255, 255, 255, 0.06);
    }

    .glass-list .empty-state .empty-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.6;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    /* Sleek scrollbar */
    .glass-list::-webkit-scrollbar {
      width: 4px;
    }
    .glass-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .glass-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    .glass-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"] { -moz-appearance: textfield; }

    .focus-item { transition: all 0.2s ease; }
    .focus-item:hover { transform: translateX(8px); }
    .focus-item:hover .focus-arrow { transform: translateX(4px); opacity: 1; }
    .focus-arrow { opacity: 0; transition: all 0.2s ease; }

    /* Level badge */
    .level-badge {
      background: linear-gradient(135deg, var(--energy), #d97706);
      color: #000;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
    }

    /* Quote card */
    .quote-card {
      background: linear-gradient(135deg, rgba(8, 145, 178, 0.08), rgba(34, 211, 238, 0.08));
      border: 1px solid rgba(8, 145, 178, 0.15);
      border-radius: 12px;
      padding: 16px;
      font-style: italic;
    }

    /* Phase 3A: Stagger animation */
    .stagger-children > * {
      opacity: 0;
      animation: fadeUp 0.35s ease-out forwards;
    }
    .stagger-children > *:nth-child(1) { animation-delay: 0.03s; }
    .stagger-children > *:nth-child(2) { animation-delay: 0.06s; }
    .stagger-children > *:nth-child(3) { animation-delay: 0.09s; }
    .stagger-children > *:nth-child(4) { animation-delay: 0.12s; }
    .stagger-children > *:nth-child(5) { animation-delay: 0.15s; }
    .stagger-children > *:nth-child(6) { animation-delay: 0.18s; }
    .stagger-children > *:nth-child(7) { animation-delay: 0.21s; }
    .stagger-children > *:nth-child(8) { animation-delay: 0.24s; }

    /* Phase 4: Dashboard stat card glow */
    .dash-stat-card {
      position: relative;
      overflow: hidden;
    }
    .dash-stat-card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, var(--card-glow, var(--focus)) 0%, transparent 70%);
      opacity: 0.08;
      pointer-events: none;
    }

    /* Phase 1E: prefers-reduced-motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .particle, .confetti, .confetti-v2 { display: none !important; }
      .tilt-card { transform: none !important; }
      .progress-fill::after { animation: none !important; }
      .xp-fill::after { animation: none !important; }
      .streak-icon { animation: none !important; }
      .timer-display.running { animation: none !important; }
      .reveal, .reveal-left, .reveal-scale { opacity: 1 !important; transform: none !important; }
      .tab-enter, .tab-exit { animation: none !important; opacity: 1 !important; }
      .skeleton { animation: none !important; }
      .magnetic-btn { transition: none !important; }
    }

    /* ===== PREMIUM ANIMATIONS ===== */

    /* Tab crossfade transition */
    @keyframes tabEnter {
      from { opacity: 0; transform: translateY(12px) scale(0.99); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes tabExit {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(-8px) scale(0.99); }
    }
    .tab-enter {
      animation: tabEnter 0.35s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    .tab-exit {
      animation: tabExit 0.15s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      pointer-events: none;
    }

    /* Scroll reveal */
    .reveal {
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1), transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .reveal-left {
      opacity: 0;
      transform: translateX(-24px);
      transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1), transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .reveal-left.visible {
      opacity: 1;
      transform: translateX(0);
    }
    .reveal-scale {
      opacity: 0;
      transform: scale(0.92);
      transition: opacity 0.5s cubic-bezier(0.22, 1, 0.36, 1), transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .reveal-scale.visible {
      opacity: 1;
      transform: scale(1);
    }

    /* Odometer-style number morphing */
    .odometer-digit {
      display: inline-flex;
      overflow: hidden;
      height: 1em;
      vertical-align: top;
    }
    .odometer-track {
      display: flex;
      flex-direction: column;
      transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .odometer-track span {
      height: 1em;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Button ripple effect */
    .btn-ripple {
      position: relative;
      overflow: hidden;
    }
    .btn-ripple .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      transform: scale(0);
      animation: rippleExpand 0.5s ease-out forwards;
      pointer-events: none;
    }
    @keyframes rippleExpand {
      to { transform: scale(4); opacity: 0; }
    }

    /* Mastery level-up burst */
    @keyframes masteryBurst {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(8, 145, 178, 0.4); }
      50% { transform: scale(1.08); box-shadow: 0 0 0 12px rgba(8, 145, 178, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(8, 145, 178, 0); }
    }
    .mastery-burst {
      animation: masteryBurst 0.4s ease-out;
    }

    /* Card cursor glow */
    .cursor-glow {
      position: relative;
    }
    .cursor-glow::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(400px circle at var(--glow-x, 50%) var(--glow-y, 50%), rgba(8, 145, 178, 0.08), transparent 40%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 0;
    }
    .cursor-glow:hover::before { opacity: 1; }

    /* Magnetic button hover */
    .magnetic-btn {
      transition: transform 0.2s cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* Loading shimmer skeleton */
    @keyframes skeletonShimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, var(--bg-elevated) 25%, rgba(255,255,255,0.06) 50%, var(--bg-elevated) 75%);
      background-size: 200% 100%;
      animation: skeletonShimmer 1.5s ease infinite;
      border-radius: 8px;
    }
    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
      width: 60%;
    }
    .skeleton-block {
      height: 80px;
      width: 100%;
    }

    /* Score reveal */
    @keyframes scoreRevealPop {
      0% { transform: scale(0.6); opacity: 0; filter: blur(8px); }
      60% { transform: scale(1.12); opacity: 1; filter: blur(0); }
      100% { transform: scale(1); opacity: 1; filter: blur(0); }
    }
    .score-reveal {
      animation: scoreRevealPop 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    /* Confetti v2 ‚Äî spinning squares + circles */
    @keyframes confettiV2 {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translateY(100vh) rotate(var(--confetti-rot, 720deg)) scale(0.3); opacity: 0; }
    }
    .confetti-v2 {
      position: absolute;
      width: var(--confetti-size, 8px);
      height: var(--confetti-size, 8px);
      background: var(--confetti-color, var(--focus));
      animation: confettiV2 var(--confetti-dur, 2.5s) cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
      animation-delay: var(--confetti-delay, 0s);
    }

    /* Nav item transition glow */
    .nav-item.active::after {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: var(--focus);
      border-radius: 0 4px 4px 0;
      animation: navGlow 0.3s ease forwards;
    }
    @keyframes navGlow {
      from { height: 0; opacity: 0; }
      to { height: 60%; opacity: 1; }
    }

    /* Progress ring animation */
    @keyframes ringDraw {
      from { stroke-dashoffset: var(--ring-circumference); }
      to { stroke-dashoffset: var(--ring-target); }
    }
    .progress-ring-circle.animate-ring {
      animation: ringDraw 1s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    /* Hover lift for interactive cards */
    .hover-lift {
      transition: transform 0.25s cubic-bezier(0.22, 1, 0.36, 1), box-shadow 0.25s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px -12px rgba(0,0,0,0.35);
    }

    /* Stagger delays for reveal children */
    .stagger-reveal > .reveal:nth-child(1) { transition-delay: 0s; }
    .stagger-reveal > .reveal:nth-child(2) { transition-delay: 0.06s; }
    .stagger-reveal > .reveal:nth-child(3) { transition-delay: 0.12s; }
    .stagger-reveal > .reveal:nth-child(4) { transition-delay: 0.18s; }
    .stagger-reveal > .reveal:nth-child(5) { transition-delay: 0.24s; }
    .stagger-reveal > .reveal:nth-child(6) { transition-delay: 0.30s; }
    .stagger-reveal > .reveal:nth-child(7) { transition-delay: 0.36s; }
    .stagger-reveal > .reveal:nth-child(8) { transition-delay: 0.42s; }

    /* Pulse dot for live indicators */
    @keyframes pulseDot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.5); }
    }
    .pulse-dot {
      animation: pulseDot 2s ease infinite;
    }

    /* Journal text clamp */
    .journal-text {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .journal-text:not(.line-clamp-2) {
      -webkit-line-clamp: unset;
    }
    .journal-text.line-clamp-2 {
      -webkit-line-clamp: 3;
    }

    /* Guide article typography */
    .guide-body p { margin-bottom: 0.75rem; }
    .guide-body ul, .guide-body ol { margin-bottom: 0.75rem; }

    /* ===== ONBOARDING WIZARD ===== */
    .wizard-container {
      min-height: 100vh;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      position: relative;
    }
    .wizard-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
    }
    .wizard-panel {
      max-width: 500px;
      width: 100%;
      position: relative;
      z-index: 1;
      background: rgba(18, 19, 26, 0.7);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 36px 32px 28px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.03) inset;
      animation: wizardPanelIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    .wizard-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 32px;
      right: 32px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--focus), transparent);
      border-radius: 0 0 2px 2px;
    }
    .wizard-step {
      animation: wizard-enter 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
    @keyframes wizard-enter {
      from { opacity: 0; transform: translateY(20px) scale(0.97); filter: blur(4px); }
      to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    }
    @keyframes wizardPanelIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .wizard-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
      letter-spacing: -0.01em;
    }
    .wizard-subtitle {
      color: var(--text-muted);
      margin-bottom: 28px;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    .wizard-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .wizard-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-default);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s ease;
    }
    .wizard-input:focus {
      border-color: var(--focus);
    }
    .wizard-input::placeholder {
      color: var(--text-muted);
    }
    .wizard-card {
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .wizard-card:hover {
      border-color: var(--border-prominent);
    }
    .wizard-card.selected {
      border-color: var(--focus);
      background: rgba(8,145,178,0.06);
    }
    .wizard-card.selected .wc-title { color: var(--focus); }
    .wc-title {
      font-weight: 600;
      font-size: 0.88rem;
      margin-bottom: 1px;
    }
    .wc-desc {
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .wizard-progress {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 32px;
    }
    .wizard-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border-default);
      transition: all 0.2s ease;
    }
    .wizard-dot.active {
      background: var(--focus);
      width: 20px;
      border-radius: 3px;
    }
    .wizard-dot.done { background: var(--focus); }
    .wizard-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-top: 20px;
    }
    .wizard-btn-primary {
      background: var(--focus);
      color: white;
    }
    .wizard-btn-primary:hover { opacity: 0.9; }
    .wizard-btn-primary:active { transform: scale(0.98); }
    .wizard-btn-primary:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      transform: none;
    }
    .wizard-btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-default);
      margin-top: 8px;
    }
    .wizard-btn-ghost:hover { border-color: var(--border-prominent); color: var(--text-secondary); }
    .wizard-goal-btn {
      width: 52px;
      height: 44px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .wizard-goal-btn:hover { border-color: var(--border-prominent); }
    .wizard-goal-btn.selected {
      border-color: var(--focus);
      background: rgba(8,145,178,0.08);
      color: var(--focus);
    }
    .wizard-score-input {
      width: 64px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border-default);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      outline: none;
      transition: border-color 0.15s ease;
    }
    .wizard-score-input:focus { border-color: var(--focus); }
    .wizard-score-input::placeholder { color: var(--text-muted); font-weight: 400; }
  </style>
</head>
<body class="bg-warm">
  <div id="particles"></div>
  <div id="confetti-container" class="confetti-container"></div>
  <div id="app" class="h-full flex relative z-10"></div>
  <div id="toast" class="toast"></div>
  <div id="modal" class="modal-overlay"></div>
  <div id="focus-mode" class="focus-overlay"></div>
  <div id="shortcuts-modal" class="shortcuts-modal"></div>
  <div id="heatmap-tip" class="heatmap-tooltip" style="display:none;position:fixed"></div>

  <script>
    // ===== STATE =====
    let state = {
      tab: 'dashboard',
      testDate: localStorage.getItem('mcat-date') || new Date(Date.now() + 90*86400000).toISOString().split('T')[0],
      targetScore: parseInt(localStorage.getItem('mcat-target')) || 515,
      logs: JSON.parse(localStorage.getItem('mcat-logs') || '[]'),
      tests: JSON.parse(localStorage.getItem('mcat-tests') || '[]'),
      mastery: JSON.parse(localStorage.getItem('mcat-mastery') || '{}'),
      resources: JSON.parse(localStorage.getItem('mcat-resources') || 'null'),
      section: 'C/P',
      streak: parseInt(localStorage.getItem('mcat-streak') || '0'),
      lastStudyDate: localStorage.getItem('mcat-last-study') || null,
      dailyGoal: parseFloat(localStorage.getItem('mcat-daily-goal') || '4'),
      timerRunning: false,
      timerSeconds: 0,
      timerCategory: 'Content Review',
      pomodoroMode: true,
      pomodoroMinutes: parseInt(localStorage.getItem('mcat-pomo-min') || '25'),
      pomodoroBreakMinutes: parseInt(localStorage.getItem('mcat-pomo-break') || '5'),
      pomodoroLongBreakMinutes: parseInt(localStorage.getItem('mcat-pomo-long-break') || '15'),
      pomodoroSessionCount: parseInt(localStorage.getItem('mcat-pomo-sessions') || '0'),
      pomodoroSessionsUntilLongBreak: 4,
      isBreak: false,
      timerSoundEnabled: localStorage.getItem('mcat-timer-sound') !== 'false',
      xp: parseInt(localStorage.getItem('mcat-xp') || '0'),
      focusMode: false,
      achievements: JSON.parse(localStorage.getItem('mcat-achievements') || '{}'),
      achievementFilter: 'all',
      _expandedBook: null,
      _expandedChapter: null,
      _expandedVideo: null,
      _expandedUnit: null,
      contentCategory: null,
      yieldFilter: 'all',
      contentSort: 'default',
      myResources: JSON.parse(localStorage.getItem('mcat-myResources') || '[]'),
      resourceView: 'my',
      resourceFilter: 'all',
      userName: localStorage.getItem('mcat-user-name') || '',
      studyPhase: localStorage.getItem('mcat-study-phase') || 'content',
      // Study log topic picker (form state, not persisted)
      logSection: null,
      logTopics: [],
      logTopicSearch: '',
      // Journal
      journal: JSON.parse(localStorage.getItem('mcat-journal') || '[]'),
      // Study Guide UI state
      guideSearch: '',
      guideExpanded: {}
    };

    // ===== FILE SYSTEM SAVE (Chrome/Edge) =====
    let fileHandle = null;
    let saveStatus = 'idle'; // 'idle', 'saving', 'saved', 'error'
    const supportsFileSystem = 'showSaveFilePicker' in window;

    async function connectSaveFile() {
      if (!supportsFileSystem) {
        showToast('Your browser doesn\'t support file saving. Using local backup.', 'error');
        return;
      }
      try {
        fileHandle = await window.showSaveFilePicker({
          suggestedName: 'mcat-dashboard-data.json',
          types: [{
            description: 'JSON Data',
            accept: { 'application/json': ['.json'] }
          }]
        });
        await saveToFile();
        showToast('Save file connected! Your data will auto-save.');
        render();
      } catch (e) {
        if (e.name !== 'AbortError') {
          showToast('Could not connect save file', 'error');
        }
      }
    }

    async function loadSaveFile() {
      if (!supportsFileSystem) {
        showToast('Your browser doesn\'t support file loading. Use Import instead.', 'error');
        return;
      }
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{
            description: 'JSON Data',
            accept: { 'application/json': ['.json'] }
          }]
        });
        fileHandle = handle;
        const file = await fileHandle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);

        // Restore state
        state.testDate = data.testDate || state.testDate;
        state.targetScore = data.targetScore || state.targetScore;
        state.logs = data.logs || [];
        state.tests = data.tests || [];
        state.mastery = data.mastery || {};
        state.resources = data.resources || state.resources;
        state.myResources = data.myResources || [];
        state.streak = data.streak || 0;
        state.lastStudyDate = data.lastStudyDate || null;
        state.dailyGoal = data.dailyGoal || 4;
        state.xp = data.xp || 0;
        state.achievements = data.achievements || {};

        save(); // Also save to localStorage as backup
        render();
        showToast('Data loaded! Auto-save connected.');
      } catch (e) {
        if (e.name !== 'AbortError') {
          showToast('Could not load file', 'error');
        }
      }
    }

    async function saveToFile() {
      if (!fileHandle) return;
      try {
        saveStatus = 'saving';
        updateSaveIndicator();

        const data = {
          testDate: state.testDate,
          targetScore: state.targetScore,
          logs: state.logs,
          tests: state.tests,
          mastery: state.mastery,
          resources: state.resources,
          myResources: state.myResources,
          streak: state.streak,
          lastStudyDate: state.lastStudyDate,
          dailyGoal: state.dailyGoal,
          xp: state.xp,
          achievements: state.achievements,
          savedAt: new Date().toISOString()
        };

        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(data, null, 2));
        await writable.close();

        saveStatus = 'saved';
        updateSaveIndicator();
        setTimeout(() => { saveStatus = 'idle'; updateSaveIndicator(); }, 2000);
      } catch (e) {
        saveStatus = 'error';
        updateSaveIndicator();
        console.error('Save failed:', e);
      }
    }

    function updateSaveIndicator() {
      const el = document.getElementById('save-indicator');
      if (!el) return;
      if (saveStatus === 'saving') {
        el.innerHTML = '<span class="animate-pulse">Saving...</span>';
        el.className = 'text-xs text-[var(--text-muted)]';
      } else if (saveStatus === 'saved') {
        el.innerHTML = '‚úì Saved';
        el.className = 'text-xs text-[var(--growth)]';
      } else if (saveStatus === 'error') {
        el.innerHTML = '‚úó Save failed';
        el.className = 'text-xs text-[var(--alert)]';
      } else {
        el.innerHTML = fileHandle ? '‚óè Connected' : '';
        el.className = 'text-xs text-[var(--text-muted)]';
      }
    }

    // ===== GAMIFICATION =====
    // ===== LEVELS (25 tiers) =====
    const LEVELS = [
      { level: 1,  xp: 0,     title: 'Aspiring',      icon: 'üå±' },
      { level: 2,  xp: 75,    title: 'Curious',        icon: 'üîç' },
      { level: 3,  xp: 200,   title: 'Student',        icon: 'üìñ' },
      { level: 4,  xp: 400,   title: 'Scholar',        icon: 'üìö' },
      { level: 5,  xp: 700,   title: 'Apprentice',     icon: 'üß™' },
      { level: 6,  xp: 1100,  title: 'Dedicated',      icon: 'üí™' },
      { level: 7,  xp: 1600,  title: 'Committed',      icon: 'üéØ' },
      { level: 8,  xp: 2200,  title: 'Focused',        icon: 'üî¨' },
      { level: 9,  xp: 2900,  title: 'Adept',          icon: '‚öóÔ∏è' },
      { level: 10, xp: 3700,  title: 'Expert',         icon: 'üß†' },
      { level: 11, xp: 4600,  title: 'Specialist',     icon: 'üèÖ' },
      { level: 12, xp: 5600,  title: 'Master',         icon: 'üéì' },
      { level: 13, xp: 6800,  title: 'Authority',      icon: 'üìä' },
      { level: 14, xp: 8200,  title: 'Virtuoso',       icon: 'üåü' },
      { level: 15, xp: 9800,  title: 'Sage',           icon: 'üîÆ' },
      { level: 16, xp: 11600, title: 'Professor',      icon: 'üë®‚Äçüî¨' },
      { level: 17, xp: 13600, title: 'Prodigy',        icon: '‚ö°' },
      { level: 18, xp: 15800, title: 'Phenom',         icon: 'üå†' },
      { level: 19, xp: 18200, title: 'Guru',           icon: 'üßò' },
      { level: 20, xp: 21000, title: 'Legend',          icon: 'üëë' },
      { level: 21, xp: 24000, title: 'Mythic',          icon: 'üèõÔ∏è' },
      { level: 22, xp: 27500, title: 'Transcendent',    icon: '‚ú®' },
      { level: 23, xp: 31500, title: 'Immortal',        icon: 'üî•' },
      { level: 24, xp: 36000, title: 'Ascended',        icon: 'üåå' },
      { level: 25, xp: 42000, title: 'MCAT God',        icon: 'üí´' }
    ];

    // ===== ACHIEVEMENTS (50+) =====
    const _totalHrs = () => state.logs.reduce((s,l)=>s+l.hours,0);
    const _hrsByDay = () => { const d={}; state.logs.forEach(l=>{d[l.date]=(d[l.date]||0)+l.hours;}); return d; };
    const ACHIEVEMENTS = [
      // Streaks (8)
      { id:'streak_3',icon:'üî•',name:'On Fire',desc:'3-day streak',tier:'bronze',cat:'streak',check:()=>state.streak>=3},
      { id:'streak_7',icon:'üåü',name:'Week Warrior',desc:'7-day streak',tier:'silver',cat:'streak',check:()=>state.streak>=7},
      { id:'streak_14',icon:'‚ö°',name:'Fortnight Focus',desc:'14-day streak',tier:'silver',cat:'streak',check:()=>state.streak>=14},
      { id:'streak_30',icon:'üíé',name:'Monthly Master',desc:'30-day streak',tier:'gold',cat:'streak',check:()=>state.streak>=30},
      { id:'streak_60',icon:'üèîÔ∏è',name:'Unstoppable',desc:'60-day streak',tier:'gold',cat:'streak',check:()=>state.streak>=60},
      { id:'streak_90',icon:'üåã',name:'Iron Will',desc:'90-day streak',tier:'platinum',cat:'streak',check:()=>state.streak>=90},
      { id:'streak_weekend',icon:'üìÖ',name:'No Days Off',desc:'Study on Sat & Sun same week',tier:'bronze',cat:'streak',check:()=>{const w=new Date();const s=new Date(w);s.setDate(w.getDate()-w.getDay());const sat=new Date(s);sat.setDate(sat.getDate()+6);const sun=new Date(s);return state.logs.some(l=>l.date===sun.toISOString().split('T')[0])&&state.logs.some(l=>l.date===sat.toISOString().split('T')[0]);}},
      { id:'streak_early',icon:'üåÖ',name:'Early Bird',desc:'Add "morning" to a session note',tier:'bronze',cat:'streak',check:()=>state.logs.some(l=>l.notes&&l.notes.toLowerCase().includes('morning'))},
      // Study Hours (10)
      { id:'first_hour',icon:'‚è±Ô∏è',name:'First Hour',desc:'Log your first study hour',tier:'bronze',cat:'hours',check:()=>_totalHrs()>=1},
      { id:'hours_10',icon:'üìö',name:'Bookworm',desc:'10 total hours',tier:'bronze',cat:'hours',check:()=>_totalHrs()>=10},
      { id:'hours_25',icon:'üìñ',name:'Page Turner',desc:'25 total hours',tier:'bronze',cat:'hours',check:()=>_totalHrs()>=25},
      { id:'hours_50',icon:'üéØ',name:'Focused',desc:'50 total hours',tier:'silver',cat:'hours',check:()=>_totalHrs()>=50},
      { id:'hours_100',icon:'üèÜ',name:'Centurion',desc:'100 total hours',tier:'silver',cat:'hours',check:()=>_totalHrs()>=100},
      { id:'hours_200',icon:'üí™',name:'Grinder',desc:'200 total hours',tier:'gold',cat:'hours',check:()=>_totalHrs()>=200},
      { id:'hours_300',icon:'üî¨',name:'Scientist',desc:'300 total hours',tier:'gold',cat:'hours',check:()=>_totalHrs()>=300},
      { id:'hours_500',icon:'üë®‚Äçüî¨',name:'Elite Scholar',desc:'500 total hours',tier:'platinum',cat:'hours',check:()=>_totalHrs()>=500},
      { id:'hours_8_day',icon:'üåô',name:'Marathon Day',desc:'8+ hours in a single day',tier:'silver',cat:'hours',check:()=>Object.values(_hrsByDay()).some(h=>h>=8)},
      { id:'hours_goal_7',icon:'üéØ',name:'Goal Crusher',desc:'Hit daily goal 7 days in a row',tier:'gold',cat:'hours',check:()=>{const bd=_hrsByDay();const dates=Object.keys(bd).sort();let c=0;for(let i=0;i<dates.length;i++){if(bd[dates[i]]>=state.dailyGoal){c++;if(c>=7)return true;}else c=0;}return false;}},
      // Scores (9)
      { id:'first_test',icon:'üìù',name:'Test Taker',desc:'First practice test',tier:'bronze',cat:'scores',check:()=>state.tests.length>=1},
      { id:'tests_3',icon:'üìä',name:'Data Driven',desc:'3 practice tests',tier:'silver',cat:'scores',check:()=>state.tests.length>=3},
      { id:'tests_5',icon:'üìà',name:'Test Veteran',desc:'5 practice tests',tier:'silver',cat:'scores',check:()=>state.tests.length>=5},
      { id:'tests_10',icon:'üóÇÔ∏è',name:'Test Master',desc:'10 practice tests',tier:'gold',cat:'scores',check:()=>state.tests.length>=10},
      { id:'score_500',icon:'‚úÖ',name:'Breaking 500',desc:'Score 500+',tier:'bronze',cat:'scores',check:()=>state.tests.some(t=>t.total>=500)},
      { id:'score_510',icon:'üìà',name:'Breaking 510',desc:'Score 510+',tier:'silver',cat:'scores',check:()=>state.tests.some(t=>t.total>=510)},
      { id:'score_520',icon:'üöÄ',name:'Elite',desc:'Score 520+',tier:'gold',cat:'scores',check:()=>state.tests.some(t=>t.total>=520)},
      { id:'score_528',icon:'üëë',name:'Perfect Score',desc:'Score 528',tier:'platinum',cat:'scores',check:()=>state.tests.some(t=>t.total>=528)},
      { id:'score_jump',icon:'üìä',name:'Big Jump',desc:'Improve 10+ pts between tests',tier:'gold',cat:'scores',check:()=>{for(let i=1;i<state.tests.length;i++){if(state.tests[i].total-state.tests[i-1].total>=10)return true;}return false;}},
      // Mastery (6)
      { id:'mastery_25',icon:'üå±',name:'Budding Scholar',desc:'25% overall mastery',tier:'bronze',cat:'mastery',check:()=>{const v=Object.values(state.mastery);return v.length&&v.reduce((a,b)=>a+b,0)/v.length>=25;}},
      { id:'mastery_50',icon:'üß†',name:'Half Way',desc:'50% overall mastery',tier:'silver',cat:'mastery',check:()=>{const v=Object.values(state.mastery);return v.length&&v.reduce((a,b)=>a+b,0)/v.length>=50;}},
      { id:'mastery_75',icon:'üéì',name:'Near Expert',desc:'75% overall mastery',tier:'gold',cat:'mastery',check:()=>{const v=Object.values(state.mastery);return v.length&&v.reduce((a,b)=>a+b,0)/v.length>=75;}},
      { id:'mastery_100',icon:'üëë',name:'Content King',desc:'100% all topics',tier:'platinum',cat:'mastery',check:()=>{const v=Object.values(state.mastery);return v.length&&v.every(x=>x===100);}},
      { id:'mastery_topic_50',icon:'üìö',name:'Knowledge Seeker',desc:'Master 50 individual topics',tier:'silver',cat:'mastery',check:()=>Object.values(state.mastery).filter(v=>v===100).length>=50},
      { id:'mastery_topic_100',icon:'üèÖ',name:'Topic Machine',desc:'Master 100 individual topics',tier:'gold',cat:'mastery',check:()=>Object.values(state.mastery).filter(v=>v===100).length>=100},
      // Resources (6)
      { id:'res_first',icon:'üì¶',name:'Getting Started',desc:'Add first resource',tier:'bronze',cat:'resources',check:()=>state.myResources.length>=1},
      { id:'res_5',icon:'üìö',name:'Well Equipped',desc:'Add 5 resources',tier:'silver',cat:'resources',check:()=>state.myResources.length>=5},
      { id:'res_book_done',icon:'üìñ',name:'Book Complete',desc:'Finish all chapters of a book',tier:'gold',cat:'resources',check:()=>state.myResources.filter(r=>r.type==='book').some(b=>b.chapters&&b.chapters.every(c=>c.done))},
      { id:'res_qbank_50',icon:'‚ùì',name:'Question Machine',desc:'50% of a QBank done',tier:'silver',cat:'resources',check:()=>state.myResources.filter(r=>r.type==='qbank').some(q=>(q.done||0)>=q.total*0.5)},
      { id:'res_qbank_100',icon:'üèÅ',name:'QBank Conquered',desc:'Finish an entire QBank',tier:'gold',cat:'resources',check:()=>state.myResources.filter(r=>r.type==='qbank').some(q=>(q.done||0)>=q.total)},
      { id:'res_anki_1000',icon:'üÉè',name:'Card Shark',desc:'1000+ mature Anki cards',tier:'gold',cat:'resources',check:()=>state.myResources.filter(r=>r.type==='anki').some(a=>(a.mature||0)>=1000)},
      // Special (7)
      { id:'night_owl',icon:'ü¶â',name:'Night Owl',desc:'Add "late night" in a session note',tier:'bronze',cat:'special',check:()=>state.logs.some(l=>l.notes&&l.notes.toLowerCase().includes('late night'))},
      { id:'all_categories',icon:'üåà',name:'Well Rounded',desc:'Log all 8 categories',tier:'silver',cat:'special',check:()=>new Set(state.logs.map(l=>l.category)).size>=8},
      { id:'pomodoro_10',icon:'üçÖ',name:'Pomodoro Pro',desc:'10 pomodoro sessions',tier:'silver',cat:'special',check:()=>(state.pomodoroSessionCount||0)>=10},
      { id:'pomodoro_50',icon:'üçÖ',name:'Pomodoro Master',desc:'50 pomodoro sessions',tier:'gold',cat:'special',check:()=>(state.pomodoroSessionCount||0)>=50},
      { id:'pomodoro_100',icon:'üçÖ',name:'Pomodoro Legend',desc:'100 pomodoro sessions',tier:'platinum',cat:'special',check:()=>(state.pomodoroSessionCount||0)>=100},
      { id:'level_5',icon:'‚≠ê',name:'Rising Star',desc:'Reach Level 5',tier:'silver',cat:'special',check:()=>getLevel().level>=5},
      { id:'level_10',icon:'üåü',name:'Double Digits',desc:'Reach Level 10',tier:'gold',cat:'special',check:()=>getLevel().level>=10},
      { id:'level_20',icon:'üëë',name:'Legend Status',desc:'Reach Level 20',tier:'platinum',cat:'special',check:()=>getLevel().level>=20}
    ];

    // ===== QUOTES (80+) =====
    const QUOTES = [
      // Motivation & Perseverance
      {text:"The MCAT is a marathon, not a sprint. Pace yourself.",author:"Every 520+ scorer",cat:"motivation"},
      {text:"You don't have to be great to start, but you have to start to be great.",author:"Zig Ziglar",cat:"motivation"},
      {text:"Success is the sum of small efforts repeated day in and day out.",author:"Robert Collier",cat:"motivation"},
      {text:"Discipline is choosing between what you want now and what you want most.",author:"Abraham Lincoln",cat:"motivation"},
      {text:"The pain you feel today will be the strength you feel tomorrow.",author:"Unknown",cat:"motivation"},
      {text:"Fall seven times, stand up eight.",author:"Japanese Proverb",cat:"motivation"},
      {text:"Don't watch the clock; do what it does. Keep going.",author:"Sam Levenson",cat:"motivation"},
      {text:"The expert in anything was once a beginner.",author:"Helen Hayes",cat:"motivation"},
      {text:"Hardships often prepare ordinary people for extraordinary destinies.",author:"C.S. Lewis",cat:"motivation"},
      {text:"It always seems impossible until it is done.",author:"Nelson Mandela",cat:"motivation"},
      {text:"What lies behind us and before us are tiny matters compared to what lies within us.",author:"Ralph Waldo Emerson",cat:"motivation"},
      {text:"Your only limit is your mind.",author:"Unknown",cat:"motivation"},
      {text:"Dream big. Start small. Act now.",author:"Robin Sharma",cat:"motivation"},
      {text:"One day or day one. You decide.",author:"Unknown",cat:"motivation"},
      {text:"Tough times never last, but tough people do.",author:"Robert Schuller",cat:"motivation"},
      {text:"Progress, not perfection.",author:"Unknown",cat:"motivation"},
      {text:"You are braver than you believe, stronger than you seem, and smarter than you think.",author:"A.A. Milne",cat:"motivation"},
      {text:"The struggle you are in today is developing the strength you need for tomorrow.",author:"Robert Tew",cat:"motivation"},
      {text:"Nothing worth having comes easy.",author:"Theodore Roosevelt",cat:"motivation"},
      {text:"Strength does not come from physical capacity. It comes from an indomitable will.",author:"Mahatma Gandhi",cat:"motivation"},
      // Medicine & Purpose
      {text:"Your future patients are counting on you.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Wherever the art of medicine is loved, there is also a love of humanity.",author:"Hippocrates",cat:"medicine"},
      {text:"The good physician treats the disease; the great physician treats the patient.",author:"William Osler",cat:"medicine"},
      {text:"Medicine is not only a science; it is also an art.",author:"Paracelsus",cat:"medicine"},
      {text:"To cure sometimes, to relieve often, to comfort always.",author:"Edward Trudeau",cat:"medicine"},
      {text:"Every patient you will treat is somebody's world.",author:"Unknown",cat:"medicine"},
      {text:"The best way to find yourself is to lose yourself in the service of others.",author:"Mahatma Gandhi",cat:"medicine"},
      {text:"Science knows no country because knowledge belongs to humanity.",author:"Louis Pasteur",cat:"medicine"},
      {text:"Remember why you started this journey.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Every hour of studying brings you closer to your white coat.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Think about the lives you will change.",author:"MCAT Motivation",cat:"medicine"},
      {text:"You are not just studying for a test. You are studying to save lives.",author:"MCAT Motivation",cat:"medicine"},
      {text:"One person can make a difference, and everyone should try.",author:"John F. Kennedy",cat:"medicine"},
      {text:"The human body is the best picture of the human soul.",author:"Ludwig Wittgenstein",cat:"medicine"},
      // Study Strategy
      {text:"It does not matter how slowly you go as long as you do not stop.",author:"Confucius",cat:"strategy"},
      {text:"The secret of getting ahead is getting started.",author:"Mark Twain",cat:"strategy"},
      {text:"Review is the mother of learning.",author:"Russian Proverb",cat:"strategy"},
      {text:"Spaced repetition beats cramming every single time.",author:"Cognitive Science",cat:"strategy"},
      {text:"Active recall is the single most effective study strategy.",author:"Learning Research",cat:"strategy"},
      {text:"Understanding beats memorization. Always ask why.",author:"MCAT Strategy",cat:"strategy"},
      {text:"Practice does not make perfect. Perfect practice makes perfect.",author:"Vince Lombardi",cat:"strategy"},
      {text:"The best time to review is right before you forget.",author:"Spaced Repetition",cat:"strategy"},
      {text:"Teach someone else and you will truly understand the material.",author:"Feynman Technique",cat:"strategy"},
      {text:"Mistakes are proof that you are trying.",author:"Unknown",cat:"strategy"},
      {text:"Practice until you cannot get it wrong.",author:"Unknown",cat:"strategy"},
      {text:"Study without desire spoils the memory.",author:"Leonardo da Vinci",cat:"strategy"},
      {text:"The more you practice, the luckier you get.",author:"Gary Player",cat:"strategy"},
      {text:"An investment in knowledge pays the best interest.",author:"Benjamin Franklin",cat:"strategy"},
      {text:"Learning is not attained by chance, it must be sought with ardor.",author:"Abigail Adams",cat:"strategy"},
      // MCAT-Specific
      {text:"CARS is a skill, not knowledge. Practice every single day.",author:"MCAT Advice",cat:"mcat"},
      {text:"The AAMC material is gold. Save it, but do not skip it.",author:"MCAT Advice",cat:"mcat"},
      {text:"A 520 is not about being smarter. It is about being more prepared.",author:"MCAT Advice",cat:"mcat"},
      {text:"Review every practice test thoroughly. The review is worth more than the test.",author:"MCAT Advice",cat:"mcat"},
      {text:"Focus on weaknesses. 50% to 75% is easier than 90% to 95%.",author:"MCAT Strategy",cat:"mcat"},
      {text:"Burnout is real. Rest days are productive days.",author:"MCAT Advice",cat:"mcat"},
      {text:"Trust the process. Scores improve in waves, not lines.",author:"MCAT Advice",cat:"mcat"},
      {text:"The MCAT tests reasoning, not recall. Think like a scientist.",author:"MCAT Advice",cat:"mcat"},
      {text:"Every wrong answer is a learning opportunity. Cherish it.",author:"MCAT Advice",cat:"mcat"},
      {text:"Your FL scores do not define you. They guide you.",author:"MCAT Advice",cat:"mcat"},
      {text:"Consistency beats intensity. Two hours daily beats twelve on Saturday.",author:"MCAT Advice",cat:"mcat"},
      {text:"Do Anki every day. No exceptions. No excuses.",author:"Every 520+ Scorer",cat:"mcat"},
      {text:"The test is beatable. Thousands beat it every year. You will too.",author:"MCAT Motivation",cat:"mcat"},
      {text:"Section Bank humbles everyone. Let it make you better.",author:"MCAT Advice",cat:"mcat"},
      {text:"P/S is the most improvable section. Anki is your best friend here.",author:"MCAT Advice",cat:"mcat"},
      // Resilience & Focus
      {text:"Believe you can and you're halfway there.",author:"Theodore Roosevelt",cat:"resilience"},
      {text:"The future belongs to those who believe in the beauty of their dreams.",author:"Eleanor Roosevelt",cat:"resilience"},
      {text:"The only way to do great work is to love what you do.",author:"Steve Jobs",cat:"resilience"},
      {text:"Our greatest glory is not in never falling, but in rising every time we fall.",author:"Confucius",cat:"resilience"},
      {text:"Energy and persistence conquer all things.",author:"Benjamin Franklin",cat:"resilience"},
      {text:"Action is the foundational key to all success.",author:"Pablo Picasso",cat:"resilience"},
      {text:"You miss 100% of the shots you do not take.",author:"Wayne Gretzky",cat:"resilience"},
      {text:"With self-discipline, most anything is possible.",author:"Theodore Roosevelt",cat:"resilience"},
      {text:"If you get tired, learn to rest, not to quit.",author:"Banksy",cat:"resilience"},
      {text:"Start where you are. Use what you have. Do what you can.",author:"Arthur Ashe",cat:"resilience"},
      {text:"Courage is not the absence of fear, but acting in spite of it.",author:"Mark Twain",cat:"resilience"},
      {text:"The only impossible journey is the one you never begin.",author:"Tony Robbins",cat:"resilience"},
      {text:"Do something today that your future self will thank you for.",author:"Sean Patrick Flanery",cat:"resilience"},
      {text:"Be so good they cannot ignore you.",author:"Steve Martin",cat:"resilience"},
      {text:"What we achieve inwardly will change outer reality.",author:"Plutarch",cat:"resilience"},
      {text:"The difference between who you are and who you want to be is what you do.",author:"Unknown",cat:"resilience"},
      {text:"It is not because things are difficult that we do not dare; it is because we do not dare that they are difficult.",author:"Seneca",cat:"resilience"},
      {text:"Success is not final, failure is not fatal: it is the courage to continue that counts.",author:"Winston Churchill",cat:"resilience"},
      {text:"The best preparation for tomorrow is doing your best today.",author:"H. Jackson Brown Jr.",cat:"resilience"},
      // MCAT-Specific (Extended)
      {text:"C/P is about problem-solving, not memorization. Practice dimensional analysis daily.",author:"MCAT Strategy",cat:"mcat"},
      {text:"Amino acids are the backbone of B/B. Know them cold: structure, charge at pH 7, and properties.",author:"MCAT Advice",cat:"mcat"},
      {text:"CARS is about understanding the author, not the science. Read for tone and argument structure.",author:"MCAT Strategy",cat:"mcat"},
      {text:"P/S: Know your 300-page KA document. It covers 80% of what you will see on test day.",author:"Every 520+ Scorer",cat:"mcat"},
      {text:"Do not skip the AAMC QPacks. They teach you how AAMC thinks, which is half the battle.",author:"MCAT Advice",cat:"mcat"},
      {text:"For C/P, master unit conversions and electrochemistry. They show up every single test.",author:"MCAT Strategy",cat:"mcat"},
      {text:"The experimental passages are not there to trick you. They test whether you can reason through new data.",author:"MCAT Advice",cat:"mcat"},
      {text:"If you are scoring 125 in CARS, you can get to 128 with daily timed practice. It is a trainable skill.",author:"MCAT Strategy",cat:"mcat"},
      {text:"B/B tip: understand metabolic pathways as stories, not isolated reactions.",author:"MCAT Advice",cat:"mcat"},
      {text:"On test day, flag and move on. Do not let one hard question steal time from three easy ones.",author:"MCAT Strategy",cat:"mcat"},
      {text:"The Section Bank is the closest thing to real MCAT difficulty. Review every question thoroughly.",author:"MCAT Advice",cat:"mcat"},
      {text:"Do not compare your FL timeline to Reddit posts. Everyone has a different starting point.",author:"MCAT Advice",cat:"mcat"},
      {text:"Physics on the MCAT is conceptual. You rarely need complex calculations.",author:"MCAT Strategy",cat:"mcat"},
      {text:"Take your last FL at least one week before test day. Use that week for light review and rest.",author:"MCAT Advice",cat:"mcat"},
      {text:"Sociology theories on P/S are free points if you spend a weekend memorizing them.",author:"MCAT Strategy",cat:"mcat"},
      {text:"Orgo on the MCAT is functional groups, reactions, and lab techniques. Not synthesis routes.",author:"MCAT Strategy",cat:"mcat"},
      {text:"The biggest predictor of a high score is consistently showing up. Not cramming, not luck.",author:"MCAT Advice",cat:"mcat"},
      {text:"When reviewing FLs, spend twice as long on the ones you got right by guessing.",author:"MCAT Strategy",cat:"mcat"},
      {text:"Biochem enzymes: know Michaelis-Menten, Lineweaver-Burk, and inhibitor types inside and out.",author:"MCAT Advice",cat:"mcat"},
      {text:"Sleep is a study tool. Eight hours the night before is worth more than two extra hours of cramming.",author:"MCAT Advice",cat:"mcat"},
      // Study Strategy (Extended)
      {text:"The Pomodoro Technique works because focus is a muscle. Train it in intervals.",author:"Productivity Research",cat:"strategy"},
      {text:"After every study session, write down three things you learned. Retrieval is learning.",author:"Learning Science",cat:"strategy"},
      {text:"Interleaving topics is harder in the moment but produces stronger long-term recall.",author:"Cognitive Psychology",cat:"strategy"},
      {text:"Do not reread. Close the book and try to recall. That struggle is where learning happens.",author:"Make It Stick",cat:"strategy"},
      {text:"Create your own mnemonics. The weirder they are, the better they stick.",author:"Memory Research",cat:"strategy"},
      {text:"Study the hardest material when your energy is highest. Save easy review for low-energy times.",author:"Study Strategy",cat:"strategy"},
      {text:"Explain it to a five-year-old. If you cannot simplify it, you do not understand it yet.",author:"Feynman Technique",cat:"strategy"},
      {text:"Track your errors by topic. Patterns reveal exactly where to focus next.",author:"MCAT Strategy",cat:"strategy"},
      {text:"Mix up your study locations. Environmental variation strengthens memory encoding.",author:"Cognitive Science",cat:"strategy"},
      {text:"After a full-length, take a day off. Then spend two days reviewing it. That ratio matters.",author:"MCAT Strategy",cat:"strategy"},
      {text:"Diminishing returns are real. Six focused hours beat ten distracted ones.",author:"Study Research",cat:"strategy"},
      {text:"Use practice questions as a learning tool, not just an assessment tool.",author:"Active Learning",cat:"strategy"},
      // Motivation (Extended)
      {text:"A year from now you will wish you had started today.",author:"Karen Lamb",cat:"motivation"},
      {text:"You are one decision away from a totally different life.",author:"Mark Batterson",cat:"motivation"},
      {text:"The comeback is always stronger than the setback.",author:"Unknown",cat:"motivation"},
      {text:"Motivation gets you started. Habit keeps you going.",author:"Jim Ryun",cat:"motivation"},
      {text:"The distance between your dreams and reality is called discipline.",author:"Unknown",cat:"motivation"},
      {text:"Work hard in silence. Let your score speak.",author:"Unknown",cat:"motivation"},
      {text:"Nobody is coming to save you. Get up and be your own hero.",author:"Unknown",cat:"motivation"},
      {text:"You already have the answer. You just need to quiet your mind enough to find it.",author:"Unknown",cat:"motivation"},
      {text:"The grind you are going through today is building the life you want tomorrow.",author:"Unknown",cat:"motivation"},
      {text:"Champions are made when nobody is watching.",author:"Unknown",cat:"motivation"},
      // Medicine & Purpose (Extended)
      {text:"The art of medicine consists in amusing the patient while nature cures the disease.",author:"Voltaire",cat:"medicine"},
      {text:"In nothing do men more nearly approach the gods than in giving health to men.",author:"Cicero",cat:"medicine"},
      {text:"The MCAT is the door. Medicine is the house. Keep your eyes on the house.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Somewhere, a patient is waiting for the doctor you will become.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Medicine is a science of uncertainty and an art of probability.",author:"William Osler",cat:"medicine"},
      {text:"You chose this path for a reason. On hard days, remember that reason.",author:"MCAT Motivation",cat:"medicine"},
      {text:"The physician should not treat the disease but the patient who is suffering from it.",author:"Maimonides",cat:"medicine"},
      {text:"Every great doctor was once a student who refused to give up.",author:"MCAT Motivation",cat:"medicine"},
      {text:"Healing is a matter of time, but it is sometimes also a matter of opportunity.",author:"Hippocrates",cat:"medicine"},
      {text:"Let your compassion for others fuel your discipline for yourself.",author:"MCAT Motivation",cat:"medicine"}
    ];

    const getSmartQuote = (context = 'general') => {
      let pool = QUOTES;
      if (context === 'timer' || context === 'focus') {
        pool = QUOTES.filter(q => q.cat === 'strategy' || q.cat === 'resilience' || q.cat === 'motivation');
      } else if (context === 'mcat' || context === 'content') {
        pool = QUOTES.filter(q => q.cat === 'mcat' || q.cat === 'strategy');
      } else if (context === 'strategy' || context === 'study') {
        pool = QUOTES.filter(q => q.cat === 'strategy' || q.cat === 'mcat');
      } else if (context === 'medicine') {
        pool = QUOTES.filter(q => q.cat === 'medicine' || q.cat === 'motivation');
      }
      const shown = JSON.parse(localStorage.getItem('mcat-last-quotes') || '[]');
      const filtered = pool.filter((q, i) => !shown.includes(QUOTES.indexOf(q)));
      const pick = filtered.length > 3 ? filtered : pool;
      const chosen = pick[Math.floor(Math.random() * pick.length)];
      const gIdx = QUOTES.indexOf(chosen);
      shown.push(gIdx);
      if (shown.length > 40) shown.splice(0, shown.length - 40);
      localStorage.setItem('mcat-last-quotes', JSON.stringify(shown));
      return chosen;
    };

    const getLevel = () => {
      for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (state.xp >= LEVELS[i].xp) return LEVELS[i];
      }
      return LEVELS[0];
    };

    const getNextLevel = () => {
      const curr = getLevel();
      return LEVELS.find(l => l.level === curr.level + 1) || curr;
    };

    const addXP = (amount, reason) => {
      const prevLevel = getLevel();
      state.xp += amount;
      localStorage.setItem('mcat-xp', state.xp);
      showToast(`+${amount} XP: ${reason}`);
      const newLevel = getLevel();
      if (newLevel.level > prevLevel.level) {
        triggerConfetti();
        setTimeout(() => showToast(`üéâ Level Up! ${newLevel.icon} ${newLevel.title} (Level ${newLevel.level})!`), 600);
      }
      checkAchievements();
    };

    const checkAchievements = () => {
      ACHIEVEMENTS.forEach(a => {
        if (!state.achievements[a.id] && a.check()) {
          state.achievements[a.id] = Date.now();
          localStorage.setItem('mcat-achievements', JSON.stringify(state.achievements));
          triggerConfetti();
          setTimeout(() => showToast(`üèÜ Achievement Unlocked: ${a.name}!`), 500);
          addXP(75, 'Achievement unlocked');
        }
      });
    };

    // ===== CONFETTI =====
    function triggerConfetti() {
      triggerConfettiV2();
    }

    // ===== PARTICLES =====
    function initParticles() {
      const container = document.getElementById('particles');
      const colors = ['var(--focus)', 'var(--wisdom)', 'var(--growth)', 'var(--energy)'];
      for (let i = 0; i < 30; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.top = Math.random() * 100 + '%';
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.animationDelay = Math.random() * 20 + 's';
        p.style.animationDuration = (15 + Math.random() * 20) + 's';
        container.appendChild(p);
      }
    }

    // ===== ANIMATED COUNTER (Odometer-style) =====
    function animateCounter(element, target, duration = 1000) {
      const start = parseInt(element.textContent) || 0;
      if (start === target) return;
      const startTime = performance.now();
      const ease = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
      const step = (now) => {
        const elapsed = Math.min((now - startTime) / duration, 1);
        const val = Math.round(start + (target - start) * ease(elapsed));
        element.textContent = val;
        if (elapsed < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    // ===== SCROLL REVEAL OBSERVER =====
    let revealObserver = null;
    function initScrollReveal() {
      if (revealObserver) revealObserver.disconnect();
      const mainEl = document.getElementById('main');
      if (!mainEl) return;
      revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            revealObserver.unobserve(entry.target);
          }
        });
      }, { root: mainEl, threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
      mainEl.querySelectorAll('.reveal, .reveal-left, .reveal-scale').forEach(el => {
        revealObserver.observe(el);
      });
    }

    // ===== BUTTON RIPPLE =====
    function initRipples() {
      document.querySelectorAll('.btn-ripple, .btn-primary, .btn-secondary').forEach(btn => {
        if (btn.dataset.rippleInit) return;
        btn.dataset.rippleInit = '1';
        btn.style.position = 'relative';
        btn.style.overflow = 'hidden';
        btn.addEventListener('click', function(e) {
          const rect = this.getBoundingClientRect();
          const ripple = document.createElement('span');
          ripple.className = 'ripple';
          const size = Math.max(rect.width, rect.height);
          ripple.style.width = ripple.style.height = size + 'px';
          ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
          ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
          this.appendChild(ripple);
          setTimeout(() => ripple.remove(), 500);
        });
      });
    }

    // ===== CURSOR GLOW TRACKER =====
    function initCursorGlow() {
      document.querySelectorAll('.card, .glow-card').forEach(card => {
        if (card.dataset.glowInit) return;
        card.dataset.glowInit = '1';
        card.addEventListener('mousemove', e => {
          const rect = card.getBoundingClientRect();
          card.style.setProperty('--glow-x', (e.clientX - rect.left) + 'px');
          card.style.setProperty('--glow-y', (e.clientY - rect.top) + 'px');
          card.style.setProperty('--mouse-x', (e.clientX - rect.left) + 'px');
          card.style.setProperty('--mouse-y', (e.clientY - rect.top) + 'px');
        });
      });
    }

    // ===== MAGNETIC BUTTONS =====
    function initMagneticButtons() {
      document.querySelectorAll('.btn-primary, .magnetic-btn').forEach(btn => {
        if (btn.dataset.magnetInit) return;
        btn.dataset.magnetInit = '1';
        btn.addEventListener('mousemove', e => {
          const rect = btn.getBoundingClientRect();
          const x = e.clientX - rect.left - rect.width / 2;
          const y = e.clientY - rect.top - rect.height / 2;
          btn.style.transform = `translate(${x * 0.15}px, ${y * 0.15}px)`;
        });
        btn.addEventListener('mouseleave', () => {
          btn.style.transform = '';
        });
      });
    }

    // ===== ENHANCED CONFETTI V2 =====
    function triggerConfettiV2() {
      const container = document.getElementById('confetti-container');
      const colors = ['#0891B2', '#22D3EE', '#06B6D4', '#60a5fa', '#4ade80', '#67e8f9', '#f59e0b', '#a78bfa'];
      const shapes = ['50%', '2px', '0'];
      for (let i = 0; i < 80; i++) {
        const c = document.createElement('div');
        c.className = 'confetti-v2';
        c.style.left = (30 + Math.random() * 40) + '%';
        c.style.top = '-10px';
        c.style.setProperty('--confetti-color', colors[Math.floor(Math.random() * colors.length)]);
        c.style.setProperty('--confetti-size', (6 + Math.random() * 10) + 'px');
        c.style.setProperty('--confetti-dur', (2 + Math.random() * 2) + 's');
        c.style.setProperty('--confetti-delay', (Math.random() * 0.6) + 's');
        c.style.setProperty('--confetti-rot', (360 + Math.random() * 720) + 'deg');
        c.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)];
        container.appendChild(c);
        setTimeout(() => c.remove(), 5000);
      }
    }

    // ===== TAB TRANSITION =====
    function transitionTab(mainEl, callback) {
      mainEl.classList.add('tab-exit');
      setTimeout(() => {
        callback();
        mainEl.classList.remove('tab-exit');
        mainEl.classList.add('tab-enter');
        setTimeout(() => mainEl.classList.remove('tab-enter'), 350);
      }, 120);
    }

    // ===== PROGRESS RING ANIMATION =====
    function animateRings() {
      document.querySelectorAll('.progress-ring-circle').forEach(circle => {
        const circumference = 2 * Math.PI * 45;
        const target = parseFloat(circle.getAttribute('stroke-dashoffset'));
        circle.style.setProperty('--ring-circumference', circumference);
        circle.style.setProperty('--ring-target', target);
        circle.setAttribute('stroke-dashoffset', circumference);
        circle.classList.add('animate-ring');
      });
    }

    // ===== 3D TILT =====
    function initTilt() {
      document.querySelectorAll('.tilt-card').forEach(card => {
        card.addEventListener('mousemove', e => {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          const rotateX = (y - centerY) / 20;
          const rotateY = (centerX - x) / 20;
          card.style.setProperty('--rotateX', `${-rotateX}deg`);
          card.style.setProperty('--rotateY', `${rotateY}deg`);
        });
        card.addEventListener('mouseleave', () => {
          card.style.setProperty('--rotateX', '0deg');
          card.style.setProperty('--rotateY', '0deg');
        });
      });
    }

    // ===== AAMC CONTENT OUTLINE =====
    // Organized by Foundational Concepts and Content Categories
    const AAMC_OUTLINE = {
      'B/B': {
        name: 'Bio/Biochem',
        full: 'Biological & Biochemical Foundations of Living Systems',
        color: '#c084fc',
        concepts: {
          'FC1': {
            name: 'Foundational Concept 1',
            desc: 'Biomolecules have unique properties that determine structure/function of cells',
            weight: '55%',
            categories: {
              '1A': {
                name: 'Protein Structure & Function',
                topics: [
                  'Amino acid classification (acidic, basic, polar, nonpolar)',
                  'Amino acid absolute configuration (D/L, R/S)',
                  'Dipolar ions and isoelectric point',
                  'Peptide bond formation and hydrolysis',
                  'Primary protein structure',
                  'Secondary structure (Œ±-helix, Œ≤-sheet, turns)',
                  'Tertiary structure and folding',
                  'Quaternary structure and subunits',
                  'Denaturation and renaturation',
                  'Enzyme structure and active sites',
                  'Enzyme kinetics (Michaelis-Menten)',
                  'Cooperativity and allosteric regulation',
                  'Competitive vs non-competitive inhibition',
                  'Feedback regulation',
                  'Zymogens and proteolytic cleavage'
                ]
              },
              '1B': {
                name: 'Gene to Protein',
                topics: [
                  'Nucleotide structure (bases, sugars, phosphates)',
                  'DNA double helix and Watson-Crick base pairing',
                  'DNA replication (enzymes, Okazaki fragments)',
                  'DNA repair mechanisms',
                  'Transcription (initiation, elongation, termination)',
                  'mRNA processing (capping, polyadenylation, splicing)',
                  'Genetic code and codons',
                  'tRNA structure and aminoacylation',
                  'Ribosome structure and function',
                  'Translation (initiation, elongation, termination)',
                  'Post-translational modifications',
                  'Protein targeting and sorting'
                ]
              },
              '1C': {
                name: 'Heredity & Genetic Diversity',
                topics: [
                  'Mendelian genetics (dominance, segregation)',
                  'Independent assortment',
                  'Linkage and recombination',
                  'Sex-linked traits',
                  'Pedigree analysis',
                  'Hardy-Weinberg equilibrium',
                  'Types of mutations (point, frameshift, etc.)',
                  'Mutagens and carcinogens',
                  'Chromosomal abnormalities',
                  'Meiosis and genetic recombination',
                  'Gene pool and allele frequencies',
                  'Genetic drift and founder effect',
                  'Recombinant DNA and cloning',
                  'PCR and gel electrophoresis',
                  'Blotting techniques and DNA sequencing',
                  'CRISPR and gene editing'
                ]
              },
              '1D': {
                name: 'Bioenergetics & Metabolism',
                topics: [
                  'Thermodynamics (ŒîG, ŒîH, ŒîS)',
                  'ATP structure and hydrolysis',
                  'Phosphoryl transfer potential',
                  'Glycolysis (steps, enzymes, regulation)',
                  'Gluconeogenesis',
                  'Glycogen metabolism',
                  'Pentose phosphate pathway',
                  'Pyruvate dehydrogenase complex',
                  'Citric acid cycle (TCA/Krebs)',
                  'Electron transport chain complexes',
                  'Oxidative phosphorylation and ATP synthase',
                  'Chemiosmotic theory',
                  'Œ≤-oxidation of fatty acids',
                  'Ketone body metabolism',
                  'Amino acid catabolism',
                  'Metabolic regulation and integration'
                ]
              }
            }
          },
          'FC2': {
            name: 'Foundational Concept 2',
            desc: 'Highly organized assemblies of molecules, cells, and organs interact',
            weight: '20%',
            categories: {
              '2A': {
                name: 'Cell Assembly & Organization',
                topics: [
                  'Plasma membrane structure (fluid mosaic)',
                  'Membrane proteins and transport',
                  'Membrane potential and ion channels',
                  'Cell junctions (tight, gap, desmosomes)',
                  'Extracellular matrix',
                  'Cytoskeleton (microfilaments, microtubules, intermediate)',
                  'Cell motility and motor proteins'
                ]
              },
              '2B': {
                name: 'Cell Growth & Division',
                topics: [
                  'Cell cycle phases (G1, S, G2, M)',
                  'Cyclins and CDKs',
                  'Cell cycle checkpoints',
                  'Mitosis stages',
                  'Cytokinesis',
                  'Meiosis I and II',
                  'Apoptosis vs necrosis',
                  'Cancer and cell cycle dysregulation'
                ]
              },
              '2C': {
                name: 'Cellular Processes',
                topics: [
                  'Receptor-ligand binding',
                  'Signal transduction pathways',
                  'G-protein coupled receptors',
                  'Second messengers (cAMP, Ca2+, IP3)',
                  'Receptor tyrosine kinases',
                  'Enzyme-linked receptors',
                  'Endocytosis and exocytosis',
                  'Phagocytosis and pinocytosis'
                ]
              }
            }
          },
          'FC3': {
            name: 'Foundational Concept 3',
            desc: 'Organ systems interact to carry out functions of living organisms',
            weight: '25%',
            categories: {
              '3A': {
                name: 'Nervous & Endocrine Systems',
                topics: [
                  'Neuron structure and function',
                  'Resting membrane potential',
                  'Action potential generation',
                  'Saltatory conduction',
                  'Synaptic transmission',
                  'Neurotransmitters (acetylcholine, dopamine, etc.)',
                  'CNS organization (brain regions)',
                  'PNS (somatic and autonomic)',
                  'Sympathetic vs parasympathetic',
                  'Reflex arcs',
                  'Sensory receptors',
                  'Hypothalamus-pituitary axis',
                  'Anterior pituitary hormones',
                  'Posterior pituitary hormones',
                  'Thyroid and parathyroid',
                  'Adrenal glands (cortex and medulla)',
                  'Pancreatic hormones (insulin, glucagon)',
                  'Hormone mechanisms (steroid vs peptide)'
                ]
              },
              '3B': {
                name: 'Organ System Structure & Function',
                topics: [
                  'Heart structure and cardiac cycle',
                  'Blood pressure and circulation',
                  'Blood composition and clotting',
                  'Lymphatic system',
                  'Respiratory mechanics',
                  'Gas exchange and transport',
                  'Hemoglobin oxygen binding',
                  'Bohr effect and CO2 transport',
                  'Innate immunity',
                  'Adaptive immunity (B and T cells)',
                  'Antibody structure and function',
                  'MHC and antigen presentation',
                  'Digestive tract anatomy',
                  'Enzymes of digestion',
                  'Absorption of nutrients',
                  'Liver functions',
                  'Kidney structure (nephron)',
                  'Filtration, reabsorption, secretion',
                  'Osmoregulation and pH balance',
                  'Male and female reproductive systems',
                  'Gametogenesis',
                  'Fertilization and early development',
                  'Muscle types and contraction',
                  'Skeletal structure and bone remodeling',
                  'Skin structure and thermoregulation'
                ]
              }
            }
          }
        }
      },
      'C/P': {
        name: 'Chem/Phys',
        full: 'Chemical & Physical Foundations of Biological Systems',
        color: '#60a5fa',
        concepts: {
          'FC4': {
            name: 'Foundational Concept 4',
            desc: 'Physical principles underlying biological processes',
            weight: '40%',
            categories: {
              '4A': {
                name: 'Motion, Forces, Work, Energy',
                topics: [
                  'Translational motion (displacement, velocity, acceleration)',
                  'Vectors and scalars',
                  'Projectile motion',
                  'Newton\'s laws of motion',
                  'Friction (static and kinetic)',
                  'Inclined planes',
                  'Circular motion and centripetal force',
                  'Torque and rotational equilibrium',
                  'Work and power',
                  'Kinetic and potential energy',
                  'Conservation of energy',
                  'Momentum and impulse',
                  'Elastic vs inelastic collisions',
                  'Center of mass'
                ]
              },
              '4B': {
                name: 'Fluids & Gas Phase',
                topics: [
                  'Density and specific gravity',
                  'Hydrostatic pressure',
                  'Pascal\'s principle',
                  'Archimedes\' principle and buoyancy',
                  'Fluid dynamics (continuity equation)',
                  'Bernoulli\'s equation',
                  'Viscosity and Poiseuille\'s law',
                  'Surface tension',
                  'Capillary action',
                  'Ideal gas law (PV=nRT)',
                  'Kinetic molecular theory',
                  'Dalton\'s law of partial pressures',
                  'Graham\'s law of effusion'
                ]
              },
              '4C': {
                name: 'Electrochemistry & Circuits',
                topics: [
                  'Electrolytic cells',
                  'Galvanic/voltaic cells',
                  'Standard electrode potentials',
                  'Cell potential and Nernst equation',
                  'Faraday\'s law',
                  'Electric charge and Coulomb\'s law',
                  'Electric field and potential',
                  'Current and resistance (Ohm\'s law)',
                  'Resistors in series and parallel',
                  'Capacitors and dielectrics',
                  'Power in circuits',
                  'Kirchhoff\'s laws',
                  'RC circuits'
                ]
              },
              '4D': {
                name: 'Light & Sound',
                topics: [
                  'Sound waves and characteristics',
                  'Doppler effect',
                  'Resonance and standing waves',
                  'Electromagnetic spectrum',
                  'Reflection and refraction',
                  'Snell\'s law and total internal reflection',
                  'Mirrors (plane, concave, convex)',
                  'Thin lenses and ray diagrams',
                  'Lens/mirror equation',
                  'Magnification',
                  'Diffraction and interference',
                  'Polarization',
                  'Photoelectric effect'
                ]
              },
              '4E': {
                name: 'Atomic & Nuclear Structure',
                topics: [
                  'Atomic number and mass number',
                  'Isotopes',
                  'Nuclear forces',
                  'Radioactive decay (Œ±, Œ≤, Œ≥)',
                  'Half-life calculations',
                  'Mass-energy equivalence',
                  'Fission and fusion',
                  'Electron configuration',
                  'Quantum numbers',
                  'Periodic trends',
                  'Effective nuclear charge'
                ]
              }
            }
          },
          'FC5': {
            name: 'Foundational Concept 5',
            desc: 'Chemical interactions and reactions underlying molecular dynamics',
            weight: '60%',
            categories: {
              '5A': {
                name: 'Water & Solutions',
                topics: [
                  'Hydrogen bonding in water',
                  'Solubility and dissolution',
                  'Colligative properties',
                  'Osmotic pressure',
                  'Acid-base definitions (Arrhenius, Br√∏nsted-Lowry, Lewis)',
                  'pH and pOH calculations',
                  'Strong vs weak acids/bases',
                  'Ka, Kb, and pKa',
                  'Buffers and Henderson-Hasselbalch',
                  'Titration curves',
                  'Indicators'
                ]
              },
              '5B': {
                name: 'Molecular Structure & Interactions',
                topics: [
                  'Lewis structures and formal charge',
                  'Resonance structures',
                  'VSEPR theory and molecular geometry',
                  'Hybridization (sp, sp2, sp3)',
                  'Sigma and pi bonds',
                  'Bond polarity and dipole moment',
                  'Intermolecular forces (London, dipole-dipole, H-bonding)',
                  'Covalent vs ionic bonds',
                  'Metallic bonding'
                ]
              },
              '5C': {
                name: 'Separation & Purification',
                topics: [
                  'Extraction and partitioning',
                  'Distillation',
                  'Recrystallization',
                  'Chromatography (paper, TLC, column, HPLC, GC)',
                  'Electrophoresis (gel, SDS-PAGE)',
                  'Centrifugation',
                  'Filtration'
                ]
              },
              '5D': {
                name: 'Organic Structure & Reactivity',
                topics: [
                  'Nomenclature (IUPAC)',
                  'Functional groups',
                  'Stereochemistry (R/S, E/Z)',
                  'Conformational isomers',
                  'Chirality and optical activity',
                  'Nucleophiles and electrophiles',
                  'SN1 and SN2 reactions',
                  'E1 and E2 elimination',
                  'Addition reactions (alkenes)',
                  'Carbonyl chemistry (aldehydes, ketones)',
                  'Carboxylic acids and derivatives',
                  'Amines and amides',
                  'Aromatic chemistry',
                  'Free radical reactions',
                  'Oxidation-reduction in organic chemistry'
                ]
              },
              '5E': {
                name: 'Thermodynamics & Kinetics',
                topics: [
                  'Enthalpy and Hess\'s law',
                  'Entropy and spontaneity',
                  'Gibbs free energy',
                  'Reaction rates',
                  'Rate laws and order',
                  'Activation energy',
                  'Arrhenius equation',
                  'Catalysis',
                  'Equilibrium constants (Keq)',
                  'Le Chatelier\'s principle',
                  'Relationship between ŒîG and Keq'
                ]
              }
            }
          }
        }
      },
      'P/S': {
        name: 'Psych/Soc',
        full: 'Psychological, Social, & Biological Foundations of Behavior',
        color: '#fbbf24',
        concepts: {
          'FC6': {
            name: 'Foundational Concept 6',
            desc: 'Sensing, perceiving, and reacting to the world',
            weight: '25%',
            categories: {
              '6A': {
                name: 'Sensation & Perception',
                topics: [
                  'Sensory processing and thresholds',
                  'Signal detection theory',
                  'Weber\'s law',
                  'Sensory adaptation',
                  'Vision (eye structure, phototransduction)',
                  'Visual processing pathways',
                  'Hearing (ear structure, sound transduction)',
                  'Auditory processing',
                  'Other senses (taste, smell, touch, pain)',
                  'Vestibular sense',
                  'Proprioception',
                  'Gestalt principles',
                  'Bottom-up vs top-down processing',
                  'Perceptual organization'
                ]
              },
              '6B': {
                name: 'Cognition, Consciousness, Memory',
                topics: [
                  'Attention (selective, divided)',
                  'States of consciousness',
                  'Sleep stages and disorders',
                  'Hypnosis and meditation',
                  'Drug effects on consciousness',
                  'Memory encoding',
                  'Memory storage (sensory, STM, LTM)',
                  'Memory retrieval',
                  'Types of memory (explicit, implicit)',
                  'Forgetting (decay, interference)',
                  'Memory disorders',
                  'Language acquisition',
                  'Language areas of brain',
                  'Problem solving strategies',
                  'Decision making and biases',
                  'Intellectual functioning (IQ)'
                ]
              }
            }
          },
          'FC7': {
            name: 'Foundational Concept 7',
            desc: 'Biological and sociocultural factors that influence behavior',
            weight: '35%',
            categories: {
              '7A': {
                name: 'Individual Behavior',
                topics: [
                  'Biological bases of behavior',
                  'Nervous system organization',
                  'Neuroplasticity',
                  'Genetics and behavior',
                  'Influence of environment on gene expression',
                  'Drive reduction theory',
                  'Arousal theory',
                  'Instincts and needs',
                  'Maslow\'s hierarchy',
                  'Incentive theory'
                ]
              },
              '7B': {
                name: 'Learning & Behavior Change',
                topics: [
                  'Classical conditioning',
                  'Operant conditioning',
                  'Reinforcement schedules',
                  'Punishment',
                  'Extinction and spontaneous recovery',
                  'Cognitive learning',
                  'Observational learning',
                  'Biological constraints on learning',
                  'Habituation and sensitization',
                  'Attitudes and behavior',
                  'Elaboration likelihood model',
                  'Cognitive dissonance',
                  'Theories of attitude change'
                ]
              },
              '7C': {
                name: 'Stress, Emotion, Personality',
                topics: [
                  'Three-component model of emotion',
                  'Universal emotions',
                  'Adaptive role of emotions',
                  'Theories of emotion (James-Lange, Cannon-Bard, Schachter-Singer)',
                  'Stress response (HPA axis)',
                  'General adaptation syndrome',
                  'Coping strategies',
                  'Psychosomatic disorders',
                  'Psychoanalytic theory (Freud)',
                  'Humanistic theory (Rogers, Maslow)',
                  'Trait theory (Big Five)',
                  'Social cognitive theory',
                  'Biological basis of personality',
                  'Situational influences on personality'
                ]
              }
            }
          },
          'FC8': {
            name: 'Foundational Concept 8',
            desc: 'How we think about ourselves and others',
            weight: '20%',
            categories: {
              '8A': {
                name: 'Self-Concept & Identity',
                topics: [
                  'Self-concept and self-esteem',
                  'Self-efficacy',
                  'Locus of control',
                  'Identity formation',
                  'Social identity',
                  'Gender identity and roles',
                  'Ethnic identity',
                  'Erikson\'s stages of psychosocial development'
                ]
              },
              '8B': {
                name: 'Social Perception & Interaction',
                topics: [
                  'Attribution theory',
                  'Fundamental attribution error',
                  'Self-serving bias',
                  'Actor-observer bias',
                  'Stereotype formation',
                  'Prejudice and discrimination',
                  'In-group/out-group bias',
                  'Self-fulfilling prophecy',
                  'Impression management'
                ]
              },
              '8C': {
                name: 'Social Behavior',
                topics: [
                  'Attraction and relationships',
                  'Aggression',
                  'Altruism and prosocial behavior',
                  'Conformity (Asch)',
                  'Obedience (Milgram)',
                  'Group dynamics',
                  'Social facilitation and loafing',
                  'Groupthink',
                  'Deindividuation',
                  'Bystander effect'
                ]
              }
            }
          },
          'FC9': {
            name: 'Foundational Concept 9',
            desc: 'Cultural and social factors influencing well-being',
            weight: '15%',
            categories: {
              '9A': {
                name: 'Social Structure',
                topics: [
                  'Theoretical approaches (functionalism, conflict theory, symbolic interactionism)',
                  'Social institutions (family, education, religion, government, economy)',
                  'Culture and socialization',
                  'Agents of socialization',
                  'Norms, values, beliefs',
                  'Social roles and status',
                  'Role conflict and strain',
                  'Groups (primary, secondary, reference)',
                  'Networks and organizations',
                  'Bureaucracy'
                ]
              },
              '9B': {
                name: 'Demographics & Society',
                topics: [
                  'Demographic structure',
                  'Population dynamics',
                  'Fertility and mortality rates',
                  'Migration',
                  'Urbanization',
                  'Globalization',
                  'Social movements',
                  'Collective behavior'
                ]
              }
            }
          },
          'FC10': {
            name: 'Foundational Concept 10',
            desc: 'Social stratification and access to resources',
            weight: '10%',
            categories: {
              '10A': {
                name: 'Social Inequality',
                topics: [
                  'Social class and socioeconomic status',
                  'Theories of stratification',
                  'Social mobility',
                  'Poverty (absolute, relative)',
                  'Spatial inequality',
                  'Global inequality',
                  'Racial and ethnic inequality',
                  'Gender inequality',
                  'Age inequality',
                  'Disability and inequality'
                ]
              },
              '10B': {
                name: 'Healthcare Disparities',
                topics: [
                  'Social determinants of health',
                  'Health disparities by race/ethnicity',
                  'Health disparities by SES',
                  'Healthcare access and utilization',
                  'Health beliefs and behaviors',
                  'Illness experience',
                  'Medicalization',
                  'Sick role',
                  'Delivery of healthcare',
                  'Patient-provider relationships'
                ]
              }
            }
          }
        }
      },
      'CARS': {
        name: 'CARS',
        full: 'Critical Analysis & Reasoning Skills',
        color: '#4ade80',
        concepts: {
          'Skills': {
            name: 'CARS Skills',
            desc: 'Passage analysis and reasoning skills',
            weight: '100%',
            categories: {
              'Foundations': {
                name: 'Foundations of Comprehension',
                topics: [
                  'Identifying main idea and thesis',
                  'Understanding author\'s purpose',
                  'Identifying key terms and concepts',
                  'Paragraph structure and function',
                  'Passage organization',
                  'Understanding tone and voice',
                  'Recognizing rhetorical strategies'
                ]
              },
              'Reasoning': {
                name: 'Reasoning Within the Text',
                topics: [
                  'Drawing inferences',
                  'Identifying assumptions',
                  'Evaluating evidence',
                  'Understanding cause and effect',
                  'Recognizing logical relationships',
                  'Analyzing arguments',
                  'Identifying strengths and weaknesses'
                ]
              },
              'Beyond': {
                name: 'Reasoning Beyond the Text',
                topics: [
                  'Applying passage info to new contexts',
                  'Extrapolating from arguments',
                  'Predicting outcomes',
                  'Analogical reasoning',
                  'Strengthening/weakening arguments',
                  'Evaluating new information impact',
                  'Synthesizing multiple viewpoints'
                ]
              }
            }
          }
        }
      }
    };


    // ===== TOPIC YIELD CLASSIFICATION =====
    // 'h' = high yield, 'm' = medium yield, 'l' = low yield
    const TOPIC_YIELD = {
      // ===== B/B (Bio/Biochem) =====

      // 1A Protein Structure & Function
      'Amino acid classification (acidic, basic, polar, nonpolar)': 'h',
      'Amino acid absolute configuration (D/L, R/S)': 'l',
      'Dipolar ions and isoelectric point': 'h',
      'Peptide bond formation and hydrolysis': 'h',
      'Primary protein structure': 'm',
      'Secondary structure (Œ±-helix, Œ≤-sheet, turns)': 'h',
      'Tertiary structure and folding': 'h',
      'Quaternary structure and subunits': 'm',
      'Denaturation and renaturation': 'm',
      'Enzyme structure and active sites': 'h',
      'Enzyme kinetics (Michaelis-Menten)': 'h',
      'Cooperativity and allosteric regulation': 'h',
      'Competitive vs non-competitive inhibition': 'h',
      'Feedback regulation': 'm',
      'Zymogens and proteolytic cleavage': 'l',

      // 1B Gene to Protein
      'Nucleotide structure (bases, sugars, phosphates)': 'h',
      'DNA double helix and Watson-Crick base pairing': 'h',
      'DNA replication (enzymes, Okazaki fragments)': 'h',
      'DNA repair mechanisms': 'm',
      'Transcription (initiation, elongation, termination)': 'h',
      'mRNA processing (capping, polyadenylation, splicing)': 'h',
      'Genetic code and codons': 'h',
      'tRNA structure and aminoacylation': 'm',
      'Ribosome structure and function': 'm',
      'Translation (initiation, elongation, termination)': 'h',
      'Post-translational modifications': 'm',
      'Protein targeting and sorting': 'l',

      // 1C Heredity & Genetic Diversity
      'Mendelian genetics (dominance, segregation)': 'h',
      'Independent assortment': 'm',
      'Linkage and recombination': 'm',
      'Sex-linked traits': 'm',
      'Pedigree analysis': 'h',
      'Hardy-Weinberg equilibrium': 'h',
      'Types of mutations (point, frameshift, etc.)': 'h',
      'Mutagens and carcinogens': 'l',
      'Chromosomal abnormalities': 'l',
      'Meiosis and genetic recombination': 'h',
      'Gene pool and allele frequencies': 'm',
      'Genetic drift and founder effect': 'm',
      'Recombinant DNA and cloning': 'm',
      'PCR and gel electrophoresis': 'h',
      'Blotting techniques and DNA sequencing': 'm',
      'CRISPR and gene editing': 'l',

      // 1D Bioenergetics & Metabolism
      'Thermodynamics (ŒîG, ŒîH, ŒîS)': 'h',
      'ATP structure and hydrolysis': 'h',
      'Phosphoryl transfer potential': 'l',
      'Glycolysis (steps, enzymes, regulation)': 'h',
      'Gluconeogenesis': 'm',
      'Glycogen metabolism': 'm',
      'Pentose phosphate pathway': 'm',
      'Pyruvate dehydrogenase complex': 'm',
      'Citric acid cycle (TCA/Krebs)': 'h',
      'Electron transport chain complexes': 'h',
      'Oxidative phosphorylation and ATP synthase': 'h',
      'Chemiosmotic theory': 'm',
      'Œ≤-oxidation of fatty acids': 'm',
      'Ketone body metabolism': 'l',
      'Amino acid catabolism': 'l',
      'Metabolic regulation and integration': 'h',

      // 2A Cell Assembly & Organization
      'Plasma membrane structure (fluid mosaic)': 'h',
      'Membrane proteins and transport': 'h',
      'Membrane potential and ion channels': 'h',
      'Cell junctions (tight, gap, desmosomes)': 'm',
      'Extracellular matrix': 'l',
      'Cytoskeleton (microfilaments, microtubules, intermediate)': 'm',
      'Cell motility and motor proteins': 'l',

      // 2B Cell Growth & Division
      'Cell cycle phases (G1, S, G2, M)': 'h',
      'Cyclins and CDKs': 'm',
      'Cell cycle checkpoints': 'm',
      'Mitosis stages': 'h',
      'Cytokinesis': 'l',
      'Meiosis I and II': 'h',
      'Apoptosis vs necrosis': 'm',
      'Cancer and cell cycle dysregulation': 'm',

      // 2C Cellular Processes
      'Receptor-ligand binding': 'm',
      'Signal transduction pathways': 'h',
      'G-protein coupled receptors': 'h',
      'Second messengers (cAMP, Ca2+, IP3)': 'h',
      'Receptor tyrosine kinases': 'm',
      'Enzyme-linked receptors': 'l',
      'Endocytosis and exocytosis': 'm',
      'Phagocytosis and pinocytosis': 'l',

      // 3A Nervous & Endocrine Systems
      'Neuron structure and function': 'h',
      'Resting membrane potential': 'h',
      'Action potential generation': 'h',
      'Saltatory conduction': 'm',
      'Synaptic transmission': 'h',
      'Neurotransmitters (acetylcholine, dopamine, etc.)': 'h',
      'CNS organization (brain regions)': 'm',
      'PNS (somatic and autonomic)': 'm',
      'Sympathetic vs parasympathetic': 'h',
      'Reflex arcs': 'l',
      'Sensory receptors': 'm',
      'Hypothalamus-pituitary axis': 'h',
      'Anterior pituitary hormones': 'm',
      'Posterior pituitary hormones': 'm',
      'Thyroid and parathyroid': 'm',
      'Adrenal glands (cortex and medulla)': 'm',
      'Pancreatic hormones (insulin, glucagon)': 'h',
      'Hormone mechanisms (steroid vs peptide)': 'h',

      // 3B Organ System Structure & Function
      'Heart structure and cardiac cycle': 'h',
      'Blood pressure and circulation': 'h',
      'Blood composition and clotting': 'm',
      'Lymphatic system': 'l',
      'Respiratory mechanics': 'm',
      'Gas exchange and transport': 'h',
      'Hemoglobin oxygen binding': 'h',
      'Bohr effect and CO2 transport': 'h',
      'Innate immunity': 'm',
      'Adaptive immunity (B and T cells)': 'h',
      'Antibody structure and function': 'h',
      'MHC and antigen presentation': 'm',
      'Digestive tract anatomy': 'm',
      'Enzymes of digestion': 'h',
      'Absorption of nutrients': 'm',
      'Liver functions': 'm',
      'Kidney structure (nephron)': 'h',
      'Filtration, reabsorption, secretion': 'h',
      'Osmoregulation and pH balance': 'h',
      'Male and female reproductive systems': 'm',
      'Gametogenesis': 'm',
      'Fertilization and early development': 'l',
      'Muscle types and contraction': 'h',
      'Skeletal structure and bone remodeling': 'l',
      'Skin structure and thermoregulation': 'l',

      // ===== C/P (Chem/Phys) =====

      // 4A Motion, Forces, Work, Energy
      'Translational motion (displacement, velocity, acceleration)': 'h',
      'Vectors and scalars': 'm',
      'Projectile motion': 'm',
      'Newton\'s laws of motion': 'h',
      'Friction (static and kinetic)': 'm',
      'Inclined planes': 'm',
      'Circular motion and centripetal force': 'm',
      'Torque and rotational equilibrium': 'h',
      'Work and power': 'h',
      'Kinetic and potential energy': 'h',
      'Conservation of energy': 'h',
      'Momentum and impulse': 'm',
      'Elastic vs inelastic collisions': 'm',
      'Center of mass': 'l',

      // 4B Fluids & Gas Phase
      'Density and specific gravity': 'm',
      'Hydrostatic pressure': 'h',
      'Pascal\'s principle': 'm',
      'Archimedes\' principle and buoyancy': 'h',
      'Fluid dynamics (continuity equation)': 'h',
      'Bernoulli\'s equation': 'h',
      'Viscosity and Poiseuille\'s law': 'm',
      'Surface tension': 'l',
      'Capillary action': 'l',
      'Ideal gas law (PV=nRT)': 'h',
      'Kinetic molecular theory': 'm',
      'Dalton\'s law of partial pressures': 'm',
      'Graham\'s law of effusion': 'l',

      // 4C Electrochemistry & Circuits
      'Electrolytic cells': 'm',
      'Galvanic/voltaic cells': 'h',
      'Standard electrode potentials': 'h',
      'Cell potential and Nernst equation': 'm',
      'Faraday\'s law': 'l',
      'Electric charge and Coulomb\'s law': 'm',
      'Electric field and potential': 'm',
      'Current and resistance (Ohm\'s law)': 'h',
      'Resistors in series and parallel': 'h',
      'Capacitors and dielectrics': 'm',
      'Power in circuits': 'm',
      'Kirchhoff\'s laws': 'm',
      'RC circuits': 'l',

      // 4D Light & Sound
      'Sound waves and characteristics': 'm',
      'Doppler effect': 'm',
      'Resonance and standing waves': 'l',
      'Electromagnetic spectrum': 'm',
      'Reflection and refraction': 'h',
      'Snell\'s law and total internal reflection': 'h',
      'Mirrors (plane, concave, convex)': 'm',
      'Thin lenses and ray diagrams': 'h',
      'Lens/mirror equation': 'h',
      'Magnification': 'm',
      'Diffraction and interference': 'l',
      'Polarization': 'l',
      'Photoelectric effect': 'm',

      // 4E Atomic & Nuclear Structure
      'Atomic number and mass number': 'm',
      'Isotopes': 'm',
      'Nuclear forces': 'l',
      'Radioactive decay (Œ±, Œ≤, Œ≥)': 'm',
      'Half-life calculations': 'm',
      'Mass-energy equivalence': 'l',
      'Fission and fusion': 'l',
      'Electron configuration': 'h',
      'Quantum numbers': 'm',
      'Periodic trends': 'h',
      'Effective nuclear charge': 'm',

      // 5A Water & Solutions
      'Hydrogen bonding in water': 'h',
      'Solubility and dissolution': 'm',
      'Colligative properties': 'm',
      'Osmotic pressure': 'm',
      'Acid-base definitions (Arrhenius, Br√∏nsted-Lowry, Lewis)': 'h',
      'pH and pOH calculations': 'h',
      'Strong vs weak acids/bases': 'h',
      'Ka, Kb, and pKa': 'h',
      'Buffers and Henderson-Hasselbalch': 'h',
      'Titration curves': 'h',
      'Indicators': 'l',

      // 5B Molecular Structure & Interactions
      'Lewis structures and formal charge': 'h',
      'Resonance structures': 'h',
      'VSEPR theory and molecular geometry': 'h',
      'Hybridization (sp, sp2, sp3)': 'h',
      'Sigma and pi bonds': 'm',
      'Bond polarity and dipole moment': 'h',
      'Intermolecular forces (London, dipole-dipole, H-bonding)': 'h',
      'Covalent vs ionic bonds': 'm',
      'Metallic bonding': 'l',

      // 5C Separation & Purification
      'Extraction and partitioning': 'l',
      'Distillation': 'm',
      'Recrystallization': 'l',
      'Chromatography (paper, TLC, column, HPLC, GC)': 'h',
      'Electrophoresis (gel, SDS-PAGE)': 'h',
      'Centrifugation': 'm',
      'Filtration': 'l',

      // 5D Organic Structure & Reactivity
      'Nomenclature (IUPAC)': 'm',
      'Functional groups': 'h',
      'Stereochemistry (R/S, E/Z)': 'h',
      'Conformational isomers': 'm',
      'Chirality and optical activity': 'h',
      'Nucleophiles and electrophiles': 'h',
      'SN1 and SN2 reactions': 'h',
      'E1 and E2 elimination': 'h',
      'Addition reactions (alkenes)': 'm',
      'Carbonyl chemistry (aldehydes, ketones)': 'h',
      'Carboxylic acids and derivatives': 'h',
      'Amines and amides': 'm',
      'Aromatic chemistry': 'm',
      'Free radical reactions': 'l',
      'Oxidation-reduction in organic chemistry': 'm',

      // 5E Thermodynamics & Kinetics
      'Enthalpy and Hess\'s law': 'h',
      'Entropy and spontaneity': 'h',
      'Gibbs free energy': 'h',
      'Reaction rates': 'm',
      'Rate laws and order': 'h',
      'Activation energy': 'm',
      'Arrhenius equation': 'm',
      'Catalysis': 'm',
      'Equilibrium constants (Keq)': 'h',
      'Le Chatelier\'s principle': 'h',
      'Relationship between ŒîG and Keq': 'm',

      // ===== P/S (Psych/Soc) =====
      // FC6 (25%) - 6A Sensation & Perception
      'Sensory processing and thresholds': 'm',
      'Signal detection theory': 'h',
      "Weber's law": 'h',
      'Sensory adaptation': 'm',
      'Vision (eye structure, phototransduction)': 'h',
      'Visual processing pathways': 'm',
      'Hearing (ear structure, sound transduction)': 'm',
      'Auditory processing': 'l',
      'Other senses (taste, smell, touch, pain)': 'm',
      'Vestibular sense': 'l',
      'Proprioception': 'l',
      'Gestalt principles': 'h',
      'Bottom-up vs top-down processing': 'h',
      'Perceptual organization': 'm',

      // 6B Cognition, Consciousness, Memory
      'Attention (selective, divided)': 'h',
      'States of consciousness': 'm',
      'Sleep stages and disorders': 'h',
      'Hypnosis and meditation': 'l',
      'Drug effects on consciousness': 'm',
      'Memory encoding': 'h',
      'Memory storage (sensory, STM, LTM)': 'h',
      'Memory retrieval': 'h',
      'Types of memory (explicit, implicit)': 'h',
      'Forgetting (decay, interference)': 'm',
      'Memory disorders': 'l',
      'Language acquisition': 'm',
      'Language areas of brain': 'm',
      'Problem solving strategies': 'm',
      'Decision making and biases': 'h',
      'Intellectual functioning (IQ)': 'l',

      // FC7 (35%) - 7A Individual Behavior
      'Biological bases of behavior': 'h',
      'Nervous system organization': 'h',
      'Neuroplasticity': 'm',
      'Genetics and behavior': 'm',
      'Influence of environment on gene expression': 'm',
      'Drive reduction theory': 'm',
      'Arousal theory': 'm',
      'Instincts and needs': 'l',
      "Maslow's hierarchy": 'h',
      'Incentive theory': 'm',

      // 7B Learning & Behavior Change
      'Classical conditioning': 'h',
      'Operant conditioning': 'h',
      'Reinforcement schedules': 'h',
      'Punishment': 'm',
      'Extinction and spontaneous recovery': 'm',
      'Cognitive learning': 'm',
      'Observational learning': 'h',
      'Biological constraints on learning': 'l',
      'Habituation and sensitization': 'm',
      'Attitudes and behavior': 'm',
      'Elaboration likelihood model': 'h',
      'Cognitive dissonance': 'h',
      'Theories of attitude change': 'm',

      // 7C Stress, Emotion, Personality
      'Three-component model of emotion': 'm',
      'Universal emotions': 'm',
      'Adaptive role of emotions': 'l',
      'Theories of emotion (James-Lange, Cannon-Bard, Schachter-Singer)': 'h',
      'Stress response (HPA axis)': 'h',
      'General adaptation syndrome': 'h',
      'Coping strategies': 'm',
      'Psychosomatic disorders': 'l',
      'Psychoanalytic theory (Freud)': 'h',
      'Humanistic theory (Rogers, Maslow)': 'm',
      'Trait theory (Big Five)': 'h',
      'Social cognitive theory': 'm',
      'Biological basis of personality': 'l',
      'Situational influences on personality': 'm',

      // FC8 (20%) - 8A Self-Concept & Identity
      'Self-concept and self-esteem': 'h',
      'Self-efficacy': 'h',
      'Locus of control': 'h',
      'Identity formation': 'm',
      'Social identity': 'h',
      'Gender identity and roles': 'm',
      'Ethnic identity': 'm',
      "Erikson's stages of psychosocial development": 'h',

      // 8B Social Perception & Interaction
      'Attribution theory': 'h',
      'Fundamental attribution error': 'h',
      'Self-serving bias': 'h',
      'Actor-observer bias': 'm',
      'Stereotype formation': 'm',
      'Prejudice and discrimination': 'h',
      'In-group/out-group bias': 'h',
      'Self-fulfilling prophecy': 'm',
      'Impression management': 'm',

      // 8C Social Behavior
      'Attraction and relationships': 'm',
      'Aggression': 'm',
      'Altruism and prosocial behavior': 'm',
      'Conformity (Asch)': 'h',
      'Obedience (Milgram)': 'h',
      'Group dynamics': 'm',
      'Social facilitation and loafing': 'h',
      'Groupthink': 'm',
      'Deindividuation': 'm',
      'Bystander effect': 'h',

      // FC9 (15%) - 9A Social Structure
      'Theoretical approaches (functionalism, conflict theory, symbolic interactionism)': 'h',
      'Social institutions (family, education, religion, government, economy)': 'm',
      'Culture and socialization': 'h',
      'Agents of socialization': 'm',
      'Norms, values, beliefs': 'm',
      'Social roles and status': 'm',
      'Role conflict and strain': 'm',
      'Groups (primary, secondary, reference)': 'm',
      'Networks and organizations': 'l',
      'Bureaucracy': 'l',

      // 9B Demographics & Society
      'Demographic structure': 'm',
      'Population dynamics': 'l',
      'Fertility and mortality rates': 'l',
      'Migration': 'l',
      'Urbanization': 'l',
      'Globalization': 'l',
      'Social movements': 'm',
      'Collective behavior': 'l',

      // FC10 (10%) - 10A Social Inequality
      'Social class and socioeconomic status': 'h',
      'Theories of stratification': 'm',
      'Social mobility': 'm',
      'Poverty (absolute, relative)': 'm',
      'Spatial inequality': 'l',
      'Global inequality': 'l',
      'Racial and ethnic inequality': 'm',
      'Gender inequality': 'm',
      'Age inequality': 'l',
      'Disability and inequality': 'l',

      // 10B Healthcare Disparities
      'Social determinants of health': 'h',
      'Health disparities by race/ethnicity': 'h',
      'Health disparities by SES': 'h',
      'Healthcare access and utilization': 'm',
      'Health beliefs and behaviors': 'm',
      'Illness experience': 'm',
      'Medicalization': 'm',
      'Sick role': 'm',
      'Delivery of healthcare': 'l',
      'Patient-provider relationships': 'l',

      // ===== CARS =====
      // Foundations of Comprehension
      "Identifying main idea and thesis": 'h',
      "Understanding author's purpose": 'h',
      'Identifying key terms and concepts': 'h',
      'Paragraph structure and function': 'm',
      'Passage organization': 'm',
      'Understanding tone and voice': 'h',
      'Recognizing rhetorical strategies': 'm',

      // Reasoning Within the Text
      'Drawing inferences': 'h',
      'Identifying assumptions': 'h',
      'Evaluating evidence': 'h',
      'Understanding cause and effect': 'm',
      'Recognizing logical relationships': 'm',
      'Analyzing arguments': 'h',
      'Identifying strengths and weaknesses': 'm',

      // Reasoning Beyond the Text
      'Applying passage info to new contexts': 'h',
      'Extrapolating from arguments': 'm',
      'Predicting outcomes': 'm',
      'Analogical reasoning': 'm',
      'Strengthening/weakening arguments': 'h',
      'Evaluating new information impact': 'h',
      'Synthesizing multiple viewpoints': 'm'
    };

    // ===== YIELD SYSTEM CONSTANTS =====
    const YIELD = {
      h: { label: 'High Yield', short: 'HY', color: '#f59e0b', bg: 'rgba(245,158,11,0.12)', border: 'rgba(245,158,11,0.3)', icon: '\u{1F525}' },
      m: { label: 'Medium Yield', short: 'MY', color: '#64748b', bg: 'rgba(100,116,139,0.08)', border: 'rgba(100,116,139,0.2)', icon: '' },
      l: { label: 'Low Yield', short: 'LY', color: '#475569', bg: 'rgba(71,85,105,0.06)', border: 'rgba(71,85,105,0.15)', icon: '' }
    };

    const getYield = t => TOPIC_YIELD[t] || 'm';

    // ===== MASTERY LEVEL DESCRIPTIONS =====
    const MASTERY_DESC = {
      0:   { label: 'Not Started', desc: "Haven't studied this topic yet" },
      25:  { label: 'Introduced', desc: 'Read or watched content, but can\'t solve problems yet' },
      50:  { label: 'Learning', desc: 'Can handle easy questions, shaky on details' },
      75:  { label: 'Familiar', desc: 'Can handle most passage-based questions' },
      100: { label: 'Mastered', desc: 'Could teach it ‚Äî nail it under time pressure' }
    };

    // Flatten for backwards compatibility and easier mastery tracking
    const SECTIONS = {};
    Object.keys(AAMC_OUTLINE).forEach(section => {
      const s = AAMC_OUTLINE[section];
      const allTopics = [];
      Object.values(s.concepts).forEach(concept => {
        Object.values(concept.categories).forEach(cat => {
          cat.topics.forEach(t => allTopics.push(t));
        });
      });
      SECTIONS[section] = { name: s.name, full: s.full, color: s.color, topics: allTopics };
    });

    // ===== RESOURCE LIBRARY =====
    const RESOURCE_LIBRARY = {
      books: [
        { id: 'kaplan-bio', name: 'Kaplan Biology', section: 'B/B', chapters: [
          { name: 'The Cell', subtopics: ['Cell Theory', 'Organelle Structure & Function', 'Membrane Structure', 'Passive & Active Transport', 'Endocytosis & Exocytosis'] },
          { name: 'Reproduction', subtopics: ['Mitosis', 'Meiosis', 'Gametogenesis', 'Menstrual Cycle', 'Fertilization'] },
          { name: 'Embryogenesis', subtopics: ['Cleavage & Gastrulation', 'Germ Layers', 'Neurulation', 'Organogenesis', 'Developmental Signaling'] },
          { name: 'The Nervous System', subtopics: ['Neuron Structure', 'Action Potentials', 'Synaptic Transmission', 'CNS Organization', 'PNS & Autonomic NS'] },
          { name: 'The Endocrine System', subtopics: ['Hormone Types', 'Hypothalamus-Pituitary Axis', 'Thyroid & Adrenal', 'Pancreatic Hormones', 'Feedback Mechanisms'] },
          { name: 'The Respiratory System', subtopics: ['Lung Anatomy', 'Gas Exchange', 'Oxygen Transport', 'CO2 Transport', 'Ventilation Control'] },
          { name: 'The Cardiovascular System', subtopics: ['Heart Anatomy', 'Cardiac Cycle', 'Blood Vessels', 'Blood Pressure Regulation', 'Hemoglobin'] },
          { name: 'The Immune System', subtopics: ['Innate Immunity', 'Adaptive Immunity', 'T Cells & B Cells', 'Antibodies', 'Immune Disorders'] },
          { name: 'The Digestive System', subtopics: ['GI Tract Anatomy', 'Enzymatic Digestion', 'Absorption', 'Liver & Pancreas Function', 'Motility'] },
          { name: 'The Excretory System', subtopics: ['Kidney Anatomy', 'Nephron Function', 'Filtration & Reabsorption', 'Acid-Base Balance', 'Osmoregulation'] },
          { name: 'The Musculoskeletal System', subtopics: ['Skeletal Muscle Structure', 'Sliding Filament Model', 'Smooth & Cardiac Muscle', 'Bone Structure', 'Cartilage & Joints'] },
          { name: 'Genetics and Evolution', subtopics: ['Mendelian Genetics', 'Gene Linkage', 'Population Genetics', 'Natural Selection', 'Speciation'] }
        ]},
        { id: 'kaplan-biochem', name: 'Kaplan Biochemistry', section: 'B/B', chapters: [
          { name: 'Amino Acids, Peptides, Proteins', subtopics: ['Amino Acid Structure', 'Classification & Properties', 'Peptide Bond Formation', 'Protein Levels of Structure'] },
          { name: 'Enzymes', subtopics: ['Enzyme Kinetics', 'Michaelis-Menten', 'Inhibition Types', 'Regulation & Allosteric Control', 'Cooperativity'] },
          { name: 'Nonenzymatic Protein Function', subtopics: ['Motor Proteins', 'Cell Adhesion', 'Immunoglobulins', 'Biosignaling Proteins'] },
          { name: 'Carbohydrate Structure', subtopics: ['Monosaccharides', 'Disaccharides', 'Polysaccharides', 'Glycosidic Bonds'] },
          { name: 'Carbohydrate Metabolism', subtopics: ['Glycolysis', 'Gluconeogenesis', 'Glycogen Metabolism', 'Pentose Phosphate Pathway', 'Regulation'] },
          { name: 'Lipid Structure', subtopics: ['Fatty Acids', 'Triacylglycerols', 'Phospholipids', 'Steroids', 'Terpenes & Prostaglandins'] },
          { name: 'Lipid Metabolism', subtopics: ['Beta-Oxidation', 'Fatty Acid Synthesis', 'Ketone Bodies', 'Cholesterol Synthesis'] },
          { name: 'Bioenergetics', subtopics: ['Thermodynamics', 'ATP & Coupled Reactions', 'Electron Transport Chain', 'Oxidative Phosphorylation', 'Chemiosmosis'] },
          { name: 'DNA and Biotechnology', subtopics: ['DNA Structure', 'Replication', 'Repair Mechanisms', 'PCR & Gel Electrophoresis', 'Cloning & Sequencing'] },
          { name: 'RNA and the Genetic Code', subtopics: ['RNA Types', 'Transcription', 'Post-Transcriptional Modifications', 'Genetic Code Properties'] },
          { name: 'Protein Synthesis', subtopics: ['Translation Mechanism', 'Post-Translational Modifications', 'Protein Folding', 'Protein Targeting & Degradation'] }
        ]},
        { id: 'kaplan-genchem', name: 'Kaplan General Chemistry', section: 'C/P', chapters: [
          { name: 'Atomic Structure', subtopics: ['Subatomic Particles', 'Electron Configuration', 'Quantum Numbers', 'Orbital Shapes'] },
          { name: 'The Periodic Table', subtopics: ['Periodic Trends', 'Electronegativity', 'Ionization Energy', 'Electron Affinity', 'Atomic Radius'] },
          { name: 'Bonding and Chemical Interactions', subtopics: ['Ionic Bonds', 'Covalent Bonds', 'Lewis Structures', 'VSEPR Theory', 'Intermolecular Forces'] },
          { name: 'Compounds and Stoichiometry', subtopics: ['Molecular vs Empirical Formulas', 'Balancing Equations', 'Limiting Reagent', 'Percent Yield'] },
          { name: 'Chemical Kinetics', subtopics: ['Rate Laws', 'Reaction Order', 'Activation Energy', 'Catalysis', 'Rate-Determining Step'] },
          { name: 'Equilibrium', subtopics: ['Equilibrium Expressions', "Le Chatelier's Principle", 'Ksp & Solubility', 'ICE Tables'] },
          { name: 'Thermochemistry', subtopics: ['Enthalpy', 'Entropy', 'Gibbs Free Energy', "Hess's Law", 'Calorimetry'] },
          { name: 'The Gas Phase', subtopics: ['Ideal Gas Law', "Dalton's Law", 'Kinetic Molecular Theory', 'Real Gases', "Graham's Law"] },
          { name: 'Solutions', subtopics: ['Solubility Rules', 'Concentration Units', 'Colligative Properties', "Raoult's Law"] },
          { name: 'Acids and Bases', subtopics: ['Definitions', 'pH & pOH', 'Strong vs Weak', 'Buffers', 'Titrations'] },
          { name: 'Oxidation-Reduction Reactions', subtopics: ['Oxidation States', 'Balancing Redox', 'Activity Series', 'Common Oxidizers/Reducers'] },
          { name: 'Electrochemistry', subtopics: ['Galvanic Cells', 'Electrolytic Cells', 'Cell Potential', 'Nernst Equation', "Faraday's Law"] }
        ]},
        { id: 'kaplan-ochem', name: 'Kaplan Organic Chemistry', section: 'C/P', chapters: [
          { name: 'Nomenclature', subtopics: ['IUPAC Rules', 'Common Names', 'Functional Group Priority', 'Stereochemical Descriptors'] },
          { name: 'Isomers', subtopics: ['Constitutional Isomers', 'Stereoisomers', 'Enantiomers', 'Diastereomers', 'Meso Compounds'] },
          { name: 'Bonding', subtopics: ['Orbital Hybridization', 'Sigma & Pi Bonds', 'Resonance', 'Aromaticity', 'Bond Properties'] },
          { name: 'Analyzing Organic Reactions', subtopics: ['Nucleophiles & Electrophiles', 'Reaction Mechanisms', 'Thermodynamic vs Kinetic Control', 'Oxidation & Reduction'] },
          { name: 'Alcohols', subtopics: ['Alcohol Properties', 'Synthesis', 'Reactions', 'Phenols', 'Ethers & Epoxides'] },
          { name: 'Aldehydes and Ketones', subtopics: ['Nomenclature', 'Nucleophilic Addition', 'Oxidation & Reduction', 'Alpha-Carbon Chemistry'] },
          { name: 'Carboxylic Acids', subtopics: ['Properties & Acidity', 'Synthesis', 'Fischer Esterification', 'Acid Chloride Formation'] },
          { name: 'Amines', subtopics: ['Basicity', 'Synthesis', 'Reactions', 'Diazonium Chemistry'] },
          { name: 'Carboxylic Acid Derivatives', subtopics: ['Anhydrides', 'Esters', 'Amides', 'Relative Reactivity', 'Hydrolysis'] },
          { name: 'Purification and Separation', subtopics: ['Extraction', 'Distillation', 'Chromatography', 'Recrystallization'] },
          { name: 'Spectroscopy', subtopics: ['IR Spectroscopy', '1H NMR', '13C NMR', 'Mass Spectrometry', 'UV-Vis'] },
          { name: 'Lab Techniques', subtopics: ['Melting Point', 'TLC', 'Column Chromatography', 'Rotary Evaporation'] }
        ]},
        { id: 'kaplan-physics', name: 'Kaplan Physics', section: 'C/P', chapters: [
          { name: 'Kinematics', subtopics: ['Displacement & Velocity', 'Acceleration', 'Projectile Motion', 'Graphs of Motion'] },
          { name: 'Newtonian Mechanics', subtopics: ["Newton's Laws", 'Friction', 'Inclined Planes', 'Circular Motion', 'Gravitational Force'] },
          { name: 'Work, Energy, Momentum', subtopics: ['Work-Energy Theorem', 'Conservation of Energy', 'Power', 'Linear Momentum', 'Collisions'] },
          { name: 'Fluids', subtopics: ['Density & Specific Gravity', "Pascal's Law", 'Buoyancy', "Bernoulli's Equation", 'Viscosity'] },
          { name: 'Electrostatics', subtopics: ["Coulomb's Law", 'Electric Field', 'Electric Potential', 'Capacitors', 'Dielectrics'] },
          { name: 'Magnetism', subtopics: ['Magnetic Fields', 'Force on Moving Charges', 'Force on Current-Carrying Wires', 'Magnetic Flux'] },
          { name: 'Circuits', subtopics: ['Current & Resistance', "Ohm's Law", 'Series & Parallel', "Kirchhoff's Rules", 'Power'] },
          { name: 'Periodic Motion, Waves, Sound', subtopics: ['Simple Harmonic Motion', 'Wave Properties', 'Sound Intensity', 'Doppler Effect', 'Standing Waves'] },
          { name: 'Light and Optics', subtopics: ['EM Spectrum', 'Reflection & Refraction', 'Mirrors & Lenses', 'Diffraction', 'Polarization'] },
          { name: 'Atomic Phenomena', subtopics: ['Photoelectric Effect', 'Bohr Model', 'Fluorescence & Phosphorescence', 'X-ray Production'] },
          { name: 'Nuclear Phenomena', subtopics: ['Radioactive Decay', 'Half-Life', 'Fission & Fusion', 'Mass-Energy Equivalence'] }
        ]},
        { id: 'kaplan-psych', name: 'Kaplan Psychology', section: 'P/S', chapters: [
          { name: 'Biology and Behavior', subtopics: ['Brain Structure', 'Neurotransmitters', 'Neuroplasticity', 'Genetics & Behavior', 'Evolutionary Psychology'] },
          { name: 'Sensation and Perception', subtopics: ['Vision', 'Hearing', 'Somatosensation', 'Taste & Smell', 'Gestalt Principles'] },
          { name: 'Learning and Memory', subtopics: ['Classical Conditioning', 'Operant Conditioning', 'Observational Learning', 'Memory Encoding & Retrieval', 'Forgetting'] },
          { name: 'Cognition, Consciousness, Language', subtopics: ['Problem Solving', 'Decision Making', 'Language Development', 'Sleep & Consciousness', 'Attention'] },
          { name: 'Motivation, Emotion, Stress', subtopics: ['Drive Reduction Theory', "Maslow's Hierarchy", 'Theories of Emotion', 'Stress Response', 'Coping Strategies'] },
          { name: 'Identity and Personality', subtopics: ["Freud's Psychoanalytic Theory", 'Trait Theories', 'Humanistic Approach', 'Social Cognitive Theory', 'Self-Concept'] },
          { name: 'Psychological Disorders', subtopics: ['Anxiety Disorders', 'Mood Disorders', 'Schizophrenia', 'Personality Disorders', 'Treatment Approaches'] },
          { name: 'Social Processes, Attitudes, Behavior', subtopics: ['Attitude Formation', 'Persuasion', 'Cognitive Dissonance', 'Conformity & Obedience', 'Group Behavior'] },
          { name: 'Social Interaction', subtopics: ['Social Perception', 'Attribution Theory', 'Prejudice & Discrimination', 'Aggression', 'Prosocial Behavior'] },
          { name: 'Social Thinking', subtopics: ['Stereotypes', 'In-Group/Out-Group', 'Self-Serving Bias', 'Fundamental Attribution Error', 'Just-World Hypothesis'] },
          { name: 'Social Structure and Demographics', subtopics: ['Social Institutions', 'Culture', 'Socialization', 'Social Stratification', 'Health Disparities'] }
        ]},
        { id: 'kaplan-cars', name: 'Kaplan CARS', section: 'CARS', chapters: [
          { name: 'CARS Intro', subtopics: ['Format & Timing', 'Passage Types', 'Scoring Overview'] },
          { name: 'Previewing', subtopics: ['Scanning for Topic', 'Identifying Author Tone', 'Passage Mapping'] },
          { name: 'Reading Strategically', subtopics: ['Active Reading', 'Annotation Techniques', 'Pacing'] },
          { name: 'Keywords', subtopics: ['Signal Words', 'Contrast Indicators', 'Emphasis Cues'] },
          { name: 'Outlining', subtopics: ['Main Idea Identification', 'Paragraph Summaries', 'Passage Structure'] },
          { name: 'Question Types', subtopics: ['Foundations of Comprehension', 'Reasoning Within Text', 'Reasoning Beyond Text'] },
          { name: 'Wrong Answers', subtopics: ['Distractor Types', 'Process of Elimination', 'Common Traps'] },
          { name: 'Inference', subtopics: ['Implied Meaning', 'Logical Extension', 'Assumption Identification'] },
          { name: 'Author Voice', subtopics: ['Tone Analysis', 'Purpose Identification', 'Perspective Shifts'] },
          { name: 'Timing Strategy', subtopics: ['Per-Passage Timing', 'Difficulty Triage', 'Guessing Strategy'] }
        ]},
        { id: 'examkrackers-bio', name: 'Examkrackers Biology', section: 'B/B', chapters: [
          { name: 'The Cell', subtopics: ['Membrane Structure', 'Organelles', 'Cell Communication', 'Transport Mechanisms'] },
          { name: 'Enzymes', subtopics: ['Enzyme Structure', 'Kinetics', 'Inhibition', 'Cofactors & Coenzymes'] },
          { name: 'Genes', subtopics: ['DNA Structure', 'Replication', 'Mutations', 'Repair Mechanisms'] },
          { name: 'Molecular Genetics', subtopics: ['Transcription', 'Translation', 'Gene Regulation', 'Epigenetics'] },
          { name: 'The Nervous System', subtopics: ['Neurons', 'Synapses', 'Brain Regions', 'Sensory Processing'] },
          { name: 'The Endocrine System', subtopics: ['Hormones', 'Glands', 'Feedback Loops', 'Signaling Pathways'] },
          { name: 'Blood and Immunity', subtopics: ['Blood Components', 'Clotting Cascade', 'Innate & Adaptive Immunity'] },
          { name: 'Digestion', subtopics: ['GI Anatomy', 'Enzymes', 'Absorption', 'Regulation'] },
          { name: 'Respiration', subtopics: ['Lung Structure', 'Gas Exchange', 'Hemoglobin', 'Ventilation'] },
          { name: 'Circulation', subtopics: ['Heart', 'Blood Vessels', 'Blood Pressure', 'Cardiac Output'] },
          { name: 'Muscle, Bone, Skin', subtopics: ['Muscle Contraction', 'Skeletal System', 'Integumentary System'] },
          { name: 'Populations and Evolution', subtopics: ['Hardy-Weinberg', 'Natural Selection', 'Genetic Drift', 'Speciation'] }
        ]},
        { id: 'tpr-bio', name: 'Princeton Review Biology', section: 'B/B', chapters: [
          { name: 'Biochemistry', subtopics: ['Macromolecules', 'Enzyme Function', 'Metabolism', 'Bioenergetics'] },
          { name: 'Molecular Biology', subtopics: ['DNA Replication', 'Transcription', 'Translation', 'Gene Regulation'] },
          { name: 'Microbiology', subtopics: ['Bacteria', 'Viruses', 'Fungi', 'Parasites', 'Prions'] },
          { name: 'Eukaryotic Cells', subtopics: ['Organelles', 'Cytoskeleton', 'Cell Cycle', 'Apoptosis'] },
          { name: 'Genetics', subtopics: ['Mendelian Genetics', 'Linkage', 'Pedigrees', 'Chromosomal Abnormalities'] },
          { name: 'The Nervous and Endocrine Systems', subtopics: ['CNS & PNS', 'Neurotransmission', 'Hormones', 'Feedback'] },
          { name: 'The Circulatory, Lymphatic, and Immune Systems', subtopics: ['Heart & Vessels', 'Lymph Nodes', 'Immune Response', 'Blood Types'] },
          { name: 'The Digestive and Excretory Systems', subtopics: ['GI Tract', 'Enzymes', 'Kidney Function', 'Waste Removal'] },
          { name: 'The Musculoskeletal System', subtopics: ['Muscle Types', 'Contraction', 'Bone Growth', 'Joints'] },
          { name: 'The Respiratory System', subtopics: ['Mechanics of Breathing', 'Gas Laws', 'O2 & CO2 Transport'] },
          { name: 'The Skin', subtopics: ['Layers', 'Thermoregulation', 'Glands', 'Wound Healing'] },
          { name: 'Reproduction and Development', subtopics: ['Gametogenesis', 'Fertilization', 'Embryonic Development', 'Fetal Circulation'] }
        ]},
        { id: 'berkeley-bio', name: 'Berkeley Review Biology', section: 'B/B', chapters: [
          { name: 'Bioenergetics', subtopics: ['Thermodynamics', 'ATP', 'Electron Transport', 'Chemiosmosis'] },
          { name: 'Cell Biology', subtopics: ['Membrane Dynamics', 'Organelle Function', 'Signal Transduction', 'Cytoskeleton'] },
          { name: 'Molecular Genetics', subtopics: ['DNA Structure', 'Replication', 'Repair', 'Recombination'] },
          { name: 'Microbiology', subtopics: ['Prokaryotes', 'Viral Life Cycles', 'Bacterial Genetics', 'Pathogenesis'] },
          { name: 'Physiology Part 1', subtopics: ['Nervous System', 'Endocrine System', 'Musculoskeletal System'] },
          { name: 'Physiology Part 2', subtopics: ['Cardiovascular', 'Respiratory', 'Renal', 'Digestive Systems'] },
          { name: 'Immunology', subtopics: ['Innate Immunity', 'Adaptive Immunity', 'Immunoglobulins', 'Hypersensitivity'] },
          { name: 'Reproduction', subtopics: ['Gametogenesis', 'Hormonal Control', 'Fertilization', 'Contraception'] },
          { name: 'Development', subtopics: ['Cleavage', 'Gastrulation', 'Organogenesis', 'Birth Defects'] },
          { name: 'Evolution', subtopics: ['Natural Selection', 'Genetic Drift', 'Gene Flow', 'Speciation', 'Phylogenetics'] }
        ]}
      ],
      qbanks: [
        { id: 'uworld', name: 'UWorld MCAT', totalQ: 1850, sections: {cp:500, cars:300, bb:550, ps:500}, desc: 'Comprehensive with detailed explanations' },
        { id: 'aamc-qpack-bio1', name: 'AAMC Bio QP 1', totalQ: 120, sections: {bb:120}, desc: 'Official AAMC biology questions vol 1' },
        { id: 'aamc-qpack-bio2', name: 'AAMC Bio QP 2', totalQ: 120, sections: {bb:120}, desc: 'Official AAMC biology questions vol 2' },
        { id: 'aamc-qpack-chem', name: 'AAMC Chem QP', totalQ: 120, sections: {cp:120}, desc: 'Official AAMC chemistry questions' },
        { id: 'aamc-qpack-phys', name: 'AAMC Physics QP', totalQ: 120, sections: {cp:120}, desc: 'Official AAMC physics questions' },
        { id: 'aamc-qpack-cars1', name: 'AAMC CARS QP 1', totalQ: 120, sections: {cars:120}, desc: 'Official AAMC CARS vol 1' },
        { id: 'aamc-qpack-cars2', name: 'AAMC CARS QP 2', totalQ: 120, sections: {cars:120}, desc: 'Official AAMC CARS vol 2' },
        { id: 'aamc-sb', name: 'AAMC Section Bank', totalQ: 300, sections: {cp:100, bb:100, ps:100}, desc: 'Hardest official AAMC questions' },
        { id: 'blueprint-qbank', name: 'Blueprint QBank', totalQ: 4000, sections: {cp:1000, cars:500, bb:1200, ps:1300}, desc: 'Large qbank with passages' },
        { id: 'jw-qbank', name: 'Jack Westin CARS', totalQ: 500, sections: {cars:500}, desc: 'Free daily CARS practice' }
      ],
      anki: [
        { id: 'milesdown', name: 'MilesDown Anki', totalCards: 2900, desc: 'Most popular, covers all sections' },
        { id: 'jacksparrow', name: 'JackSparrow Anki', totalCards: 5800, desc: 'Very comprehensive, more detail' },
        { id: 'ortho528', name: 'Ortho528 Anki', totalCards: 3200, desc: 'Great for P/S section' },
        { id: 'premed95', name: 'Premed95 P/S', totalCards: 1400, desc: '300 page doc + flashcards' },
        { id: 'bouras', name: 'Bouras P/S', totalCards: 1800, desc: 'Comprehensive P/S deck' },
        { id: 'cubene', name: 'Cubene Anki', totalCards: 2400, desc: 'Based on Kaplan books' }
      ],
      videos: [
        { id: 'khan-mcat', name: 'Khan Academy MCAT', totalVids: 1200, desc: 'Free, official AAMC partnership', units: [
          { name: 'Biology', topics: [
            { name: 'Cell Biology', vids: 25 },
            { name: 'Organ Systems', vids: 30 },
            { name: 'Genetics', vids: 25 },
            { name: 'Evolution', vids: 15 },
            { name: 'DNA/RNA', vids: 20 },
            { name: 'Anatomy & Physiology', vids: 25 },
            { name: 'Reproduction & Development', vids: 20 },
            { name: 'Nervous System', vids: 20 },
            { name: 'Endocrine System', vids: 20 }
          ]},
          { name: 'Biochemistry', topics: [
            { name: 'Amino Acids & Proteins', vids: 25 },
            { name: 'Enzymes', vids: 20 },
            { name: 'Metabolism', vids: 30 },
            { name: 'Carbohydrates', vids: 15 },
            { name: 'Lipids', vids: 15 },
            { name: 'Bioenergetics', vids: 20 },
            { name: 'DNA Replication', vids: 15 },
            { name: 'Transcription & Translation', vids: 20 },
            { name: 'Protein Structure', vids: 15 },
            { name: 'Lab Techniques', vids: 25 }
          ]},
          { name: 'General Chemistry', topics: [
            { name: 'Atomic Structure', vids: 20 },
            { name: 'Periodic Table Trends', vids: 15 },
            { name: 'Bonding', vids: 20 },
            { name: 'Stoichiometry', vids: 15 },
            { name: 'Kinetics', vids: 20 },
            { name: 'Equilibrium', vids: 20 },
            { name: 'Thermodynamics', vids: 20 },
            { name: 'Solutions', vids: 15 },
            { name: 'Acids & Bases', vids: 20 },
            { name: 'Electrochemistry', vids: 15 }
          ]},
          { name: 'Organic Chemistry', topics: [
            { name: 'Nomenclature & Structure', vids: 20 },
            { name: 'Stereochemistry', vids: 15 },
            { name: 'Reaction Mechanisms', vids: 25 },
            { name: 'Functional Groups', vids: 20 },
            { name: 'Alcohols & Ethers', vids: 15 },
            { name: 'Carbonyls', vids: 20 },
            { name: 'Carboxylic Acids & Derivatives', vids: 15 },
            { name: 'Amines', vids: 10 },
            { name: 'Spectroscopy', vids: 15 },
            { name: 'Separations & Purifications', vids: 15 }
          ]},
          { name: 'Physics', topics: [
            { name: 'Kinematics & Dynamics', vids: 25 },
            { name: 'Work, Energy & Momentum', vids: 20 },
            { name: 'Fluids', vids: 20 },
            { name: 'Electrostatics', vids: 25 },
            { name: 'Circuits', vids: 20 },
            { name: 'Magnetism', vids: 15 },
            { name: 'Waves & Sound', vids: 20 },
            { name: 'Optics', vids: 20 },
            { name: 'Thermodynamics', vids: 15 },
            { name: 'Atomic & Nuclear Physics', vids: 20 }
          ]},
          { name: 'Psychology & Sociology', topics: [
            { name: 'Sensation & Perception', vids: 25 },
            { name: 'Learning & Memory', vids: 25 },
            { name: 'Cognition & Language', vids: 20 },
            { name: 'Motivation & Emotion', vids: 20 },
            { name: 'Stress & Coping', vids: 15 },
            { name: 'Identity & Personality', vids: 20 },
            { name: 'Psychological Disorders', vids: 25 },
            { name: 'Social Processes', vids: 20 },
            { name: 'Social Structures', vids: 25 },
            { name: 'Biological Bases of Behavior', vids: 20 },
            { name: 'Consciousness', vids: 15 },
            { name: 'Social Stratification', vids: 20 }
          ]}
        ]},
        { id: 'ak-lectures', name: 'AK Lectures', totalVids: 400, desc: 'Excellent biochem explanations', units: [
          { name: 'Biochemistry', topics: [
            { name: 'Amino Acids', vids: 20 },
            { name: 'Protein Structure', vids: 25 },
            { name: 'Enzymes & Kinetics', vids: 30 },
            { name: 'Carbohydrate Chemistry', vids: 20 },
            { name: 'Glycolysis & Gluconeogenesis', vids: 25 },
            { name: 'TCA Cycle', vids: 15 },
            { name: 'Oxidative Phosphorylation', vids: 20 },
            { name: 'Lipid Metabolism', vids: 25 },
            { name: 'Fatty Acid Synthesis', vids: 15 },
            { name: 'Nucleotide Metabolism', vids: 15 },
            { name: 'Metabolic Integration', vids: 20 },
            { name: 'DNA Structure & Replication', vids: 20 }
          ]},
          { name: 'Biology', topics: [
            { name: 'Cell Biology & Membranes', vids: 20 },
            { name: 'Cell Signaling', vids: 15 },
            { name: 'Cell Cycle & Division', vids: 15 },
            { name: 'Molecular Genetics', vids: 20 },
            { name: 'Gene Expression', vids: 20 },
            { name: 'Immune System', vids: 20 },
            { name: 'Nervous System', vids: 15 },
            { name: 'Endocrine System', vids: 15 },
            { name: 'Cardiovascular System', vids: 10 }
          ]}
        ]},
        { id: 'ochem-tutor', name: 'Organic Chemistry Tutor', totalVids: 600, desc: 'Great for C/P content', units: [
          { name: 'General Chemistry', topics: [
            { name: 'Atomic Theory & Periodicity', vids: 20 },
            { name: 'Chemical Bonding', vids: 20 },
            { name: 'Stoichiometry & Reactions', vids: 25 },
            { name: 'Gas Laws', vids: 15 },
            { name: 'Solutions & Colligative Properties', vids: 20 },
            { name: 'Thermochemistry', vids: 20 },
            { name: 'Chemical Kinetics', vids: 20 },
            { name: 'Chemical Equilibrium', vids: 20 },
            { name: 'Acids, Bases & Buffers', vids: 20 }
          ]},
          { name: 'Organic Chemistry', topics: [
            { name: 'Bonding & Hybridization', vids: 15 },
            { name: 'Alkanes & Cycloalkanes', vids: 10 },
            { name: 'Stereochemistry', vids: 20 },
            { name: 'Substitution & Elimination', vids: 25 },
            { name: 'Alkene Reactions', vids: 20 },
            { name: 'Aromatic Chemistry', vids: 15 },
            { name: 'Alcohols & Phenols', vids: 15 },
            { name: 'Aldehydes & Ketones', vids: 15 },
            { name: 'Carboxylic Acid Chemistry', vids: 15 },
            { name: 'Amines & Amino Acids', vids: 10 },
            { name: 'Spectroscopy (NMR, IR, MS)', vids: 10 }
          ]},
          { name: 'Physics', topics: [
            { name: 'Mechanics & Kinematics', vids: 20 },
            { name: 'Forces & Newton\'s Laws', vids: 20 },
            { name: 'Energy & Work', vids: 15 },
            { name: 'Fluids & Bernoulli\'s', vids: 15 },
            { name: 'Electrostatics & Coulomb\'s', vids: 20 },
            { name: 'DC Circuits', vids: 15 },
            { name: 'Waves & Optics', vids: 20 },
            { name: 'Thermodynamics', vids: 15 },
            { name: 'Modern Physics', vids: 10 }
          ]},
          { name: 'Biochemistry', topics: [
            { name: 'Amino Acid Chemistry', vids: 12 },
            { name: 'Enzyme Kinetics', vids: 15 },
            { name: 'Metabolism Overview', vids: 15 },
            { name: 'Nucleic Acid Chemistry', vids: 12 },
            { name: 'Lipid Biochemistry', vids: 12 },
            { name: 'Protein Function', vids: 12 },
            { name: 'Carbohydrate Metabolism', vids: 12 },
            { name: 'Bioenergetics & ATP', vids: 10 }
          ]}
        ]},
        { id: 'science-simplified', name: 'Science Simplified', totalVids: 200, desc: 'Quick concept reviews', units: [
          { name: 'Biology', topics: [
            { name: 'Cell Structure & Function', vids: 15 },
            { name: 'Membrane Transport', vids: 10 },
            { name: 'Cellular Respiration', vids: 15 },
            { name: 'Photosynthesis Basics', vids: 10 },
            { name: 'DNA & Gene Expression', vids: 15 },
            { name: 'Cell Division', vids: 10 },
            { name: 'Evolution & Natural Selection', vids: 10 },
            { name: 'Organ Systems Overview', vids: 15 },
            { name: 'Immune Response', vids: 10 },
            { name: 'Reproductive Biology', vids: 10 }
          ]},
          { name: 'Biochemistry', topics: [
            { name: 'Macromolecules Review', vids: 12 },
            { name: 'Enzyme Fundamentals', vids: 10 },
            { name: 'Glycolysis & Fermentation', vids: 10 },
            { name: 'Krebs Cycle & ETC', vids: 12 },
            { name: 'Lipid Structures', vids: 8 },
            { name: 'Amino Acid Properties', vids: 8 },
            { name: 'Nucleotide Chemistry', vids: 8 },
            { name: 'Metabolic Pathways Summary', vids: 12 }
          ]}
        ]},
        { id: 'medschoolcoach', name: 'MedSchoolCoach Videos', totalVids: 150, desc: 'Strategy focused', units: [
          { name: 'MCAT Strategy', topics: [
            { name: 'Test Day Tips', vids: 8 },
            { name: 'Time Management', vids: 8 },
            { name: 'CARS Strategy', vids: 10 },
            { name: 'Passage Analysis', vids: 8 },
            { name: 'Question Approach Methods', vids: 8 },
            { name: 'Score Improvement Planning', vids: 8 }
          ]},
          { name: 'Content Review', topics: [
            { name: 'High-Yield Biology', vids: 10 },
            { name: 'High-Yield Chemistry', vids: 10 },
            { name: 'High-Yield Physics', vids: 8 },
            { name: 'High-Yield Biochem', vids: 10 },
            { name: 'High-Yield P/S', vids: 10 },
            { name: 'CARS Practice Passages', vids: 12 }
          ]},
          { name: 'Application & Admissions', topics: [
            { name: 'Personal Statement Writing', vids: 8 },
            { name: 'Interview Preparation', vids: 8 },
            { name: 'School Selection', vids: 6 },
            { name: 'Application Timeline', vids: 6 },
            { name: 'Extracurricular Planning', vids: 6 },
            { name: 'Letters of Recommendation', vids: 6 }
          ]}
        ]}
      ],
      fulllengths: [
        { id: 'aamc-sample', name: 'AAMC Sample (Free)', official: true, desc: 'Unscored diagnostic' },
        { id: 'aamc-fl1', name: 'AAMC FL 1', official: true, desc: 'First official scored FL' },
        { id: 'aamc-fl2', name: 'AAMC FL 2', official: true, desc: 'Second official FL' },
        { id: 'aamc-fl3', name: 'AAMC FL 3', official: true, desc: 'Third official FL' },
        { id: 'aamc-fl4', name: 'AAMC FL 4', official: true, desc: 'Fourth official FL' },
        { id: 'aamc-fl5', name: 'AAMC FL 5', official: true, desc: 'Newest official FL' },
        { id: 'blueprint-fl', name: 'Blueprint FLs (10)', official: false, desc: 'Good for early practice' },
        { id: 'kaplan-fl', name: 'Kaplan FLs (5)', official: false, desc: 'Comes with books' },
        { id: 'princeton-fl', name: 'Princeton FLs (5)', official: false, desc: 'Notoriously deflated' },
        { id: 'altius-fl', name: 'Altius FLs (10)', official: false, desc: 'Similar to AAMC style' }
      ]
    };

    // Old format for backwards compatibility
    const RESOURCES = [
      { id: 'kaplan', name: 'Kaplan Books', cat: 'Content Review' },
      { id: 'khan', name: 'Khan Academy', cat: 'Content Review' },
      { id: 'miledown', name: 'MilesDown Anki', cat: 'Flashcards' },
      { id: 'uworld', name: 'UWorld', cat: 'Practice' }
    ];

    const PERCENTILES = {528:100,527:100,526:100,525:100,524:100,523:99,522:99,521:98,520:97,519:96,518:95,517:94,516:92,515:90,514:88,513:85,512:82,511:79,510:75,509:71,508:67,507:63,506:58,505:54,504:49,503:45,502:40,501:36,500:32,499:28,498:24,497:21,496:18,495:15,494:12,493:10,492:8,491:6,490:5};

    if (!Object.keys(state.mastery).length) {
      Object.keys(SECTIONS).forEach(s => SECTIONS[s].topics.forEach(t => state.mastery[s+'-'+t] = 0));
    }
    // Migrate old resources format or initialize new format
    if (!state.myResources) {
      state.myResources = [];
    }
    // Migrate old-format book chapters (string arrays) to new format (objects with subtopics)
    state.myResources.forEach(r => {
      if (r.type === 'book' && r.chapters && r.chapters.length > 0 && typeof r.chapters[0] === 'string') {
        // Old format: chapters are strings like "Chapter Name"
        const libBook = RESOURCE_LIBRARY.books.find(b => b.id === r.id);
        r.chapters = r.chapters.map((ch, i) => {
          const chName = typeof ch === 'string' ? ch : ch.name;
          const chDone = typeof ch === 'object' ? !!ch.done : false;
          const libChapter = libBook && libBook.chapters[i];
          return {
            name: chName,
            done: chDone,
            subtopics: (libChapter && libChapter.subtopics || []).map(st => ({ name: st, done: false }))
          };
        });
      } else if (r.type === 'book' && r.chapters && r.chapters.length > 0 && typeof r.chapters[0] === 'object' && !r.chapters[0].subtopics) {
        // Old format: chapters are objects {name, done} but no subtopics
        const libBook = RESOURCE_LIBRARY.books.find(b => b.id === r.id);
        r.chapters = r.chapters.map((ch, i) => {
          const libChapter = libBook && libBook.chapters[i];
          return {
            name: ch.name,
            done: ch.done,
            subtopics: (libChapter && libChapter.subtopics || []).map(st => ({ name: st, done: ch.done }))
          };
        });
      }
      // Migrate old-format video resources (flat watched count) to new unit format
      if (r.type === 'video' && !r.units) {
        const libVid = RESOURCE_LIBRARY.videos.find(v => v.id === r.id);
        if (libVid && libVid.units) {
          const oldWatched = r.watched || 0;
          r.units = libVid.units.map(u => ({
            name: u.name, expanded: false,
            topics: u.topics.map(t => ({ name: t.name, vids: t.vids, watched: 0 }))
          }));
          // Distribute old watched count proportionally across topics
          if (oldWatched > 0) {
            let remaining = oldWatched;
            for (const unit of r.units) {
              for (const topic of unit.topics) {
                const share = Math.min(topic.vids, Math.round((topic.vids / r.total) * oldWatched));
                topic.watched = Math.min(topic.vids, share);
                remaining -= topic.watched;
              }
            }
          }
          delete r.watched;
        }
      }
    });
    // Keep old resources for backwards compat
    if (!state.resources) state.resources = RESOURCES.map(r => ({...r, progress: 0}));
    // Resource view state
    if (!state.resourceView) state.resourceView = 'my'; // 'my' or 'library'
    if (!state.resourceFilter) state.resourceFilter = 'all';

    // ===== UTILS =====
    const save = () => {
      // Always save to localStorage as backup
      localStorage.setItem('mcat-date', state.testDate);
      localStorage.setItem('mcat-target', state.targetScore);
      localStorage.setItem('mcat-logs', JSON.stringify(state.logs));
      localStorage.setItem('mcat-tests', JSON.stringify(state.tests));
      localStorage.setItem('mcat-mastery', JSON.stringify(state.mastery));
      localStorage.setItem('mcat-resources', JSON.stringify(state.resources));
      localStorage.setItem('mcat-myResources', JSON.stringify(state.myResources));
      localStorage.setItem('mcat-streak', state.streak);
      localStorage.setItem('mcat-last-study', state.lastStudyDate);
      localStorage.setItem('mcat-daily-goal', state.dailyGoal);
      localStorage.setItem('mcat-pomo-min', state.pomodoroMinutes);
      localStorage.setItem('mcat-pomo-break', state.pomodoroBreakMinutes);
      localStorage.setItem('mcat-pomo-long-break', state.pomodoroLongBreakMinutes);
      localStorage.setItem('mcat-pomo-sessions', state.pomodoroSessionCount);
      localStorage.setItem('mcat-timer-sound', state.timerSoundEnabled);
      localStorage.setItem('mcat-user-name', state.userName);
      localStorage.setItem('mcat-study-phase', state.studyPhase);
      localStorage.setItem('mcat-journal', JSON.stringify(state.journal));

      // Also save to file if connected
      if (fileHandle) {
        saveToFile();
      }
    };

    const today = () => new Date().toISOString().split('T')[0];
    const daysUntil = d => Math.ceil((new Date(d+'T00:00:00') - new Date().setHours(0,0,0,0)) / 86400000);
    const formatDate = d => new Date(d+'T00:00:00').toLocaleDateString('en-US', {month:'short', day:'numeric'});
    const getPercentile = s => PERCENTILES[Math.min(528, Math.max(490, s))] || '<5';
    const formatTime = s => { const m = Math.floor(s/60), sec = s%60; return `${m}:${sec.toString().padStart(2,'0')}`; };
    const formatTimeLong = s => { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60; return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}` : `${m}:${sec.toString().padStart(2,'0')}`; };

    const showToast = (msg, type='success') => {
      const t = document.getElementById('toast');
      t.innerHTML = `${type==='success'?'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>':'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'}${msg}`;
      t.className = `toast ${type}`;
      setTimeout(() => t.classList.add('show'), 10);
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    const showModal = c => {
      document.getElementById('modal').innerHTML = `<div class="modal-content">${c}</div>`;
      document.getElementById('modal').classList.add('show');
    };
    const hideModal = () => document.getElementById('modal').classList.remove('show');
    document.getElementById('modal').onclick = e => { if(e.target.id==='modal') hideModal(); };

    const updateStreak = () => {
      const t = today();
      const hrs = state.logs.filter(l => l.date === t).reduce((s,l) => s+l.hours, 0);
      if (hrs >= state.dailyGoal && state.lastStudyDate !== t) {
        const y = new Date(); y.setDate(y.getDate()-1);
        state.streak = (state.lastStudyDate === y.toISOString().split('T')[0] || !state.streak) ? state.streak + 1 : 1;
        state.lastStudyDate = t;
        if (state.streak > 1) triggerConfetti();
      }
    };

    const getWeakTopics = (n=5) => {
      const all = [];
      const yieldOrder = { h: 0, m: 1, l: 2 };
      Object.keys(SECTIONS).forEach(s => SECTIONS[s].topics.forEach(t => all.push({section:s, topic:t, val:state.mastery[s+'-'+t]||0, yield:getYield(t)})));
      return all.filter(x => x.val < 75).sort((a,b) => {
        // High yield first, then by lowest mastery
        const yDiff = yieldOrder[a.yield] - yieldOrder[b.yield];
        return yDiff !== 0 ? yDiff : a.val - b.val;
      }).slice(0, n);
    };

    const getSmartSuggestions = () => {
      const suggestions = [];
      const sectionLastStudied = {};

      state.logs.forEach(l => {
        Object.keys(SECTIONS).forEach(s => {
          if (l.notes && l.notes.toLowerCase().includes(SECTIONS[s].name.toLowerCase())) {
            if (!sectionLastStudied[s] || l.date > sectionLastStudied[s]) {
              sectionLastStudied[s] = l.date;
            }
          }
        });
      });

      Object.keys(SECTIONS).forEach(s => {
        const lastDate = sectionLastStudied[s];
        if (lastDate) {
          const daysSince = Math.floor((new Date() - new Date(lastDate)) / 86400000);
          if (daysSince >= 3) {
            suggestions.push({ type: 'review', section: s, days: daysSince, msg: `It's been ${daysSince} days since you studied ${SECTIONS[s].name}` });
          }
        }
      });

      // FL score-driven suggestions: flag weakest sections from latest test
      if (state.tests.length > 0) {
        const latest = state.tests[state.tests.length - 1];
        const sectionScores = [
          { section: 'C/P', score: latest.cp, name: 'Chem/Phys' },
          { section: 'CARS', score: latest.cars, name: 'CARS' },
          { section: 'B/B', score: latest.bb, name: 'Bio/Biochem' },
          { section: 'P/S', score: latest.ps, name: 'Psych/Soc' }
        ].sort((a,b) => a.score - b.score);
        const weakest = sectionScores[0];
        if (weakest.score < 128) {
          suggestions.push({ type: 'fl-weak', section: weakest.section, msg: `${weakest.name} was your lowest section (${weakest.score}) \u2014 prioritize high-yield topics there` });
        }
        // Second weakest if also under 126
        const second = sectionScores[1];
        if (second.score < 126) {
          suggestions.push({ type: 'fl-weak', section: second.section, msg: `${second.name} scored ${second.score} \u2014 room to gain points here` });
        }
      }

      const weak = getWeakTopics(3);
      weak.forEach(w => {
        if (w.val < 25) {
          suggestions.push({ type: 'weak', section: w.section, topic: w.topic, msg: `Focus on ${w.topic} - only ${w.val}% mastered` });
        }
      });

      const todayHrs = state.logs.filter(l => l.date === today()).reduce((s,l) => s+l.hours, 0);
      if (todayHrs < state.dailyGoal) {
        suggestions.push({ type: 'goal', msg: `${(state.dailyGoal - todayHrs).toFixed(1)} more hours to hit your daily goal!` });
      }

      return suggestions.slice(0, 4);
    };

    const exportData = () => {
      const data = {testDate:state.testDate,targetScore:state.targetScore,logs:state.logs,tests:state.tests,mastery:state.mastery,resources:state.resources,myResources:state.myResources,streak:state.streak,lastStudyDate:state.lastStudyDate,dailyGoal:state.dailyGoal,xp:state.xp,achievements:state.achievements,pomodoroMinutes:state.pomodoroMinutes,pomodoroBreakMinutes:state.pomodoroBreakMinutes,pomodoroLongBreakMinutes:state.pomodoroLongBreakMinutes,pomodoroSessionCount:state.pomodoroSessionCount,timerSoundEnabled:state.timerSoundEnabled};
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)])); a.download = `mcat-backup-${today()}.json`; a.click();
      localStorage.setItem('mcat-last-backup', Date.now().toString());
      showToast('Backup downloaded ‚úì');
    };

    // ===== WEEKLY BACKUP REMINDER =====
    const checkBackupReminder = () => {
      const lastBackup = parseInt(localStorage.getItem('mcat-last-backup') || '0');
      const dismissed = parseInt(localStorage.getItem('mcat-backup-dismissed') || '0');
      const now = Date.now();
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      const hasData = state.logs.length > 0 || state.tests.length > 0 || state.myResources.length > 0;

      // Show reminder if: has data AND (never backed up OR it's been 7+ days since last backup/dismiss)
      if (hasData && (now - lastBackup > oneWeek) && (now - dismissed > oneWeek)) {
        showBackupModal();
      }
    };

    const showBackupModal = () => {
      const modal = document.createElement('div');
      modal.id = 'backup-modal';
      modal.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)">
          <div style="background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:16px;padding:32px;max-width:420px;width:90%;text-align:center">
            <div style="font-size:40px;margin-bottom:12px"><span style="display:inline-block;width:40px;height:40px;opacity:0.5">${icon.save}</span></div>
            <h3 style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text-primary)">Time to back up your data!</h3>
            <p style="color:var(--text-secondary);font-size:14px;margin-bottom:24px;line-height:1.5">
              It's been a week since your last backup. Download a copy so you never lose your progress ‚Äî even if you clear your browser data.
            </p>
            <div style="display:flex;gap:12px;justify-content:center">
              <button onclick="document.getElementById('backup-modal').remove();localStorage.setItem('mcat-backup-dismissed',Date.now().toString())"
                style="padding:10px 20px;border-radius:10px;border:1px solid var(--border-subtle);background:var(--bg-elevated);color:var(--text-secondary);cursor:pointer;font-size:14px">
                Remind me later
              </button>
              <button onclick="exportData();document.getElementById('backup-modal').remove()"
                style="padding:10px 20px;border-radius:10px;border:none;background:var(--focus);color:white;cursor:pointer;font-size:14px;font-weight:600">
                Download Backup
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };
    const importData = e => {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev => { try { Object.assign(state, JSON.parse(ev.target.result)); save(); render(); showToast('Data restored'); } catch(e) { showToast('Invalid file','error'); }};
      r.readAsText(f);
    };

    // ===== TIMER =====
    let timerInt = null;

    // Web Audio API chime - no external files needed
    const playTimerChime = () => {
      if (!state.timerSoundEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.4);
          osc.start(ctx.currentTime + i * 0.15);
          osc.stop(ctx.currentTime + i * 0.15 + 0.4);
        });
      } catch(e) {}
    };

    const startTimer = () => {
      if(state.timerRunning) return;
      state.timerRunning = true;
      timerInt = setInterval(() => {
        if(state.pomodoroMode) {
          state.timerSeconds--;
          if(state.timerSeconds <= 0) {
            clearInterval(timerInt);
            state.timerRunning = false;
            playTimerChime();
            if (state.isBreak) {
              // Break just ended, back to work
              state.isBreak = false;
              state.timerSeconds = state.pomodoroMinutes * 60;
              showToast('Break over! Time to focus.');
            } else {
              // Work session just ended
              logTimer();
              state.pomodoroSessionCount = (state.pomodoroSessionCount || 0) + 1;
              save();
              triggerConfetti();
              // Decide break type
              const isLongBreak = state.pomodoroSessionCount % state.pomodoroSessionsUntilLongBreak === 0;
              const breakMin = isLongBreak ? state.pomodoroLongBreakMinutes : state.pomodoroBreakMinutes;
              state.isBreak = true;
              state.timerSeconds = breakMin * 60;
              showToast(isLongBreak ? `Great work! ${breakMin}min long break.` : `Pomodoro #${state.pomodoroSessionCount}! ${breakMin}min break.`);
            }
            render();
          }
        } else {
          state.timerSeconds++;
        }
        const el = document.getElementById('timer-val');
        if(el) el.textContent = formatTimeLong(state.timerSeconds);
        const focusEl = document.getElementById('focus-timer-val');
        if(focusEl) focusEl.textContent = formatTimeLong(state.timerSeconds);
      }, 1000);
      render();
    };
    const pauseTimer = () => { state.timerRunning = false; clearInterval(timerInt); render(); };
    const stopTimer = () => {
      state.timerRunning = false;
      clearInterval(timerInt);
      if(!state.pomodoroMode && state.timerSeconds > 60) logTimer();
      state.isBreak = false;
      state.timerSeconds = state.pomodoroMode ? state.pomodoroMinutes * 60 : 0;
      render();
    };
    const skipBreak = () => {
      if (state.isBreak) {
        state.isBreak = false;
        state.timerRunning = false;
        clearInterval(timerInt);
        state.timerSeconds = state.pomodoroMinutes * 60;
        render();
        showToast('Break skipped. Ready to go!');
      }
    };
    const logTimer = () => {
      const hrs = state.pomodoroMode ? state.pomodoroMinutes/60 : Math.round(state.timerSeconds/36)/100;
      if(hrs >= 0.08) {
        state.logs.push({id:Date.now(),date:today(),category:state.timerCategory,hours:Math.round(hrs*100)/100,notes:`Timer session${state.pomodoroMode?' (Pomodoro #'+(state.pomodoroSessionCount+1)+')':''}`});
        updateStreak();
        save();
        addXP(Math.round(hrs * 30), 'Study session');
        checkAchievements();
      }
    };

    // ===== FOCUS MODE =====
    const enterFocusMode = () => {
      state.focusMode = true;
      renderFocusMode();
      document.getElementById('focus-mode').classList.add('active');
    };
    const exitFocusMode = () => {
      state.focusMode = false;
      document.getElementById('focus-mode').classList.remove('active');
    };
    const renderFocusMode = () => {
      document.getElementById('focus-mode').innerHTML = `
        <div class="text-center">
          <div class="focus-timer mb-4" id="focus-timer-val">${formatTimeLong(state.timerSeconds)}</div>
          <div class="text-2xl text-[var(--text-muted)] mb-8">${state.timerCategory}</div>
          <div class="flex justify-center gap-4 mb-8">
            ${!state.timerRunning ? `
              <button onclick="startTimer()" class="btn btn-primary text-xl px-8 py-4">${icon.play} Start</button>
            ` : `
              <button onclick="pauseTimer()" class="btn btn-secondary text-xl px-8 py-4">${icon.pause} Pause</button>
            `}
            <button onclick="stopTimer()" class="btn btn-secondary text-xl px-8 py-4">${icon.stop} Stop</button>
          </div>
          <button onclick="exitFocusMode()" class="btn btn-ghost text-lg">Exit Focus Mode (Esc)</button>
          <div class="mt-12 text-[var(--text-muted)]">
            <p class="text-lg italic">"${getSmartQuote('focus').text}"</p>
          </div>
        </div>
      `;
    };

    // ===== KEYBOARD SHORTCUTS =====
    const showShortcuts = () => {
      document.getElementById('shortcuts-modal').classList.add('show');
      document.getElementById('shortcuts-modal').innerHTML = `
        <div class="card p-8 max-w-lg">
          <h2 class="text-xl font-bold mb-6">Keyboard Shortcuts</h2>
          <div class="space-y-3">
            <div class="flex justify-between items-center"><span>Dashboard</span><span class="kbd">1</span></div>
            <div class="flex justify-between items-center"><span>Study Log</span><span class="kbd">2</span></div>
            <div class="flex justify-between items-center"><span>Scores</span><span class="kbd">3</span></div>
            <div class="flex justify-between items-center"><span>Content</span><span class="kbd">4</span></div>
            <div class="flex justify-between items-center"><span>Resources</span><span class="kbd">5</span></div>
            <div class="flex justify-between items-center"><span>Timer</span><span class="kbd">6</span></div>
            <div class="flex justify-between items-center"><span>Focus Mode</span><span class="kbd">F</span></div>
            <div class="flex justify-between items-center"><span>Start/Pause Timer</span><span class="kbd">Space</span></div>
            <div class="flex justify-between items-center"><span>Show Shortcuts</span><span class="kbd">?</span></div>
            <div class="flex justify-between items-center"><span>Close Modal</span><span class="kbd">Esc</span></div>
          </div>
          <button onclick="document.getElementById('shortcuts-modal').classList.remove('show')" class="btn btn-primary w-full mt-6">Got it!</button>
        </div>
      `;
    };

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

      if (e.key === 'Escape') {
        hideModal();
        document.getElementById('shortcuts-modal').classList.remove('show');
        if (state.focusMode) exitFocusMode();
        return;
      }
      if (e.key === '?') { showShortcuts(); return; }
      if (e.key === 'f' || e.key === 'F') { state.focusMode ? exitFocusMode() : enterFocusMode(); return; }
      if (e.key === ' ') { e.preventDefault(); state.timerRunning ? pauseTimer() : startTimer(); return; }

      const tabs = ['dashboard', 'study', 'journal', 'scores', 'content', 'resources', 'guide', 'timer'];
      const num = parseInt(e.key);
      if (num >= 1 && num <= 8) {
        state.tab = tabs[num - 1];
        render();
      }
    });

    // ===== HEATMAP =====
    const getHeatmapData = () => {
      const data = [];
      const todayStr = today();
      for (let i = 83; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const ds = d.toISOString().split('T')[0];
        const dayLogs = state.logs.filter(l => l.date === ds);
        const hrs = dayLogs.reduce((s,l) => s+l.hours, 0);
        const categories = {};
        dayLogs.forEach(l => {
          categories[l.category] = (categories[l.category] || 0) + l.hours;
        });
        const isToday = ds === todayStr;
        data.push({ date: ds, day: d.getDay(), hrs, categories, isToday, isStreak: false });
      }
      // Calculate streak: consecutive days meeting daily goal, looking backwards from today
      for (let i = data.length - 1; i >= 0; i--) {
        if (data[i].hrs >= state.dailyGoal) {
          data[i].isStreak = true;
        } else {
          break;
        }
      }
      // Calculate month labels
      const months = [];
      let lastMonth = -1;
      data.forEach((d, idx) => {
        const m = new Date(d.date + 'T12:00:00').getMonth();
        if (m !== lastMonth) {
          const colIndex = Math.floor(idx / 7);
          months.push({ name: new Date(d.date + 'T12:00:00').toLocaleString('en-US', { month: 'short' }), offset: colIndex });
          lastMonth = m;
        }
      });
      return { data, months };
    };

    function showHeatmapTooltip(e, d) {
      const tip = document.getElementById('heatmap-tip');
      if (!tip) return;
      const catBreakdown = d.categories && Object.keys(d.categories).length > 0
        ? Object.entries(d.categories).map(([cat,hrs]) => `<div class="flex justify-between"><span>${cat}</span><span class="font-mono">${hrs.toFixed(1)}h</span></div>`).join('')
        : '<div class="text-[var(--text-muted)]">No study</div>';
      tip.innerHTML = `
        <div class="font-semibold mb-1">${new Date(d.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>
        <div class="font-mono text-lg mb-2 ${d.hrs >= state.dailyGoal ? 'text-[var(--growth)]' : ''}">${d.hrs.toFixed(1)}h</div>
        ${catBreakdown}
      `;
      tip.style.display = 'block';
      const rect = e.target.getBoundingClientRect();
      tip.style.left = (rect.left + rect.width/2 - 75) + 'px';
      tip.style.top = (rect.top - tip.offsetHeight - 8) + 'px';
    }
    function hideHeatmapTooltip() {
      const tip = document.getElementById('heatmap-tip');
      if (tip) tip.style.display = 'none';
    }

    // ===== ICONS =====
    const icon = {
      home: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
      book: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>`,
      chart: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
      grid: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
      folder: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>`,
      clock: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      trophy: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
      plus: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
      trash: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
      download: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
      upload: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
      play: `<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
      pause: `<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`,
      stop: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>`,
      flame: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c1 4-2 6-2 10a4 4 0 0 0 8 0c0-4-3-6-2-10-4 2-4 6-4 6s0-4-4-6c1 4-2 6-2 10a8 8 0 0 0 16 0c0-8-6-10-10-10z"/></svg>`,
      arrow: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>`,
      check: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`,
      target: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
      zap: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
      expand: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>`,
      keyboard: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h12"/></svg>`,
      edit: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`,
      film: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/><line x1="3" y1="12" x2="21" y2="12"/></svg>',
      save: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
      alertTriangle: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      bell: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
      bellOff: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.73 21a2 2 0 0 1-3.46 0"/><path d="M18.63 13A17.89 17.89 0 0 1 18 8"/><path d="M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
      skipForward: '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 4 15 12 5 20 5 4"/><rect x="17" y="4" width="3" height="16" rx="1"/></svg>',
      lightbulb: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>',
      clipboard: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>',
      cardStack: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="12" x="3" y="8" rx="2"/><path d="M7 8V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></svg>',
      videoIcon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2"/></svg>',
      helpCircle: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      coffee: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>'
    };

    // ===== ONBOARDING WIZARD =====
    let wizardStep = 1;
    const wizardData = {
      name: '',
      testDate: '',
      targetScore: 515,
      studyPhase: 'content',
      dailyGoal: 4,
      flName: '',
      flCP: '', flCARS: '', flBB: '', flPS: '',
      hasFL: false
    };

    function wizardNext() {
      if (wizardStep === 1) {
        const inp = document.getElementById('wz-name');
        if (!inp || !inp.value.trim()) return;
        wizardData.name = inp.value.trim();
      }
      if (wizardStep === 2) {
        const d = document.getElementById('wz-date');
        if (!d || !d.value) return;
        wizardData.testDate = d.value;
        const sc = document.getElementById('wz-target');
        if (sc && sc.value) wizardData.targetScore = parseInt(sc.value);
      }
      if (wizardStep < 4) { wizardStep++; renderWizard(); }
    }

    function wizardBack() {
      if (wizardStep > 1) { wizardStep--; renderWizard(); }
    }

    function wizardSetPhase(phase) { wizardData.studyPhase = phase; renderWizard(); }
    function wizardSetGoal(hours) { wizardData.dailyGoal = hours; renderWizard(); }

    function resetStateToDefaults() {
      state.logs = [];
      state.tests = [];
      state.mastery = {};
      state.resources = null;
      state.myResources = [];
      state.achievements = {};
      state.xp = 0;
      state.streak = 0;
      state.lastStudyDate = null;
      state.pomodoroSessionCount = 0;
      state.userName = '';
      state.studyPhase = 'content';
      state.dailyGoal = 4;
      state.testDate = new Date(Date.now() + 90*86400000).toISOString().split('T')[0];
      state.targetScore = 515;
      state.tab = 'dashboard';
      state.section = 'C/P';
      state.yieldFilter = 'all';
      state.contentSort = 'default';
      state.resourceView = 'my';
      state.resourceFilter = 'all';
      state.journal = [];
      state.logSection = null;
      state.logTopics = [];
      state.logTopicSearch = '';
      state.guideSearch = '';
      state.guideExpanded = {};
    }

    function redoSetup() {
      if (!confirm('This will clear all your data and restart the setup wizard. Continue?')) return;
      localStorage.clear();
      resetStateToDefaults();
      wizardStep = 1;
      wizardData.name = '';
      wizardData.testDate = '';
      wizardData.targetScore = 515;
      wizardData.studyPhase = 'content';
      wizardData.dailyGoal = 4;
      wizardData.flName = '';
      wizardData.flCP = '';
      wizardData.flCARS = '';
      wizardData.flBB = '';
      wizardData.flPS = '';
      wizardData.hasFL = false;
      renderWizard();
    }

    function wizardFinish() {
      // Reset to clean slate first
      resetStateToDefaults();

      // Apply wizard choices
      state.userName = wizardData.name;
      state.testDate = wizardData.testDate || new Date(Date.now()+90*86400000).toISOString().split('T')[0];
      state.targetScore = wizardData.targetScore;
      state.studyPhase = wizardData.studyPhase;
      state.dailyGoal = wizardData.dailyGoal;

      // If FL scores entered, add as a test
      if (wizardData.hasFL) {
        const cp = parseInt(wizardData.flCP), cars = parseInt(wizardData.flCARS);
        const bb = parseInt(wizardData.flBB), ps = parseInt(wizardData.flPS);
        if ([cp,cars,bb,ps].every(x => !isNaN(x) && x >= 118 && x <= 132)) {
          state.tests.push({
            id: Date.now(),
            date: new Date().toISOString().split('T')[0],
            name: wizardData.flName || 'Baseline FL',
            cp, cars, bb, ps,
            total: cp + cars + bb + ps
          });
        }
      }

      localStorage.setItem('mcat-onboarded', '1');
      save();
      render();
      checkAchievements();
      setTimeout(() => {
        showToast('You\'re all set, ' + wizardData.name + '. Let\'s get to work.', 'success');
        triggerConfettiV2();
      }, 300);
    }

    function renderWizard() {
      const app = document.getElementById('app');
      const totalSteps = 4;
      const progressDots = Array.from({length:totalSteps}, (_,i) => {
        const n = i+1;
        return `<div class="wizard-dot ${n===wizardStep?'active':n<wizardStep?'done':''}"></div>`;
      }).join('');

      const backBtn = wizardStep > 1 ? `<button onclick="wizardBack()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.82rem;padding:0;margin-bottom:20px;display:flex;align-items:center;gap:4px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>Back</button>` : '';

      let stepHTML = '';

      // ---- STEP 1: Name ----
      if (wizardStep === 1) {
        stepHTML = `
          <div class="wizard-step">
            <div style="margin-bottom:24px">
              <div style="font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--focus);margin-bottom:12px">MCAT Command Center</div>
              <h1 class="wizard-title">Set up your dashboard</h1>
              <p class="wizard-subtitle">Takes 30 seconds. Everything can be changed later.</p>
            </div>
            <label class="wizard-label">Your first name</label>
            <input type="text" id="wz-name" class="wizard-input" placeholder="First name" value="${wizardData.name}" onkeydown="if(event.key==='Enter')wizardNext()" maxlength="30">
            <button onclick="wizardNext()" class="wizard-btn wizard-btn-primary" id="wz-btn1">Continue</button>
          </div>
        `;
      }

      // ---- STEP 2: Test Date ----
      else if (wizardStep === 2) {
        const daysLeft = wizardData.testDate ? Math.ceil((new Date(wizardData.testDate+'T00:00:00') - new Date().setHours(0,0,0,0)) / 86400000) : null;
        stepHTML = `
          <div class="wizard-step">
            <h1 class="wizard-title">Test date and goal score</h1>
            <p class="wizard-subtitle">These drive your countdown, pacing, and progress tracking.</p>
            <label class="wizard-label">When are you testing?</label>
            <input type="date" id="wz-date" class="wizard-input" value="${wizardData.testDate}" onchange="document.getElementById('wz-days').style.display=this.value?'block':'none';document.getElementById('wz-days-n').textContent=Math.ceil((new Date(this.value+'T00:00:00')-new Date().setHours(0,0,0,0))/86400000);document.getElementById('wz-btn2').disabled=!this.value" style="color-scheme:dark" min="${new Date().toISOString().split('T')[0]}">
            <div id="wz-days" style="display:${wizardData.testDate?'block':'none'};text-align:center;margin-top:10px;padding:8px;border-radius:8px;background:var(--bg-elevated);border:1px solid var(--border-subtle);margin-bottom:4px">
              <span id="wz-days-n" style="font-size:1.4rem;font-weight:700;color:var(--focus);font-family:var(--font-mono)">${daysLeft||''}</span>
              <span style="font-size:0.82rem;color:var(--text-muted)"> days away</span>
            </div>
            <div style="margin-top:20px">
              <label class="wizard-label">Target score</label>
              <div style="display:flex;align-items:center;gap:12px">
                <input type="number" id="wz-target" class="wizard-input" min="472" max="528" value="${wizardData.targetScore}" style="max-width:120px;text-align:center;font-weight:600">
                <span style="font-size:0.82rem;color:var(--text-muted)">out of 528</span>
              </div>
            </div>
            <button onclick="wizardNext()" class="wizard-btn wizard-btn-primary" id="wz-btn2" ${wizardData.testDate?'':'disabled'}>Continue</button>
          </div>
        `;
      }

      // ---- STEP 3: Phase + Daily Goal ----
      else if (wizardStep === 3) {
        const phases = [
          { id:'starting', title:'Just Starting', desc:'No content review yet' },
          { id:'content', title:'Content Review', desc:'Working through material' },
          { id:'practice', title:'Practice Phase', desc:'Doing questions and FLs' },
          { id:'final', title:'Final Stretch', desc:'Polishing weak areas' }
        ];
        const goals = [2, 3, 4, 6, 8, 10];
        stepHTML = `
          <div class="wizard-step">
            <h1 class="wizard-title">Where are you in your prep?</h1>
            <p class="wizard-subtitle">This tailors your study suggestions.</p>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px">
              ${phases.map(p => `
                <div class="wizard-card ${wizardData.studyPhase===p.id?'selected':''}" onclick="wizardSetPhase('${p.id}')">
                  <div class="wc-title">${p.title}</div>
                  <div class="wc-desc">${p.desc}</div>
                </div>
              `).join('')}
            </div>
            <label class="wizard-label">Daily study goal (hours)</label>
            <div style="display:flex;gap:8px;justify-content:center;margin-bottom:8px">
              ${goals.map(g => `
                <button onclick="wizardSetGoal(${g})" class="wizard-goal-btn ${wizardData.dailyGoal===g?'selected':''}">${g}h</button>
              `).join('')}
            </div>
            <button onclick="wizardNext()" class="wizard-btn wizard-btn-primary">Continue</button>
          </div>
        `;
      }

      // ---- STEP 4: Optional FL Score + Launch ----
      else if (wizardStep === 4) {
        const sections = [
          { key:'flCP', label:'C/P', color:'#06b6d4' },
          { key:'flCARS', label:'CARS', color:'#f59e0b' },
          { key:'flBB', label:'B/B', color:'#22c55e' },
          { key:'flPS', label:'P/S', color:'#a78bfa' }
        ];
        const anyFilled = [wizardData.flCP, wizardData.flCARS, wizardData.flBB, wizardData.flPS].some(v => v !== '');
        const allFilled = [wizardData.flCP, wizardData.flCARS, wizardData.flBB, wizardData.flPS].every(v => v !== '' && !isNaN(parseInt(v)) && parseInt(v)>=118 && parseInt(v)<=132);
        const total = allFilled ? parseInt(wizardData.flCP)+parseInt(wizardData.flCARS)+parseInt(wizardData.flBB)+parseInt(wizardData.flPS) : null;

        stepHTML = `
          <div class="wizard-step">
            <h1 class="wizard-title">Have a practice FL score?</h1>
            <p class="wizard-subtitle">Optional. If you've taken a full-length, enter it here so your dashboard starts with real data. You can add more later.</p>

            <div style="margin-bottom:16px">
              <label class="wizard-label">Test name</label>
              <input type="text" class="wizard-input" placeholder="e.g. AAMC FL 1, Blueprint FL 3" value="${wizardData.flName}" oninput="wizardData.flName=this.value" style="font-size:0.85rem">
            </div>

            <label class="wizard-label">Section scores (118-132)</label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:8px">
              ${sections.map(s => `
                <div style="text-align:center">
                  <div style="font-size:0.72rem;font-weight:600;color:${s.color};margin-bottom:4px">${s.label}</div>
                  <input type="number" class="wizard-score-input" min="118" max="132" placeholder="--" value="${wizardData[s.key]}" oninput="wizardData.${s.key}=this.value;wizardData.hasFL=true;document.getElementById('wz-total').textContent=[wizardData.flCP,wizardData.flCARS,wizardData.flBB,wizardData.flPS].every(v=>v!==''&&!isNaN(parseInt(v))&&parseInt(v)>=118&&parseInt(v)<=132)?parseInt(wizardData.flCP)+parseInt(wizardData.flCARS)+parseInt(wizardData.flBB)+parseInt(wizardData.flPS):'--'">
                </div>
              `).join('')}
            </div>
            <div style="text-align:center;padding:8px;border-radius:8px;background:var(--bg-elevated);margin-bottom:4px">
              <span style="font-size:0.78rem;color:var(--text-muted)">Total: </span>
              <span id="wz-total" style="font-size:1.1rem;font-weight:700;color:var(--text-primary)">${total || '--'}</span>
            </div>

            <button onclick="wizardFinish()" class="wizard-btn wizard-btn-primary">Launch Dashboard</button>
            ${!anyFilled ? `<button onclick="wizardData.hasFL=false;wizardFinish()" class="wizard-btn wizard-btn-ghost">Skip, I haven't taken one yet</button>` : ''}
            <p style="text-align:center;margin-top:10px;font-size:0.75rem;color:var(--text-muted)">Everything here can be changed in the dashboard.</p>
          </div>
        `;
      }

      app.innerHTML = `
        <div class="wizard-container">
          <div class="wizard-panel">
            ${backBtn}
            ${stepHTML}
            <div class="wizard-progress">${progressDots}</div>
          </div>
        </div>
      `;

      // Step 1: focus + disable button if empty
      if (wizardStep === 1) {
        const inp = document.getElementById('wz-name');
        const btn = document.getElementById('wz-btn1');
        if (inp && btn) {
          inp.focus();
          const check = () => { btn.disabled = !inp.value.trim(); };
          inp.addEventListener('input', check);
          check();
        }
      }
    }

    // ===== RENDER =====
    let lastTab = null;
    function render() {
      // Preserve scroll position
      const mainEl = document.getElementById('main');
      const scrollTop = mainEl ? mainEl.scrollTop : 0;
      const isTabChange = lastTab !== state.tab;
      lastTab = state.tab;

      const level = getLevel();
      const nextLevel = getNextLevel();
      const xpProgress = nextLevel.level > level.level ? ((state.xp - level.xp) / (nextLevel.xp - level.xp)) * 100 : 100;

      const tabs = [
        {id:'dashboard', icon:icon.home, label:'Dashboard'},
        {id:'study', icon:icon.book, label:'Study Log'},
        {id:'journal', icon:icon.edit, label:'Journal'},
        {id:'scores', icon:icon.chart, label:'Scores'},
        {id:'content', icon:icon.grid, label:'Content'},
        {id:'resources', icon:icon.folder, label:'Resources'},
        {id:'guide', icon:icon.helpCircle, label:'Study Guide'},
        {id:'timer', icon:icon.clock, label:'Timer'},
        {id:'achievements', icon:icon.trophy, label:'Achievements'}
      ];

      document.getElementById('app').innerHTML = `
        <aside class="w-64 flex flex-col border-r border-[var(--border-subtle)]" style="background: linear-gradient(180deg, rgba(15,15,21,0.95) 0%, rgba(12,13,16,0.98) 100%); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);">
          <div class="p-5">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[var(--focus)] to-[var(--wisdom)] flex items-center justify-center text-white">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/></svg>
              </div>
              <div>
                <div class="font-bold">MCAT Command</div>
                <div class="text-xs text-[var(--text-muted)]">Your Study Hub</div>
              </div>
            </div>

            <!-- Save File Status -->
            ${supportsFileSystem ? `
              <div class="bg-[var(--bg-base)] rounded-xl p-3 mb-3">
                ${fileHandle ? `
                  <div class="flex items-center gap-2 text-sm">
                    <span class="w-2 h-2 rounded-full bg-[var(--growth)] pulse-dot"></span>
                    <span class="text-[var(--text-secondary)] flex-1">Auto-saving</span>
                    <span id="save-indicator" class="text-xs text-[var(--text-muted)]"></span>
                  </div>
                ` : `
                  <div class="text-xs text-[var(--text-muted)] mb-2">${icon.save} Connect a save file:</div>
                  <button onclick="connectSaveFile()" class="btn btn-primary w-full text-sm py-2 mb-1">New Save File</button>
                  <button onclick="loadSaveFile()" class="btn btn-secondary w-full text-sm py-2">Open Existing</button>
                `}
              </div>
            ` : `
              <div class="bg-[var(--bg-base)] rounded-xl p-3 mb-3 text-xs text-[var(--energy)]">
                ${icon.alertTriangle} Use Chrome/Edge for file saving
              </div>
            `}

            <!-- XP & Level -->
            <div class="bg-[var(--bg-base)] rounded-xl p-3 mb-3">
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-lg">${level.icon || 'üå±'}</span>
                  <span class="level-badge">Lvl ${level.level}</span>
                </div>
                <span class="text-xs text-[var(--text-muted)]">${level.title}</span>
              </div>
              <div class="xp-bar">
                <div class="xp-fill" style="width:${xpProgress}%"></div>
              </div>
              <div class="flex justify-between mt-1 text-xs text-[var(--text-muted)]">
                <span>${state.xp} XP</span>
                <span>${nextLevel.xp} XP</span>
              </div>
            </div>
          </div>

          ${state.streak > 0 ? `
            <div class="mx-4 mb-4">
              <div class="streak-banner">
                <span class="streak-icon">${icon.flame}</span>
                <span>${state.streak} Day Streak!</span>
              </div>
            </div>
          ` : ''}

          <nav class="flex-1 px-3 overflow-y-auto">
            <div style="display:flex;flex-direction:column;gap:2px;background:var(--bg-base);padding:4px;border-radius:14px;border:1px solid var(--border-subtle)">
              ${tabs.map(t => `
                <div onclick="state.tab='${t.id}';render()" class="nav-item ${state.tab===t.id?'active':''}">
                  ${t.icon}<span>${t.label}</span>
                </div>
              `).join('')}
            </div>
          </nav>

          <div class="p-3 border-t border-[var(--border-subtle)] space-y-1">
            <button onclick="exportData()" class="btn btn-ghost w-full justify-start text-sm">${icon.download} Export</button>
            <label class="btn btn-ghost w-full justify-start text-sm cursor-pointer">${icon.upload} Import<input type="file" accept=".json" onchange="importData(event)" class="hidden"></label>
            <button onclick="showShortcuts()" class="btn btn-ghost w-full justify-start text-sm">${icon.keyboard} Shortcuts</button>
            <button onclick="clearAllData()" class="btn btn-ghost w-full justify-start text-sm text-[var(--alert)]">${icon.trash} Clear</button>
            <button onclick="redoSetup()" class="btn btn-ghost w-full justify-start text-sm" style="color:var(--text-muted)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Redo Setup</button>
          </div>
        </aside>

        <main class="flex-1 overflow-auto ${isTabChange ? '' : 'no-animate'}" id="main"></main>
      `;

      const m = document.getElementById('main');

      const renderTabContent = () => {
        if(state.tab==='dashboard') renderDash(m);
        else if(state.tab==='study') renderStudy(m);
        else if(state.tab==='journal') renderJournal(m);
        else if(state.tab==='scores') renderScores(m);
        else if(state.tab==='content') renderContent(m);
        else if(state.tab==='resources') renderResources(m);
        else if(state.tab==='guide') renderGuide(m);
        else if(state.tab==='timer') renderTimer(m);
        else if(state.tab==='achievements') renderAchievements(m);
      };

      if (isTabChange && scrollTop > 0) {
        // Tab changed ‚Äî use crossfade transition
        renderTabContent();
        m.classList.add('tab-enter');
        setTimeout(() => m.classList.remove('tab-enter'), 350);
      } else {
        renderTabContent();
        // Restore scroll for same-tab re-renders
        if (scrollTop > 0) {
          m.scrollTop = scrollTop;
        }
      }

      // Init all effects (delayed for animation frame)
      requestAnimationFrame(() => {
        initTilt();
        initCursorGlow();
        initRipples();
        initMagneticButtons();
        initScrollReveal();
        animateRings();
        document.querySelectorAll('.counter[data-target]').forEach(el => {
          animateCounter(el, parseInt(el.dataset.target));
        });
      });
    }

    // ===== DASHBOARD GREETINGS =====
    function getDashGreeting() {
      const hr = new Date().getHours();
      const name = state.userName || '';
      const days = daysUntil(state.testDate);
      const todayHrs = state.logs.filter(l=>l.date===today()).reduce((s,l)=>s+l.hours,0);
      const streak = state.streak || 0;
      const totalHrs = state.logs.reduce((s,l)=>s+l.hours,0);

      // Time-based greetings
      const timeGreetings = hr < 6 ? [
        'Burning the midnight oil',
        'Late night grind',
        'The early bird catches the 528'
      ] : hr < 12 ? [
        'Good morning',
        'Rise and grind',
        'Fresh start today',
        'Morning, future doctor',
        'New day, new gains'
      ] : hr < 17 ? [
        'Good afternoon',
        'Keep it rolling',
        'Afternoon push',
        'Solid momentum today',
        'Stay locked in'
      ] : hr < 21 ? [
        'Good evening',
        'Evening session',
        'Strong finish tonight',
        'Home stretch for today',
        'One more session'
      ] : [
        'Late night session',
        'Putting in the extra work',
        'Night owl mode',
        'Quiet hours, deep focus'
      ];

      // Contextual subtitles
      const subtitles = [];

      // Streak-based
      if (streak >= 30) subtitles.push(`${streak}-day streak. Absolutely relentless.`);
      else if (streak >= 14) subtitles.push(`${streak} days straight. You are built different.`);
      else if (streak >= 7) subtitles.push(`${streak}-day streak. Keep that fire alive.`);
      else if (streak >= 3) subtitles.push(`${streak} days in a row. Momentum is building.`);

      // Days until test
      if (days <= 7) subtitles.push('Final week. Trust your preparation.');
      else if (days <= 14) subtitles.push('Two weeks out. Time to sharpen everything.');
      else if (days <= 30) subtitles.push('One month left. Every session matters now.');
      else if (days <= 60) subtitles.push('Plenty of time. Stay consistent and you will peak on test day.');

      // Today's progress
      if (todayHrs >= state.dailyGoal) subtitles.push('Daily goal hit. Keep pushing or rest ‚Äî you earned it.');
      else if (todayHrs > 0) subtitles.push(`${todayHrs.toFixed(1)}h logged today. Keep going.`);

      // Hours milestones
      if (totalHrs >= 300) subtitles.push('300+ hours in. The finish line is within reach.');
      else if (totalHrs >= 200) subtitles.push('200+ hours invested. That work will pay off.');
      else if (totalHrs >= 100) subtitles.push('Past the 100-hour mark. Real progress is happening.');

      // General encouragement fallbacks
      subtitles.push(
        "Let's make today count. You've got this.",
        'Small steps compound into big results.',
        'Every hour you put in brings you closer.',
        'Your future patients are worth the effort.',
        'Focus on the process. The score will follow.',
        'You are closer than you think.',
        'Discipline today, freedom tomorrow.',
        'The hard work is what makes the result meaningful.',
        'Trust yourself. You have prepared for this.',
        'One topic at a time. One question at a time.',
        'Comparison is the thief of progress. Run your own race.',
        'You did not come this far to only come this far.',
        'Consistency over intensity. Always.',
        'The MCAT is learnable. You are proving it every day.'
      );

      const greeting = timeGreetings[Math.floor(Math.random() * timeGreetings.length)];
      const subtitle = subtitles[Math.floor(Math.random() * Math.min(subtitles.length, 5))]; // Favor contextual ones

      return {
        title: greeting + (name ? ', ' + name : '') + '.',
        subtitle: subtitle
      };
    }

    // ===== DASHBOARD =====
    function renderDash(el) {
      const days = daysUntil(state.testDate);
      const total = state.logs.reduce((s,l)=>s+l.hours,0);
      const todayHrs = state.logs.filter(l=>l.date===today()).reduce((s,l)=>s+l.hours,0);
      const latest = state.tests[state.tests.length-1];
      const weak = getWeakTopics(4);
      const pct = Math.min(100, (todayHrs/state.dailyGoal)*100);
      const suggestions = getSmartSuggestions();
      const quote = getSmartQuote('dashboard');
      const stats = getStudyStats();
      const greeting = getDashGreeting();

      const heatmapResult = getHeatmapData();
      const heatmap = heatmapResult.data;
      const heatmapMonths = heatmapResult.months;

      // Urgency colors for countdown
      const urgencyColor = days <= 7 ? 'var(--alert)' : days <= 14 ? 'var(--energy)' : days <= 30 ? 'var(--focus)' : 'var(--growth)';
      const urgencyText = days <= 7 ? 'Final week!' : days <= 14 ? 'Two weeks out!' : days <= 30 ? 'One month left' : 'On schedule';

      el.innerHTML = `
        <div class="p-8 max-w-6xl">
          <div class="flex justify-between items-start mb-8 animate-in">
            <div>
              <h1 class="text-2xl font-bold mb-1">${greeting.title}</h1>
              <p class="text-[var(--text-muted)]">${greeting.subtitle}</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="px-4 py-2 rounded-xl text-sm font-semibold ${stats.isOnTrack ? 'bg-[var(--growth)]' : 'bg-[var(--energy)]'}" style="color:#000">
                ${stats.isOnTrack ? '‚úì On Track' : '‚ö† Behind Pace'}
              </div>
              ${stats.recommendedPerDay > 0 ? `
                <div class="text-right">
                  <div class="text-sm text-[var(--text-muted)]">Recommended today</div>
                  <div class="font-bold">${stats.recommendedPerDay.toFixed(1)}h</div>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="grid grid-cols-4 gap-5 mb-8 stagger-children">
            <div class="glow-card glow-blue p-5 tilt-card animate-in delay-1 dash-stat-card" style="--card-glow: var(--cp)">
              <div class="stat-label mb-3">Days Until Test</div>
              <div class="stat-value counter" style="color:${urgencyColor}" data-target="${days}">${days}</div>
              <div class="text-xs font-semibold mt-2" style="color:${urgencyColor}">${urgencyText}</div>
              <input type="date" value="${state.testDate}" onchange="state.testDate=this.value;save();render()" class="input mt-3 text-sm">
            </div>
            <div class="glow-card glow-green p-5 tilt-card animate-in delay-2 dash-stat-card" style="--card-glow: var(--growth)">
              <div class="stat-label mb-3">Target Score</div>
              <div class="stat-value text-[var(--growth)] counter" data-target="${state.targetScore}">${state.targetScore}</div>
              <div class="text-sm text-[var(--text-muted)] mt-2">${getPercentile(state.targetScore)}th percentile</div>
              <input type="number" min="472" max="528" value="${state.targetScore}" onchange="state.targetScore=parseInt(this.value);save();render()" class="input mt-3 text-sm">
            </div>
            <div class="glow-card glow-purple p-5 tilt-card animate-in delay-3 dash-stat-card" style="--card-glow: var(--wisdom)">
              <div class="stat-label mb-3">Hours Studied</div>
              <div class="stat-value text-[var(--wisdom)] counter" data-target="${Math.round(total)}">${Math.round(total)}</div>
              <div class="text-sm text-[var(--text-muted)] mt-2">${Math.round(stats.progressPercent)}% of recommended 350h</div>
              <div class="progress-track mt-3 h-2">
                <div class="progress-fill" style="width:${stats.progressPercent}%;background:var(--wisdom)"></div>
              </div>
            </div>
            <div class="glow-card glow-amber p-5 tilt-card animate-in delay-4 dash-stat-card" style="--card-glow: var(--energy)">
              <div class="stat-label mb-3">Latest Score</div>
              <div class="stat-value ${latest&&latest.total>=state.targetScore?'text-[var(--growth)]':'text-[var(--energy)]'} counter" data-target="${latest?latest.total:0}">${latest?latest.total:'‚Äî'}</div>
              <div class="text-sm text-[var(--text-muted)] mt-2">${latest?getPercentile(latest.total)+'th %ile':'Take a practice test'}</div>
            </div>
          </div>

          <!-- Smart Suggestions -->
          ${suggestions.length ? `
            <div class="card p-5 mb-8 reveal">
              <div class="flex items-center gap-2 mb-4">
                <span class="text-[var(--energy)]">${icon.zap}</span>
                <span class="font-semibold">Smart Suggestions</span>
              </div>
              <div class="grid grid-cols-2 gap-3">
                ${suggestions.map(s => `
                  <div class="bg-[var(--bg-base)] rounded-lg p-4 flex items-center gap-3"${s.type==='fl-weak'?' style="border-left:2px solid var(--alert)"':''}>
                    <div class="w-2 h-2 rounded-full flex-shrink-0 ${s.type === 'weak' || s.type === 'fl-weak' ? 'bg-[var(--alert)]' : s.type === 'review' ? 'bg-[var(--wisdom)]' : 'bg-[var(--energy)]'}"></div>
                    <span class="text-sm">${s.msg}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <div class="grid grid-cols-3 gap-6 mb-8 stagger-reveal">
            <!-- Today's Progress with Ring -->
            <div class="card p-6 reveal">
              <div class="stat-label mb-4">Today's Progress</div>
              <div class="flex items-center gap-6">
                <div class="relative">
                  <svg width="100" height="100" viewBox="0 0 100 100" class="progress-ring">
                    <circle cx="50" cy="50" r="45" stroke="var(--bg-base)" stroke-width="8" fill="none"/>
                    <circle cx="50" cy="50" r="45" stroke="${pct >= 100 ? 'var(--growth)' : 'var(--focus)'}" stroke-width="8" fill="none"
                      stroke-dasharray="${2 * Math.PI * 45}"
                      stroke-dashoffset="${2 * Math.PI * 45 * (1 - pct/100)}"
                      stroke-linecap="round" class="progress-ring-circle"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-2xl font-bold ${pct>=100?'text-[var(--growth)]':''}">${Math.round(pct)}%</span>
                  </div>
                </div>
                <div>
                  <div class="text-3xl font-bold font-mono">${todayHrs.toFixed(1)}h</div>
                  <div class="text-sm text-[var(--text-muted)]">of ${state.dailyGoal}h goal</div>
                  <div class="flex gap-2 mt-3">
                    <button onclick="state.dailyGoal=Math.max(1,state.dailyGoal-0.5);save();render()" class="btn btn-ghost text-xs px-2 py-1">‚àí0.5h</button>
                    <button onclick="state.dailyGoal=Math.min(12,state.dailyGoal+0.5);save();render()" class="btn btn-ghost text-xs px-2 py-1">+0.5h</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Study Heatmap -->
            <div class="card p-6 col-span-2 reveal">
              <div class="flex justify-between items-center mb-4">
                <span class="stat-label">12-Week Study Heatmap</span>
                <span class="text-sm text-[var(--text-secondary)]">${heatmap.reduce((s,x)=>s+x.hrs,0).toFixed(0)}h total</span>
              </div>
              <!-- Month labels -->
              <div style="display:grid;grid-template-columns:20px repeat(12,1fr);gap:1px;margin-bottom:4px;">
                <div></div>
                ${(() => {
                  const cols = Array(12).fill('');
                  heatmapMonths.forEach(m => { if (m.offset < 12) cols[m.offset] = m.name; });
                  return cols.map(label => `<div class="text-xs text-[var(--text-muted)]" style="text-align:center;">${label}</div>`).join('');
                })()}
              </div>
              <!-- Heatmap grid with day labels -->
              <div style="display:grid;grid-template-columns:20px repeat(12,1fr);grid-template-rows:repeat(7,1fr);gap:1px;grid-auto-flow:column;">
                ${(() => {
                  const dayLabels = ['', 'M', '', 'W', '', 'F', ''];
                  const numCols = 12;
                  const colors = [
                    'var(--bg-base)',
                    'rgba(139,92,246,0.2)',
                    'rgba(139,92,246,0.4)',
                    'rgba(99,102,241,0.5)',
                    'rgba(52,211,153,0.4)',
                    'rgba(52,211,153,0.7)',
                    'var(--growth)'
                  ];
                  let cells = '';
                  // Day labels column
                  for (let row = 0; row < 7; row++) {
                    cells += '<div class="text-xs text-[var(--text-muted)] flex items-center justify-center" style="width:20px;height:14px;">' + dayLabels[row] + '</div>';
                  }
                  // Data columns
                  for (let col = 0; col < numCols; col++) {
                    for (let row = 0; row < 7; row++) {
                      const idx = col * 7 + row;
                      if (idx < heatmap.length) {
                        const d = heatmap[idx];
                        const g = state.dailyGoal;
                        const intensity = d.hrs === 0 ? 0 : d.hrs < g*0.15 ? 1 : d.hrs < g*0.3 ? 2 : d.hrs < g*0.5 ? 3 : d.hrs < g*0.75 ? 4 : d.hrs < g ? 5 : 6;
                        const cls = 'heatmap-cell' + (d.isToday ? ' today' : '') + (d.isStreak ? ' streak' : '');
                        cells += '<div class="' + cls + '" style="background:' + colors[intensity] + '" onmouseenter="showHeatmapTooltip(event,' + JSON.stringify(d).replace(/"/g, '&quot;') + ')" onmouseleave="hideHeatmapTooltip()"></div>';
                      } else {
                        cells += '<div style="width:14px;height:14px;"></div>';
                      }
                    }
                  }
                  return cells;
                })()}
              </div>
              <!-- Legend -->
              <div class="flex justify-end gap-2 mt-3 text-xs text-[var(--text-muted)] items-center flex-wrap">
                <span>0h</span>
                <div class="heatmap-cell" style="background:var(--bg-base)"></div>
                <span>0.5h</span>
                <div class="heatmap-cell" style="background:rgba(139,92,246,0.2)"></div>
                <span>1h</span>
                <div class="heatmap-cell" style="background:rgba(139,92,246,0.4)"></div>
                <span>2h</span>
                <div class="heatmap-cell" style="background:rgba(99,102,241,0.5)"></div>
                <span>3h</span>
                <div class="heatmap-cell" style="background:rgba(52,211,153,0.4)"></div>
                <span>4h</span>
                <div class="heatmap-cell" style="background:rgba(52,211,153,0.7)"></div>
                <span>${state.dailyGoal}h+</span>
                <div class="heatmap-cell" style="background:var(--growth)"></div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-6 mb-8 stagger-reveal">
            <div class="card p-6 reveal">
              <div class="stat-label mb-4">Section Mastery</div>
              <div class="space-y-4">
                ${Object.keys(SECTIONS).map(s => {
                  const avg = Math.round(SECTIONS[s].topics.reduce((sum,t)=>sum+(state.mastery[s+'-'+t]||0),0)/SECTIONS[s].topics.length);
                  return `
                    <div class="group cursor-pointer" onclick="state.tab='content';state.section='${s}';render()">
                      <div class="flex justify-between mb-2">
                        <span class="text-sm group-hover:text-[var(--text-primary)] transition-colors">${SECTIONS[s].name}</span>
                        <span class="font-mono text-sm" style="color:${SECTIONS[s].color}">${avg}%</span>
                      </div>
                      <div class="progress-track">
                        <div class="progress-fill" style="width:${avg}%;background:${SECTIONS[s].color}"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <div class="card p-6 reveal">
              <div class="flex justify-between items-center mb-4">
                <span class="stat-label">Focus Areas</span>
                <span class="text-xs" style="color:${YIELD.h.color}">${weak.filter(w=>w.yield==='h').length ? '\u{1F525} ' + weak.filter(w=>w.yield==='h').length + ' high-yield' : 'Yield-prioritized'}</span>
              </div>
              ${weak.length ? `
                <div class="space-y-2">
                  ${weak.map(w => `
                    <div class="focus-item list-item p-3 flex items-center gap-3" onclick="state.tab='content';state.section='${w.section}';state.yieldFilter='all';render()" ${w.yield==='h'?`style="border-left:3px solid ${YIELD.h.color}"`:''}>
                      <div class="w-2 h-2 rounded-full" style="background:${SECTIONS[w.section].color}"></div>
                      ${w.yield==='h'?`<span style="background:${YIELD.h.bg};color:${YIELD.h.color};padding:1px 5px;border-radius:3px;font-size:0.6rem;font-weight:700">HY</span>`:''}
                      <div class="flex-1 min-w-0">
                        <div class="text-sm truncate">${w.topic}</div>
                        <div class="text-xs text-[var(--text-muted)]">${SECTIONS[w.section].name}</div>
                      </div>
                      <span class="font-mono text-sm ${w.val<25?'text-[var(--alert)]':w.val<50?'text-[var(--energy)]':'text-[var(--text-secondary)]'}">${w.val}%</span>
                      <span class="focus-arrow text-[var(--text-muted)]">${icon.arrow}</span>
                    </div>
                  `).join('')}
                </div>
              ` : `<div class="text-center py-8 text-[var(--growth)]">${icon.check}<p class="mt-2 text-sm">All topics above 75%!</p></div>`}
            </div>
          </div>

          <!-- Journal Widget -->
          <div class="card p-5 mb-8 reveal cursor-pointer hover-lift" onclick="state.tab='journal';render()" style="border-left:3px solid var(--focus)">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:rgba(8,145,178,0.15);color:var(--focus)">
                ${icon.edit}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-0.5">
                  <span class="text-sm font-semibold">Today's Journal</span>
                  <span class="text-xs text-[var(--text-muted)]">${state.journal.length} entries total</span>
                </div>
                ${(() => {
                  const todayEntry = state.journal.find(j => j.date === today());
                  return todayEntry
                    ? `<p class="text-xs text-[var(--text-secondary)] truncate">${todayEntry.text.replace(/</g,'&lt;').substring(0, 80)}${todayEntry.text.length > 80 ? '...' : ''}</p>`
                    : `<p class="text-xs text-[var(--text-muted)]">Write something about your prep today...</p>`;
                })()}
              </div>
              <span class="text-[var(--text-muted)]">${icon.arrow}</span>
            </div>
          </div>

          <!-- Motivational Quote -->
          <div class="quote-card reveal">
            <p class="text-lg mb-2">"${quote.text}"</p>
            <p class="text-sm text-[var(--text-muted)]">‚Äî ${quote.author}</p>
          </div>
        </div>
      `;
    }

    // ===== JOURNAL TAB =====
    function renderJournal(el) {
      const journalQuote = getSmartQuote('motivation');
      const todayEntry = state.journal.find(j => j.date === today());
      const entriesThisWeek = state.journal.filter(j => new Date(j.date+'T00:00:00') > new Date(Date.now() - 7*86400000)).length;

      // Calculate writing streak
      let writeStreak = 0;
      const sortedDates = [...new Set(state.journal.map(j => j.date))].sort().reverse();
      if (sortedDates.length) {
        const d = new Date();
        for (let i = 0; i < 365; i++) {
          const ds = d.toISOString().split('T')[0];
          if (sortedDates.includes(ds)) { writeStreak++; d.setDate(d.getDate()-1); }
          else if (i === 0) { d.setDate(d.getDate()-1); continue; } // grace for today
          else break;
        }
      }

      // Group entries by month
      const grouped = {};
      state.journal.slice().reverse().forEach(j => {
        const d = new Date(j.date + 'T00:00:00');
        const key = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(j);
      });

      el.innerHTML = `
        <div class="p-8 max-w-3xl mx-auto animate-in">
          <div class="flex justify-between items-start mb-8">
            <div>
              <h1 class="text-2xl font-bold mb-1">Journal</h1>
              <p class="text-[var(--text-muted)]">A private space to reflect on your MCAT journey</p>
            </div>
            <div class="flex gap-4 text-center">
              <div>
                <div class="text-lg font-bold text-[var(--focus)]">${state.journal.length}</div>
                <div class="text-xs text-[var(--text-muted)]">Entries</div>
              </div>
              <div>
                <div class="text-lg font-bold text-[var(--growth)]">${writeStreak}</div>
                <div class="text-xs text-[var(--text-muted)]">Day Streak</div>
              </div>
              <div>
                <div class="text-lg font-bold text-[var(--wisdom)]">${entriesThisWeek}</div>
                <div class="text-xs text-[var(--text-muted)]">This Week</div>
              </div>
            </div>
          </div>

          <!-- Today's Entry -->
          <div class="card p-6 mb-8" style="border-left:3px solid var(--focus)">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-sm font-semibold">${todayEntry ? "Today's Entry" : "What's on your mind?"}</span>
              <span class="text-xs px-2 py-0.5 rounded-full" style="background:rgba(8,145,178,0.15);color:var(--focus)">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</span>
            </div>
            <textarea id="journal-input" rows="5" placeholder="How was studying today? What went well? What felt hard? Just let it out..." class="input w-full text-sm resize-none mb-3" style="background:var(--surface-2);border-color:var(--border-subtle);line-height:1.8;min-height:120px" onblur="autoSaveJournal()">${todayEntry ? todayEntry.text : ''}</textarea>
            <div class="flex items-center justify-between">
              <button onclick="addJournalEntry()" class="btn btn-primary text-sm px-5 py-2">${icon.plus} Save Entry</button>
              <span class="text-xs text-[var(--text-muted)]" id="journal-save-status"></span>
            </div>
          </div>

          <!-- Past Entries -->
          ${state.journal.length > 0 ? `
            <div class="mb-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-sm text-[var(--text-secondary)]">Past Entries</h2>
                <span class="text-xs text-[var(--text-muted)]">${state.journal.length} total</span>
              </div>
              <div class="space-y-6">
                ${Object.entries(grouped).map(([month, entries]) => `
                  <div>
                    <div class="text-xs font-semibold text-[var(--text-muted)] uppercase tracking-wider mb-3 pl-1">${month}</div>
                    <div class="space-y-3">
                      ${entries.map(j => {
                        const isToday = j.date === today();
                        const dayName = new Date(j.date+'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' });
                        const dayNum = new Date(j.date+'T00:00:00').getDate();
                        const preview = j.text.length > 150 ? j.text.substring(0, 150) + '...' : j.text;
                        return `
                          <div class="card p-4 transition-all hover-lift group" style="${isToday ? 'border-left:3px solid var(--focus)' : ''}">
                            <div class="flex gap-4">
                              <div class="text-center flex-shrink-0" style="min-width:40px">
                                <div class="text-xs text-[var(--text-muted)]">${dayName}</div>
                                <div class="text-lg font-bold ${isToday ? 'text-[var(--focus)]' : 'text-[var(--text-secondary)]'}">${dayNum}</div>
                              </div>
                              <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                  ${isToday ? '<span class="text-xs font-semibold px-2 py-0.5 rounded-full" style="background:rgba(8,145,178,0.15);color:var(--focus)">Today</span>' : ''}
                                  <span class="text-xs text-[var(--text-muted)]">${formatDate(j.date)}</span>
                                </div>
                                <div id="journal-entry-${j.id}" class="text-sm text-[var(--text-secondary)] leading-relaxed">
                                  <p class="journal-entry-text cursor-pointer" onclick="toggleJournalExpand(${j.id})">${preview.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}</p>
                                </div>
                              </div>
                              <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                <button onclick="editJournalEntry(${j.id})" class="text-[var(--text-muted)] hover:text-[var(--focus)] transition-colors p-1" title="Edit">${icon.edit}</button>
                                <button onclick="deleteJournalEntry(${j.id})" class="delete-btn text-[var(--text-muted)] p-1" title="Delete">${icon.trash}</button>
                              </div>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : `
            <div class="card p-12 text-center">
              <div class="text-4xl mb-4 opacity-50">${icon.edit}</div>
              <h3 class="text-lg font-semibold mb-2">Start Your Journal</h3>
              <p class="text-sm text-[var(--text-muted)] max-w-md mx-auto">Writing about your prep helps process emotions, track your mindset, and stay grounded. Even a few sentences each day makes a difference.</p>
            </div>
          `}

          <div class="quote-card mt-8 reveal" style="border-left:2px solid var(--focus)">
            <p class="text-sm mb-1">"${journalQuote.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${journalQuote.author}</p>
          </div>
        </div>
      `;
    }

    function toggleJournalExpand(id) {
      const entry = state.journal.find(j => j.id === id);
      if (!entry) return;
      const container = document.getElementById('journal-entry-' + id);
      if (!container) return;
      const textEl = container.querySelector('.journal-entry-text');
      if (!textEl) return;
      const isExpanded = textEl.dataset.expanded === 'true';
      if (isExpanded) {
        const preview = entry.text.length > 150 ? entry.text.substring(0, 150) + '...' : entry.text;
        textEl.innerHTML = preview.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
        textEl.dataset.expanded = 'false';
      } else {
        textEl.innerHTML = entry.text.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
        textEl.dataset.expanded = 'true';
      }
    }

    function editJournalEntry(id) {
      const entry = state.journal.find(j => j.id === id);
      if (!entry) return;
      showModal(`
        <div class="card p-6" style="width:500px;max-height:80vh">
          <h3 class="font-semibold text-lg mb-2">Edit Journal Entry</h3>
          <p class="text-xs text-[var(--text-muted)] mb-4">${formatDate(entry.date)}</p>
          <textarea id="edit-journal-text" rows="8" class="input w-full text-sm resize-none mb-4" style="line-height:1.8;min-height:160px">${entry.text}</textarea>
          <div class="flex gap-3">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="saveEditJournal(${id})" class="btn btn-primary flex-1">Save Changes</button>
          </div>
        </div>
      `);
    }

    function saveEditJournal(id) {
      const entry = state.journal.find(j => j.id === id);
      if (!entry) return;
      const text = document.getElementById('edit-journal-text').value.trim();
      if (!text) { showToast('Entry cannot be empty', 'error'); return; }
      entry.text = text;
      entry.updatedAt = Date.now();
      save();
      hideModal();
      render();
      showToast('Journal entry updated');
    }

    function addJournalEntry() {
      const input = document.getElementById('journal-input');
      if (!input) return;
      const text = input.value.trim();
      if (!text) { showToast('Write something first!', 'error'); return; }
      // Check if there's already an entry for today ‚Äî update it
      const existing = state.journal.find(j => j.date === today());
      if (existing) {
        existing.text = text;
        existing.updatedAt = Date.now();
      } else {
        state.journal.push({ id: Date.now(), date: today(), text, createdAt: Date.now() });
      }
      save();
      render();
      showToast('Journal entry saved');
    }

    function autoSaveJournal() {
      const input = document.getElementById('journal-input');
      if (!input) return;
      const text = input.value.trim();
      if (!text) return;
      const existing = state.journal.find(j => j.date === today());
      if (existing) {
        existing.text = text;
        existing.updatedAt = Date.now();
      } else {
        state.journal.push({ id: Date.now(), date: today(), text, createdAt: Date.now() });
      }
      save();
      const status = document.getElementById('journal-save-status');
      if (status) {
        status.textContent = 'Auto-saved';
        setTimeout(() => { if(status) status.textContent = ''; }, 2000);
      }
    }

    function deleteJournalEntry(id) {
      if (!confirm('Delete this journal entry?')) return;
      state.journal = state.journal.filter(j => j.id !== id);
      save();
      render();
      showToast('Entry deleted');
    }

    // ===== STUDY LOG =====
    function renderStudy(el) {
      const t = today();
      const todayH = state.logs.filter(l=>l.date===t).reduce((s,l)=>s+l.hours,0);
      const weekH = state.logs.filter(l=>new Date(l.date+'T00:00:00')>new Date(Date.now()-7*86400000)).reduce((s,l)=>s+l.hours,0);
      const totalH = state.logs.reduce((s,l)=>s+l.hours,0);
      const cats = ['Content Review','Practice Questions','Full Length','Anki','CARS Practice','Review','Videos','Other'];
      const studyTip = getSmartQuote('study');

      el.innerHTML = `
        <div class="p-8 max-w-5xl animate-in">
          <h1 class="text-2xl font-bold mb-6">Study Log</h1>

          <div class="grid grid-cols-3 gap-5 mb-8">
            <div class="glow-card glow-blue p-5 tilt-card">
              <div class="stat-label mb-2">Today</div>
              <div class="stat-value text-[var(--focus)] counter" data-target="${Math.round(todayH*10)/10}">${todayH.toFixed(1)}h</div>
            </div>
            <div class="glow-card glow-purple p-5 tilt-card">
              <div class="stat-label mb-2">This Week</div>
              <div class="stat-value text-[var(--wisdom)] counter" data-target="${Math.round(weekH)}">${weekH.toFixed(1)}h</div>
            </div>
            <div class="glow-card glow-green p-5 tilt-card">
              <div class="stat-label mb-2">All Time</div>
              <div class="stat-value text-[var(--growth)] counter" data-target="${Math.round(totalH)}">${totalH.toFixed(1)}h</div>
            </div>
          </div>

          <div class="card p-6 mb-8">
            <h2 class="font-semibold mb-4">Log a Session</h2>
            <div class="grid grid-cols-5 gap-4 mb-4">
              <div><label class="stat-label block mb-2">Date</label><input type="date" id="log-date" value="${t}" class="input"></div>
              <div><label class="stat-label block mb-2">Category</label><select id="log-cat" class="input">${cats.map(c=>`<option>${c}</option>`).join('')}</select></div>
              <div><label class="stat-label block mb-2">Hours</label><input type="number" id="log-hrs" min="0.25" step="0.25" value="1" class="input"></div>
              <div><label class="stat-label block mb-2">Notes</label><input type="text" id="log-notes" placeholder="Optional" class="input"></div>
              <div class="flex items-end"><button onclick="addLog()" class="btn btn-primary w-full">${icon.plus} Add</button></div>
            </div>

            <!-- Section Pills -->
            <div class="mb-3">
              <label class="stat-label block mb-2">Section Studied <span class="text-[var(--text-muted)] font-normal">(optional)</span></label>
              <div class="flex gap-2 flex-wrap">
                <button onclick="setLogSection(null)" class="px-3 py-1.5 rounded-full text-xs font-semibold transition-all ${!state.logSection ? 'bg-[var(--surface-2)] text-[var(--text-primary)] ring-1 ring-[var(--border-subtle)]' : 'text-[var(--text-muted)] hover:text-[var(--text-secondary)]'}" style="${!state.logSection ? 'box-shadow:0 0 8px rgba(255,255,255,0.05)' : ''}">None</button>
                ${Object.keys(SECTIONS).map(s => `
                  <button onclick="setLogSection('${s}')" class="px-3 py-1.5 rounded-full text-xs font-semibold transition-all" style="${state.logSection===s ? `background:${SECTIONS[s].color}20;color:${SECTIONS[s].color};box-shadow:0 0 12px ${SECTIONS[s].color}30;ring:1px solid ${SECTIONS[s].color}` : `color:var(--text-muted)`}">
                    <span class="inline-block w-2 h-2 rounded-full mr-1" style="background:${SECTIONS[s].color}"></span>${s}
                  </button>
                `).join('')}
              </div>
            </div>

            <!-- Topic Checklist (shown when section selected) -->
            ${state.logSection ? `
              <div class="mt-3 p-4 rounded-xl" style="background:var(--surface-2);border:1px solid var(--border-subtle)">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-sm font-medium" style="color:${SECTIONS[state.logSection].color}">${SECTIONS[state.logSection].name} Topics</span>
                  <span class="text-xs text-[var(--text-muted)]">${state.logTopics.length} selected</span>
                </div>
                <input type="text" id="log-topic-search" value="${state.logTopicSearch}" oninput="state.logTopicSearch=this.value;render()" placeholder="Search topics..." class="input mb-3 text-sm" style="background:var(--bg);border-color:var(--border-subtle)">
                <div class="space-y-1 max-h-[200px] overflow-y-auto pr-1" style="scrollbar-width:thin">
                  ${(() => {
                    const search = state.logTopicSearch.toLowerCase();
                    const topics = SECTIONS[state.logSection].topics.filter(t => !search || t.toLowerCase().includes(search));
                    if (!topics.length) return '<div class="text-xs text-[var(--text-muted)] text-center py-3">No topics match your search</div>';
                    return topics.map(t => {
                      const y = getYield(t);
                      const checked = state.logTopics.includes(t);
                      return `
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded-lg cursor-pointer transition-colors ${checked ? 'bg-[var(--surface-3)]' : 'hover:bg-[var(--surface-3)]'}">
                          <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleLogTopic('${t.replace(/'/g, "\\'")}')" class="accent-[${SECTIONS[state.logSection].color}]" style="accent-color:${SECTIONS[state.logSection].color}">
                          <span class="text-sm flex-1 ${checked ? 'text-[var(--text-primary)]' : 'text-[var(--text-secondary)]'}">${t}</span>
                          <span class="text-[0.6rem] font-bold px-1.5 py-0.5 rounded" style="background:${YIELD[y].bg};color:${YIELD[y].color}">${YIELD[y].label}</span>
                        </label>
                      `;
                    }).join('');
                  })()}
                </div>
              </div>
            ` : ''}
          </div>

          <div class="card overflow-hidden reveal">
            <div class="glass-header flex justify-between items-center">
              <h2 class="font-semibold text-sm">Recent Sessions</h2>
              <span class="text-xs text-[var(--text-muted)]">${state.logs.length} entries</span>
            </div>
            <div class="max-h-[500px] overflow-y-auto glass-list">
              ${state.logs.slice().reverse().slice(0,30).map((l, idx) => `
                <div class="table-row" style="display:flex;gap:12px;align-items:center;animation-delay:${idx * 25}ms">
                  <span class="text-xs text-[var(--text-muted)] font-medium" style="min-width:70px">${formatDate(l.date)}</span>
                  ${l.section ? `<span class="flex items-center gap-1 text-xs font-bold px-2 py-0.5 rounded-full" style="background:${SECTIONS[l.section].color}15;color:${SECTIONS[l.section].color};min-width:40px"><span class="w-1.5 h-1.5 rounded-full" style="background:${SECTIONS[l.section].color}"></span>${l.section}</span>` : ''}
                  <span class="text-sm font-medium text-[var(--text-secondary)]" style="min-width:110px">${l.category}</span>
                  <span class="font-mono text-sm font-semibold text-[var(--text-primary)]" style="min-width:40px">${l.hours}h</span>
                  ${l.topics && l.topics.length ? `<span class="text-xs px-2 py-0.5 rounded-full cursor-pointer hover:opacity-80 transition-opacity" style="background:var(--surface-3);color:var(--text-secondary)" onclick="event.stopPropagation();this.nextElementSibling.classList.toggle('hidden')" title="${l.topics.join(', ')}">${l.topics.length} topic${l.topics.length>1?'s':''}</span><span class="hidden text-xs text-[var(--text-muted)] max-w-[200px] truncate">${l.topics.slice(0,3).join(', ')}${l.topics.length>3?'...':''}</span>` : ''}
                  <span class="text-sm text-[var(--text-muted)] flex-1 truncate">${l.notes||'‚Äî'}</span>
                  <button onclick="editLog(${l.id})" class="text-[var(--text-muted)] hover:text-[var(--focus)] transition-colors" style="flex-shrink:0" title="Edit">${icon.edit}</button>
                  <button onclick="delLog(${l.id})" class="delete-btn text-[var(--text-muted)]" style="flex-shrink:0">${icon.trash}</button>
                </div>
              `).join('') || '<div class="empty-state"><div class="empty-icon"><span style="display:inline-block;width:40px;height:40px;opacity:0.5">' + icon.book + '</span></div><div>No sessions logged yet</div><div class="text-sm mt-2 opacity-70">Start tracking your study time!</div></div>'}
            </div>
          </div>

          <div class="quote-card mt-8 reveal" style="border-left:2px solid var(--focus)">
            <p class="text-sm mb-1">"${studyTip.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${studyTip.author}</p>
          </div>
        </div>
      `;
    }

    function setLogSection(s) {
      state.logSection = s;
      state.logTopics = [];
      state.logTopicSearch = '';
      render();
    }

    function toggleLogTopic(topic) {
      const idx = state.logTopics.indexOf(topic);
      if (idx > -1) state.logTopics.splice(idx, 1);
      else state.logTopics.push(topic);
      render();
    }

    function addLog() {
      const date = document.getElementById('log-date').value;
      const category = document.getElementById('log-cat').value;
      const hours = parseFloat(document.getElementById('log-hrs').value) || 0;
      const notes = document.getElementById('log-notes').value.trim();
      if(!date || hours<=0 || hours>24) { showToast('Check your input','error'); return; }
      const entry = {id:Date.now(), date, category, hours, notes};
      if (state.logSection) {
        entry.section = state.logSection;
        entry.topics = [...state.logTopics];
        // Auto-bump mastery: if they studied a topic, at least mark it as "Introduced" (25)
        entry.topics.forEach(t => {
          const key = state.logSection + '-' + t;
          if ((state.mastery[key] || 0) < 25) {
            state.mastery[key] = 25;
          }
        });
      }
      state.logs.push(entry);
      // Reset form state
      state.logSection = null;
      state.logTopics = [];
      state.logTopicSearch = '';
      updateStreak();
      save();
      render();
      addXP(Math.round(hours * 30), `${hours}h study logged`);
      checkAchievements();
      if (hours >= state.dailyGoal) triggerConfetti();
      const topicMsg = entry.topics && entry.topics.length ? ` (${entry.topics.length} topics)` : '';
      showToast(`Logged ${hours}h of ${category}${topicMsg}`);
    }

    function editLog(id) {
      const l = state.logs.find(x => x.id === id);
      if (!l) return;
      const cats = ['Content Review','Practice Questions','Full Length','Anki','CARS Practice','Review','Videos','Other'];
      // Store edit state temporarily
      window._editLogSection = l.section || null;
      window._editLogTopics = l.topics ? [...l.topics] : [];
      showModal(`
        <div class="card p-6" style="width:450px;max-height:80vh;overflow-y:auto">
          <h3 class="font-semibold text-lg mb-4">Edit Session</h3>
          <div class="space-y-4">
            <div>
              <label class="stat-label block mb-2">Date</label>
              <input type="date" id="edit-log-date" value="${l.date}" class="input">
            </div>
            <div>
              <label class="stat-label block mb-2">Category</label>
              <select id="edit-log-cat" class="input">${cats.map(c=>`<option ${l.category===c?'selected':''}>${c}</option>`).join('')}</select>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="stat-label block mb-2">Hours</label>
                <input type="number" id="edit-log-hrs" min="0.25" step="0.25" value="${l.hours}" class="input">
              </div>
              <div>
                <label class="stat-label block mb-2">Notes</label>
                <input type="text" id="edit-log-notes" value="${l.notes||''}" placeholder="Optional" class="input">
              </div>
            </div>
            <div>
              <label class="stat-label block mb-2">Section</label>
              <div class="flex gap-2 flex-wrap" id="edit-section-pills">
                <button onclick="window._editLogSection=null;window._editLogTopics=[];document.getElementById('edit-topic-area').innerHTML='';this.parentElement.querySelectorAll('button').forEach(b=>b.style.cssText='color:var(--text-muted)');this.style.cssText='background:var(--surface-2);color:var(--text-primary)'" class="px-3 py-1 rounded-full text-xs font-semibold" style="${!l.section ? 'background:var(--surface-2);color:var(--text-primary)' : 'color:var(--text-muted)'}">None</button>
                ${Object.keys(SECTIONS).map(s => `
                  <button onclick="window._editLogSection='${s}';window._editLogTopics=[];renderEditTopics('${s}');this.parentElement.querySelectorAll('button').forEach(b=>b.style.cssText='color:var(--text-muted)');this.style.cssText='background:${SECTIONS[s].color}20;color:${SECTIONS[s].color}'" class="px-3 py-1 rounded-full text-xs font-semibold" style="${l.section===s ? `background:${SECTIONS[s].color}20;color:${SECTIONS[s].color}` : 'color:var(--text-muted)'}">
                    <span class="inline-block w-2 h-2 rounded-full mr-1" style="background:${SECTIONS[s].color}"></span>${s}
                  </button>
                `).join('')}
              </div>
            </div>
            <div id="edit-topic-area">
              ${l.section && l.topics && l.topics.length ? `
                <div class="text-xs text-[var(--text-muted)] mb-1">${l.topics.length} topic${l.topics.length>1?'s':''} tagged</div>
                <div class="flex flex-wrap gap-1">
                  ${l.topics.map(t => `<span class="text-xs px-2 py-0.5 rounded-full" style="background:${SECTIONS[l.section].color}15;color:${SECTIONS[l.section].color}">${t}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="saveEditLog(${id})" class="btn btn-primary flex-1">Save</button>
          </div>
        </div>
      `);
    }

    function renderEditTopics(section) {
      const area = document.getElementById('edit-topic-area');
      if (!area || !section) { if(area) area.innerHTML = ''; return; }
      const topics = SECTIONS[section].topics;
      area.innerHTML = `
        <div class="p-3 rounded-xl mt-2" style="background:var(--surface-2);border:1px solid var(--border-subtle)">
          <div class="text-xs font-medium mb-2" style="color:${SECTIONS[section].color}">${SECTIONS[section].name} Topics</div>
          <div class="space-y-1 max-h-[150px] overflow-y-auto" style="scrollbar-width:thin">
            ${topics.map(t => {
              const y = getYield(t);
              const checked = (window._editLogTopics || []).includes(t);
              return `
                <label class="flex items-center gap-2 px-2 py-1 rounded-lg cursor-pointer text-xs ${checked?'bg-[var(--surface-3)]':'hover:bg-[var(--surface-3)]'}">
                  <input type="checkbox" ${checked?'checked':''} onchange="if(this.checked){window._editLogTopics.push('${t.replace(/'/g,"\\'")}');}else{window._editLogTopics=window._editLogTopics.filter(x=>x!=='${t.replace(/'/g,"\\'")}');}" style="accent-color:${SECTIONS[section].color}">
                  <span class="flex-1">${t}</span>
                  <span class="font-bold px-1 py-0.5 rounded" style="font-size:0.55rem;background:${YIELD[y].bg};color:${YIELD[y].color}">${YIELD[y].label}</span>
                </label>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function saveEditLog(id) {
      const l = state.logs.find(x => x.id === id);
      if (!l) return;
      const date = document.getElementById('edit-log-date').value;
      const hours = parseFloat(document.getElementById('edit-log-hrs').value) || 0;
      if (!date || hours <= 0 || hours > 24) { showToast('Check your input', 'error'); return; }
      l.date = date;
      l.category = document.getElementById('edit-log-cat').value;
      l.hours = hours;
      l.notes = document.getElementById('edit-log-notes').value.trim();
      // Save section/topics
      l.section = window._editLogSection || null;
      l.topics = window._editLogTopics && window._editLogTopics.length ? [...window._editLogTopics] : [];
      if (!l.section) { l.topics = []; delete l.section; delete l.topics; }
      // Auto-bump mastery for any newly tagged topics
      if (l.section && l.topics) {
        l.topics.forEach(t => {
          const key = l.section + '-' + t;
          if ((state.mastery[key] || 0) < 25) state.mastery[key] = 25;
        });
      }
      save();
      hideModal();
      render();
      showToast('Session updated');
    }

    function delLog(id) {
      showModal(`
        <div class="card p-6 w-96">
          <h3 class="font-semibold text-lg mb-2">Delete this session?</h3>
          <p class="text-[var(--text-muted)] mb-6">This can't be undone.</p>
          <div class="flex gap-3">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="state.logs=state.logs.filter(l=>l.id!==${id});save();hideModal();render();showToast('Deleted')" class="btn flex-1" style="background:var(--alert);color:white">Delete</button>
          </div>
        </div>
      `);
    }

    // ===== SCORES =====
    function renderScores(el) {
      const latest = state.tests[state.tests.length-1];
      const avg = state.tests.length ? Math.round(state.tests.reduce((s,t)=>s+t.total,0)/state.tests.length) : null;
      const best = state.tests.length ? Math.max(...state.tests.map(t=>t.total)) : null;
      const tests = ['AAMC FL1','AAMC FL2','AAMC FL3','AAMC FL4','AAMC FL5','AAMC Sample','Blueprint','Kaplan','Princeton','Altius','Other'];
      const scoreTip = getSmartQuote('mcat');

      // Score trend data
      const trendData = state.tests.slice(-8);

      el.innerHTML = `
        <div class="p-8 max-w-5xl animate-in">
          <h1 class="text-2xl font-bold mb-6">Score Tracker</h1>

          <div class="grid grid-cols-4 gap-5 mb-8 stagger-children">
            <div class="glow-card glow-blue p-5 tilt-card">
              <div class="stat-label mb-2">Latest</div>
              <div class="stat-value text-[var(--focus)] counter" data-target="${latest?latest.total:0}">${latest?latest.total:'‚Äî'}</div>
              <div class="text-sm text-[var(--text-muted)] mt-1">${latest?getPercentile(latest.total)+'th %ile':''}</div>
            </div>
            <div class="glow-card glow-purple p-5 tilt-card">
              <div class="stat-label mb-2">Average</div>
              <div class="stat-value text-[var(--wisdom)] counter" data-target="${avg||0}">${avg||'‚Äî'}</div>
            </div>
            <div class="glow-card glow-green p-5 tilt-card">
              <div class="stat-label mb-2">Best</div>
              <div class="stat-value text-[var(--growth)] counter" data-target="${best||0}">${best||'‚Äî'}</div>
            </div>
            <div class="glow-card glow-amber p-5 tilt-card">
              <div class="stat-label mb-2">To Target</div>
              <div class="stat-value ${latest&&latest.total>=state.targetScore?'text-[var(--growth)]':'text-[var(--energy)]'}">${latest?(latest.total>=state.targetScore?'‚úì':'+' +(state.targetScore-latest.total)):'‚Äî'}</div>
            </div>
          </div>

          <!-- Section Scores with FL Deltas -->
          ${latest ? (() => {
            const prev = state.tests.length >= 2 ? state.tests[state.tests.length - 2] : null;
            const sections = [
              { key: 'cp', label: 'C/P', full: 'Chem/Phys', color: 'var(--cp)', glowClass: 'glow-blue', rgb: '96,165,250' },
              { key: 'cars', label: 'CARS', full: 'Critical Analysis', color: 'var(--cars)', glowClass: 'glow-amber', rgb: '251,191,36' },
              { key: 'bb', label: 'B/B', full: 'Bio/Biochem', color: 'var(--bb)', glowClass: 'glow-green', rgb: '74,222,128' },
              { key: 'ps', label: 'P/S', full: 'Psych/Soc', color: 'var(--ps)', glowClass: 'glow-purple', rgb: '192,132,252' }
            ];
            return `
          <div class="grid grid-cols-4 gap-4 mb-8">
            ${sections.map((s, i) => {
              const score = latest[s.key];
              const delta = prev ? score - prev[s.key] : null;
              const deltaClass = delta > 0 ? 'up' : delta < 0 ? 'down' : 'same';
              const deltaText = delta > 0 ? '+' + delta : delta < 0 ? '' + delta : '0';
              const deltaArrow = delta > 0 ? '&#9650;' : delta < 0 ? '&#9660;' : '‚Äî';
              const pctOfMax = ((score - 118) / 14 * 100).toFixed(0);
              return '<div class="glow-card ' + s.glowClass + ' section-score-card p-5 tilt-card" style="--card-accent:' + s.color + '">' +
                '<div class="flex items-center justify-between mb-2">' +
                  '<div class="stat-label" style="color:' + s.color + '">' + s.label + '</div>' +
                  (delta !== null ? '<span class="score-delta ' + deltaClass + '">' + deltaArrow + ' ' + deltaText + '</span>' : '<span class="text-xs text-[var(--text-muted)]">First FL</span>') +
                '</div>' +
                '<div class="text-3xl font-bold font-mono mb-1" style="color:' + s.color + '">' + score + '</div>' +
                '<div class="text-xs text-[var(--text-muted)] mb-3">' + s.full + '</div>' +
                '<div class="h-1.5 rounded-full" style="background:rgba(' + s.rgb + ',0.1)">' +
                  '<div class="h-full rounded-full transition-all duration-500" style="width:' + pctOfMax + '%;background:' + s.color + '"></div>' +
                '</div>' +
              '</div>';
            }).join('')}
          </div>`;
          })() : ''}

          ${trendData.length >= 2 ? `
            <!-- Score Trend Chart -->
            <div class="card p-6 mb-8 reveal">
              <div class="stat-label mb-4">Score Trend</div>
              <div class="relative h-48">
                <svg viewBox="0 0 ${trendData.length * 100} 200" class="w-full h-full" preserveAspectRatio="none">
                  <!-- Target line -->
                  <line x1="0" y1="${200 - (state.targetScore - 472) * 200 / 56}" x2="${trendData.length * 100}" y2="${200 - (state.targetScore - 472) * 200 / 56}" stroke="var(--growth)" stroke-dasharray="5,5" stroke-width="2"/>

                  <!-- Trend line -->
                  <polyline fill="none" stroke="var(--focus)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                    points="${trendData.map((t, i) => `${i * 100 + 50},${200 - (t.total - 472) * 200 / 56}`).join(' ')}"/>

                  <!-- Data points -->
                  ${trendData.map((t, i) => `
                    <circle cx="${i * 100 + 50}" cy="${200 - (t.total - 472) * 200 / 56}" r="8" fill="var(--bg-surface)" stroke="var(--focus)" stroke-width="3"/>
                    <text x="${i * 100 + 50}" y="${200 - (t.total - 472) * 200 / 56 - 15}" text-anchor="middle" fill="var(--text-primary)" font-size="12" font-weight="bold">${t.total}</text>
                  `).join('')}
                </svg>
              </div>
              <div class="flex justify-center mt-2 text-sm text-[var(--text-muted)]">
                <span class="flex items-center gap-2"><span class="w-3 h-0.5 bg-[var(--growth)]" style="border: 1px dashed var(--growth)"></span> Target: ${state.targetScore}</span>
              </div>
            </div>
          ` : ''}

          <div class="card p-6 mb-8 reveal">
            <h2 class="font-semibold mb-4">Log Practice Test</h2>
            <div class="grid grid-cols-7 gap-3">
              <div><label class="stat-label block mb-2">Date</label><input type="date" id="t-date" value="${today()}" class="input text-sm"></div>
              <div><label class="stat-label block mb-2">Test</label><select id="t-name" class="input text-sm"><option value="">Select...</option>${tests.map(t=>`<option>${t}</option>`).join('')}</select></div>
              <div><label class="stat-label block mb-2">C/P</label><input type="number" id="t-cp" min="118" max="132" placeholder="125" class="input text-sm"></div>
              <div><label class="stat-label block mb-2">CARS</label><input type="number" id="t-cars" min="118" max="132" placeholder="125" class="input text-sm"></div>
              <div><label class="stat-label block mb-2">B/B</label><input type="number" id="t-bb" min="118" max="132" placeholder="125" class="input text-sm"></div>
              <div><label class="stat-label block mb-2">P/S</label><input type="number" id="t-ps" min="118" max="132" placeholder="125" class="input text-sm"></div>
              <div class="flex items-end"><button onclick="addTest()" class="btn btn-primary w-full text-sm">Add</button></div>
            </div>
          </div>

          <div class="card overflow-hidden reveal">
            <div class="glass-header grid grid-cols-[85px_1fr_55px_55px_55px_55px_65px_55px_40px] text-xs uppercase tracking-wider text-[var(--text-muted)]">
              <span>Date</span><span>Test</span><span class="text-center">C/P</span><span class="text-center">CARS</span><span class="text-center">B/B</span><span class="text-center">P/S</span><span class="text-center">Total</span><span class="text-center">%ile</span><span></span>
            </div>
            <div class="max-h-[400px] overflow-y-auto glass-list">
              ${state.tests.slice().reverse().map((t, idx) => `
                <div class="table-row grid-cols-[85px_1fr_55px_55px_55px_55px_65px_55px_40px]" style="animation-delay: ${idx * 30}ms">
                  <span class="text-xs text-[var(--text-muted)] font-medium">${formatDate(t.date)}</span>
                  <span class="text-sm font-medium text-[var(--text-secondary)]">${t.name}</span>
                  <span class="text-sm text-center font-mono" style="color:var(--cp)">${t.cp}</span>
                  <span class="text-sm text-center font-mono" style="color:var(--cars)">${t.cars}</span>
                  <span class="text-sm text-center font-mono" style="color:var(--bb)">${t.bb}</span>
                  <span class="text-sm text-center font-mono" style="color:var(--ps)">${t.ps}</span>
                  <span class="text-sm text-center font-mono font-bold text-[var(--text-primary)]">${t.total}</span>
                  <span class="text-xs text-center text-[var(--text-muted)]">${getPercentile(t.total)}th</span>
                  <button onclick="delTest(${t.id})" class="delete-btn text-[var(--text-muted)]">${icon.trash}</button>
                </div>
              `).join('') || '<div class="empty-state"><div class="empty-icon"><span style="display:inline-block;width:40px;height:40px;opacity:0.5">' + icon.chart + '</span></div><div>No practice tests logged</div><div class="text-sm mt-2 opacity-70">Track your FL scores here!</div></div>'}
            </div>
          </div>

          <div class="quote-card mt-8 reveal" style="border-left:2px solid var(--focus)">
            <p class="text-sm mb-1">"${scoreTip.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${scoreTip.author}</p>
          </div>
        </div>
      `;
    }

    function addTest() {
      const date=document.getElementById('t-date').value, name=document.getElementById('t-name').value;
      const cp=parseInt(document.getElementById('t-cp').value), cars=parseInt(document.getElementById('t-cars').value);
      const bb=parseInt(document.getElementById('t-bb').value), ps=parseInt(document.getElementById('t-ps').value);
      if(!date||!name) { showToast('Select date and test','error'); return; }
      if([cp,cars,bb,ps].some(x=>isNaN(x)||x<118||x>132)) { showToast('Scores must be 118-132','error'); return; }
      const total = cp+cars+bb+ps;
      state.tests.push({id:Date.now(), date, name, cp, cars, bb, ps, total});
      save();
      render();
      addXP(100, 'Practice test completed');
      checkAchievements();
      if (total >= state.targetScore) {
        triggerConfetti();
        showToast(`${name}: ${total} ‚Äî Target hit!`, 'success');
      } else {
        showToast(`${name}: ${total}`);
      }
      // Dramatic score reveal on stat cards
      requestAnimationFrame(() => {
        document.querySelectorAll('.score-reveal-target').forEach(el => {
          el.classList.add('score-reveal');
          setTimeout(() => el.classList.remove('score-reveal'), 600);
        });
      });
    }

    function delTest(id) {
      showModal(`
        <div class="card p-6 w-96">
          <h3 class="font-semibold text-lg mb-2">Delete this test?</h3>
          <p class="text-[var(--text-muted)] mb-6">This can't be undone.</p>
          <div class="flex gap-3">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="state.tests=state.tests.filter(t=>t.id!==${id});save();hideModal();render();showToast('Deleted')" class="btn flex-1" style="background:var(--alert);color:white">Delete</button>
          </div>
        </div>
      `);
    }

    // ===== CONTENT =====
    function renderContent(el) {
      const lvls = [{v:0,l:'Not Started',c:'#52525b'},{v:25,l:'Introduced',c:'#f87171'},{v:50,l:'Learning',c:'#fbbf24'},{v:75,l:'Familiar',c:'#60a5fa'},{v:100,l:'Mastered',c:'#4ade80'}];
      const getL = v => lvls.find(l=>v<=l.v) || lvls[4];
      const contentTip = getSmartQuote('content');

      const outline = AAMC_OUTLINE[state.section];
      const concepts = outline.concepts;
      const secTopics = SECTIONS[state.section].topics;
      const yf = state.yieldFilter;

      // Yield counts for current section
      const yieldCounts = { h: 0, m: 0, l: 0 };
      const yieldMastered = { h: 0, m: 0, l: 0 };
      secTopics.forEach(t => {
        const y = getYield(t);
        yieldCounts[y]++;
        if ((state.mastery[state.section + '-' + t] || 0) >= 75) yieldMastered[y]++;
      });

      // HY focus count ‚Äî high-yield topics below 75%
      const hyFocusCount = yieldCounts.h - yieldMastered.h;

      // Overall mastery for this section
      const sectionAvg = secTopics.length ? Math.round(secTopics.reduce((sum, t) => sum + (state.mastery[state.section + '-' + t] || 0), 0) / secTopics.length) : 0;

      // Get category mastery
      const getCatMastery = (catTopics) => {
        if (!catTopics.length) return 0;
        return Math.round(catTopics.reduce((sum, t) => sum + (state.mastery[state.section + '-' + t] || 0), 0) / catTopics.length);
      };

      // Get concept mastery
      const getConceptMastery = (concept) => {
        const allTopics = [];
        Object.values(concept.categories).forEach(cat => cat.topics.forEach(t => allTopics.push(t)));
        return getCatMastery(allTopics);
      };

      // Get HY mastery for a concept
      const getConceptHYMastery = (concept) => {
        const hyTopics = [];
        Object.values(concept.categories).forEach(cat => cat.topics.forEach(t => { if (getYield(t) === 'h') hyTopics.push(t); }));
        if (!hyTopics.length) return null;
        return Math.round(hyTopics.reduce((sum, t) => sum + (state.mastery[state.section + '-' + t] || 0), 0) / hyTopics.length);
      };

      // Filter topics based on yield filter
      const shouldShow = t => yf === 'all' || getYield(t) === yf;

      // Sort topics
      const sortTopics = (topics) => {
        const filtered = topics.filter(shouldShow);
        if (state.contentSort === 'yield') {
          const order = { h: 0, m: 1, l: 2 };
          return [...filtered].sort((a, b) => order[getYield(a)] - order[getYield(b)]);
        }
        if (state.contentSort === 'mastery') {
          return [...filtered].sort((a, b) => (state.mastery[state.section + '-' + a] || 0) - (state.mastery[state.section + '-' + b] || 0));
        }
        return filtered;
      };

      // Yield badge HTML for a topic
      const yieldBadge = (t) => {
        const y = getYield(t);
        if (y === 'h') return `<span style="background:${YIELD.h.bg};color:${YIELD.h.color};border:1px solid ${YIELD.h.border};padding:1px 6px;border-radius:4px;font-size:0.6rem;font-weight:700;white-space:nowrap">HY</span>`;
        if (y === 'l') return `<span style="background:${YIELD.l.bg};color:${YIELD.l.color};border:1px solid ${YIELD.l.border};padding:1px 6px;border-radius:4px;font-size:0.6rem;font-weight:600;white-space:nowrap">LY</span>`;
        return '';
      };

      // Category yield breakdown string
      const catYieldBreakdown = (topics) => {
        const c = { h: 0, m: 0, l: 0 };
        topics.forEach(t => c[getYield(t)]++);
        const parts = [];
        if (c.h) parts.push(`<span style="color:${YIELD.h.color}">${c.h} HY</span>`);
        if (c.m) parts.push(`<span style="color:${YIELD.m.color}">${c.m} MY</span>`);
        if (c.l) parts.push(`<span style="color:${YIELD.l.color}">${c.l} LY</span>`);
        return parts.join(' ¬∑ ');
      };

      el.innerHTML = `
        <div class="p-8 max-w-6xl animate-in">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h1 class="text-2xl font-bold mb-1">AAMC Content Outline</h1>
              <p class="text-[var(--text-muted)]">Track your mastery of official MCAT topics</p>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold font-mono" style="color:${outline.color}">${sectionAvg}%</div>
              <div class="text-sm text-[var(--text-muted)]">Section Mastery</div>
            </div>
          </div>

          <div class="grid grid-cols-4 gap-4 mb-6">
            ${Object.keys(AAMC_OUTLINE).map(s => {
              const sec = AAMC_OUTLINE[s];
              const sTopics = SECTIONS[s].topics;
              const avg = Math.round(sTopics.reduce((sum,t)=>sum+(state.mastery[s+'-'+t]||0),0)/sTopics.length);
              const hyCount = sTopics.filter(t => getYield(t) === 'h').length;
              return `
                <button onclick="state.section='${s}';state.contentCategory=null;render()" class="glow-card p-4 text-left transition-all ${state.section===s?'ring-2':''}" style="${state.section===s?`ring-color:${sec.color};border-color:${sec.color}40`:''}" >
                  <div class="flex justify-between items-start mb-2">
                    <span class="font-semibold" style="color:${sec.color}">${sec.name}</span>
                    <span class="font-mono text-sm">${avg}%</span>
                  </div>
                  <div class="progress-track h-2">
                    <div class="progress-fill" style="width:${avg}%;background:${sec.color}"></div>
                  </div>
                  <div class="text-xs text-[var(--text-muted)] mt-2">${sTopics.length} topics ¬∑ <span style="color:${YIELD.h.color}">${hyCount} HY</span></div>
                </button>
              `;
            }).join('')}
          </div>

          <!-- Yield Filter Bar -->
          <div class="card p-4 mb-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
              <div class="flex gap-2">
                <button onclick="state.yieldFilter='all';render()" class="btn ${yf==='all'?'btn-primary':'btn-secondary'} text-xs py-1.5 px-3">All Topics (${secTopics.length})</button>
                <button onclick="state.yieldFilter='h';render()" class="btn ${yf==='h'?'':'btn-secondary'} text-xs py-1.5 px-3" style="${yf==='h'?`background:${YIELD.h.color};color:#000`:''}"><span style="color:${yf==='h'?'#000':YIELD.h.color}">\u{1F525}</span> High Yield (${yieldCounts.h})</button>
                <button onclick="state.yieldFilter='m';render()" class="btn ${yf==='m'?'btn-primary':'btn-secondary'} text-xs py-1.5 px-3">Medium (${yieldCounts.m})</button>
                <button onclick="state.yieldFilter='l';render()" class="btn ${yf==='l'?'btn-primary':'btn-secondary'} text-xs py-1.5 px-3">Low Yield (${yieldCounts.l})</button>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-[var(--text-muted)]">Sort:</span>
                <select onchange="state.contentSort=this.value;render()" class="text-xs py-1.5 px-2 rounded-lg bg-[var(--bg-elevated)] border border-[var(--border-subtle)] text-[var(--text-primary)]" style="outline:none">
                  <option value="default" ${state.contentSort==='default'?'selected':''}>Outline Order</option>
                  <option value="yield" ${state.contentSort==='yield'?'selected':''}>Yield Priority</option>
                  <option value="mastery" ${state.contentSort==='mastery'?'selected':''}>Mastery (Low\u2192High)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Yield Stats Summary -->
          <div class="card p-4 mb-6" style="border-left:3px solid ${YIELD.h.color}">
            <div class="flex items-start gap-6 flex-wrap">
              <div class="flex-1 min-w-[200px]">
                <div class="flex items-center gap-2 mb-1">
                  <span style="color:${YIELD.h.color}">\u{1F525}</span>
                  <span class="text-sm font-semibold">High Yield: ${yieldMastered.h}/${yieldCounts.h} mastered</span>
                  <span class="font-mono text-xs text-[var(--text-muted)]">(${yieldCounts.h ? Math.round(yieldMastered.h/yieldCounts.h*100) : 0}%)</span>
                </div>
                <div class="progress-track h-2 mb-2">
                  <div class="progress-fill" style="width:${yieldCounts.h ? Math.round(yieldMastered.h/yieldCounts.h*100) : 0}%;background:${YIELD.h.color}"></div>
                </div>
                <div class="flex gap-4 text-xs text-[var(--text-muted)]">
                  <span>Medium: ${yieldMastered.m}/${yieldCounts.m} (${yieldCounts.m ? Math.round(yieldMastered.m/yieldCounts.m*100) : 0}%)</span>
                  <span>Low: ${yieldMastered.l}/${yieldCounts.l} (${yieldCounts.l ? Math.round(yieldMastered.l/yieldCounts.l*100) : 0}%)</span>
                </div>
              </div>
              ${hyFocusCount > 0 ? `
                <div class="px-4 py-2 rounded-lg" style="background:${YIELD.h.bg};border:1px solid ${YIELD.h.border}">
                  <div class="text-sm font-semibold" style="color:${YIELD.h.color}">\u26A1 ${hyFocusCount} high-yield topic${hyFocusCount>1?'s':''} need${hyFocusCount===1?'s':''} work</div>
                  <div class="text-xs text-[var(--text-muted)]">Below 75% mastery</div>
                </div>
              ` : `
                <div class="px-4 py-2 rounded-lg" style="background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.3)">
                  <div class="text-sm font-semibold" style="color:#4ade80">\u2713 All high-yield topics mastered!</div>
                  <div class="text-xs text-[var(--text-muted)]">Keep reviewing to stay sharp</div>
                </div>
              `}
            </div>
          </div>

          <div class="card p-6 mb-6">
            <h2 class="font-semibold text-lg mb-1" style="color:${outline.color}">${outline.full}</h2>
            <p class="text-sm text-[var(--text-muted)] mb-6">${SECTIONS[state.section].topics.length} topics across ${Object.keys(concepts).length} foundational concept${Object.keys(concepts).length > 1 ? 's' : ''}</p>

            ${Object.entries(concepts).map(([fcKey, fc]) => {
              const hyMastery = getConceptHYMastery(fc);
              return `
              <div class="mb-6 last:mb-0">
                <div class="flex items-center gap-4 mb-4 p-4 rounded-lg" style="background:${outline.color}10">
                  <div class="w-12 h-12 rounded-xl flex items-center justify-center font-bold text-lg" style="background:${outline.color}30;color:${outline.color}">${fcKey.replace('FC','').replace('Skills','')}</div>
                  <div class="flex-1">
                    <div class="font-semibold">${fc.name}</div>
                    <div class="text-sm text-[var(--text-muted)]">${fc.desc}</div>
                  </div>
                  <div class="text-right">
                    <div class="font-mono font-bold" style="color:${outline.color}">${getConceptMastery(fc)}%</div>
                    <div class="text-xs text-[var(--text-muted)]">${fc.weight} of section</div>
                    ${hyMastery !== null ? `<div class="text-xs mt-1" style="color:${YIELD.h.color}">\u{1F525} HY: ${hyMastery}%</div>` : ''}
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pl-4">
                  ${Object.entries(fc.categories).map(([catKey, cat]) => {
                    const visibleTopics = sortTopics(cat.topics);
                    const catMastery = getCatMastery(cat.topics);
                    const isExpanded = state.contentCategory === state.section + '-' + catKey;
                    const hasVisible = visibleTopics.length > 0;
                    return `
                      <div class="card overflow-hidden${!hasVisible && yf !== 'all' ? ' opacity-40' : ''}">
                        <div class="p-4 cursor-pointer hover:bg-[var(--bg-elevated)] transition-colors" onclick="state.contentCategory=state.contentCategory==='${state.section}-${catKey}'?null:'${state.section}-${catKey}';render()">
                          <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                              <span class="badge text-xs" style="background:${outline.color}20;color:${outline.color}">${catKey}</span>
                              <span class="font-medium text-sm">${cat.name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                              <span class="font-mono text-sm">${catMastery}%</span>
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${isExpanded?'rotate-180':''}"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                          </div>
                          <div class="progress-track h-1.5">
                            <div class="progress-fill" style="width:${catMastery}%;background:${outline.color}"></div>
                          </div>
                          <div class="text-xs mt-2">${catYieldBreakdown(cat.topics)}</div>
                        </div>

                        ${isExpanded ? `
                          <div class="border-t border-[var(--border-subtle)] max-h-96 overflow-y-auto">
                            ${visibleTopics.length ? visibleTopics.map(t => {
                              const k = state.section + '-' + t;
                              const v = state.mastery[k] || 0;
                              const lv = getL(v);
                              const ty = getYield(t);
                              const isHYWeak = ty === 'h' && v < 75;
                              return `
                                <div class="p-3 border-b border-[var(--border-subtle)] last:border-0 hover:bg-[var(--bg-elevated)] transition-colors" ${isHYWeak ? `style="border-left:3px solid ${YIELD.h.color}"` : ''}>
                                  <div class="flex items-center gap-2">
                                    ${yieldBadge(t)}
                                    <div class="flex-1 min-w-0">
                                      <div class="text-sm truncate">${t}</div>
                                    </div>
                                    <span class="badge text-xs" style="background:${lv.c}20;color:${lv.c}">${lv.l}</span>
                                    <div class="flex gap-1">
                                      ${lvls.map(l => `
                                        <button onclick="event.stopPropagation();setMastery('${k.replace(/'/g, "\\'")}',${l.v},event)" class="mastery-btn ${v===l.v?'selected':''}" style="background:${l.c}40;color:${l.c};width:24px;height:24px;font-size:0.65rem" title="${MASTERY_DESC[l.v].label}: ${MASTERY_DESC[l.v].desc}">${l.v||'\u2013'}</button>
                                      `).join('')}
                                    </div>
                                  </div>
                                </div>
                              `;
                            }).join('') : `<div class="p-4 text-center text-sm text-[var(--text-muted)]">No ${YIELD[yf]?.label || ''} topics in this category</div>`}
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `}).join('')}
          </div>

          <!-- Mastery Legend -->
          <div class="card p-4 mb-4">
            <div class="flex justify-center gap-6 flex-wrap">
              ${lvls.map(l=>`<div class="flex items-center gap-2" title="${MASTERY_DESC[l.v].desc}"><div class="w-3 h-3 rounded" style="background:${l.c}"></div><span class="text-sm text-[var(--text-muted)]">${l.l}</span></div>`).join('')}
            </div>
            <div class="flex justify-center gap-4 mt-2 pt-2 border-t border-[var(--border-subtle)]">
              <div class="flex items-center gap-1"><span style="color:${YIELD.h.color};font-size:0.65rem;font-weight:700;padding:1px 4px;border-radius:3px;background:${YIELD.h.bg}">HY</span><span class="text-xs text-[var(--text-muted)]">High Yield</span></div>
              <div class="flex items-center gap-1"><span style="color:${YIELD.l.color};font-size:0.65rem;font-weight:600;padding:1px 4px;border-radius:3px;background:${YIELD.l.bg}">LY</span><span class="text-xs text-[var(--text-muted)]">Low Yield</span></div>
            </div>
          </div>

          <div class="quote-card reveal" style="border-left:2px solid ${SECTIONS[state.section].color}">
            <p class="text-sm mb-1">"${contentTip.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${contentTip.author}</p>
          </div>
        </div>
      `;
    }

    function setMastery(key, val, event) {
      const oldVal = state.mastery[key] || 0;
      state.mastery[key] = val;

      // Mastery burst feedback on the clicked button
      if (event && event.target) {
        const btn = event.target.closest('[onclick]') || event.target;
        btn.classList.add('mastery-burst');
        setTimeout(() => btn.classList.remove('mastery-burst'), 400);
      }

      save();
      render();
      if (val > oldVal) {
        addXP(Math.round((val - oldVal) / 5), 'Mastery improved');
      }
      if (val === 100 && oldVal < 100) {
        triggerConfetti();
        showToast('Topic mastered!');
      }
      checkAchievements();
    }

    // ===== RESOURCES =====
    function renderResources(el) {
      const hasResources = state.myResources.length > 0;
      const suggestions = getResourceSuggestions();
      const resourceTip = getSmartQuote('strategy');

      el.innerHTML = `
        <div class="p-8 max-w-5xl animate-in">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Resources</h1>
            <div class="flex gap-2">
              <button onclick="state.resourceView='my';render()" class="btn ${state.resourceView==='my'?'btn-primary':'btn-secondary'} text-sm">My Resources</button>
              <button onclick="state.resourceView='library';render()" class="btn ${state.resourceView==='library'?'btn-primary':'btn-secondary'} text-sm">Browse Library</button>
            </div>
          </div>

          ${state.resourceView === 'my' ? renderMyResources(hasResources, suggestions) : renderResourceLibrary()}

          <div class="quote-card mt-8 reveal" style="border-left:2px solid var(--wisdom)">
            <p class="text-sm mb-1">"${resourceTip.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${resourceTip.author}</p>
          </div>
        </div>
      `;
    }

    function renderMyResources(hasResources, suggestions) {
      if (!hasResources) {
        return `
          <div class="card p-12 text-center">
            <div class="text-5xl mb-4"><span style="display:inline-block;width:48px;height:48px;opacity:0.5">${icon.folder}</span></div>
            <h2 class="text-xl font-semibold mb-2">No Resources Added Yet</h2>
            <p class="text-[var(--text-muted)] mb-6">Browse the library and add resources to your study plan</p>
            <button onclick="state.resourceView='library';render()" class="btn btn-primary">Browse Resource Library</button>
          </div>

          ${suggestions.length ? `
            <div class="mt-8">
              <h2 class="text-lg font-semibold mb-4">${icon.lightbulb} Suggested for You</h2>
              <div class="grid grid-cols-2 gap-4">
                ${suggestions.slice(0,4).map(s => `
                  <div class="card p-4 flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg bg-[var(--bg-elevated)] flex items-center justify-center text-lg">${s.icon}</div>
                    <div class="flex-1">
                      <div class="font-medium text-sm">${s.name}</div>
                      <div class="text-xs text-[var(--text-muted)] mb-2">${s.reason}</div>
                      <button onclick="addResourceFromLibrary('${s.type}','${s.id}')" class="btn btn-secondary text-xs py-1 px-3">+ Add</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        `;
      }

      // Group resources by type
      const books = state.myResources.filter(r => r.type === 'book');
      const qbanks = state.myResources.filter(r => r.type === 'qbank');
      const anki = state.myResources.filter(r => r.type === 'anki');
      const videos = state.myResources.filter(r => r.type === 'video');
      const fls = state.myResources.filter(r => r.type === 'fl');

      return `
        ${suggestions.length ? `
          <div class="card p-4 mb-6 bg-gradient-to-r from-[var(--focus)]/10 to-[var(--wisdom)]/10 border-[var(--focus)]/20">
            <div class="flex items-center gap-3">
              <span class="text-xl">${icon.lightbulb}</span>
              <div class="flex-1">
                <div class="text-sm font-medium">${suggestions[0].reason}</div>
                <div class="text-xs text-[var(--text-muted)]">${suggestions[0].name}</div>
              </div>
              <button onclick="addResourceFromLibrary('${suggestions[0].type}','${suggestions[0].id}')" class="btn btn-primary text-sm">+ Add</button>
            </div>
          </div>
        ` : ''}

        ${books.length ? renderBookSection(books) : ''}
        ${qbanks.length ? renderQBankSection(qbanks) : ''}
        ${anki.length ? renderAnkiSection(anki) : ''}
        ${videos.length ? renderVideoSection(videos) : ''}
        ${fls.length ? renderFLSection(fls) : ''}
      `;
    }

    function renderBookSection(books) {
      return `
        <div class="card mb-6 overflow-hidden">
          <div class="glass-header flex justify-between items-center">
            <h2 class="font-semibold">${icon.book} Books</h2>
            <span class="text-xs text-[var(--text-muted)]">${books.length} book${books.length>1?'s':''}</span>
          </div>
          <div class="p-4 space-y-3">
            ${books.map(b => {
              const done = b.chapters.filter(c=>c.done).length;
              const total = b.chapters.length;
              const pct = Math.round((done/total)*100);
              const totalSubs = b.chapters.reduce((s,c) => s + (c.subtopics||[]).length, 0);
              const doneSubs = b.chapters.reduce((s,c) => s + (c.subtopics||[]).filter(st=>st.done).length, 0);
              const expandedBook = state._expandedBook === b.id;
              return `
                <div class="bg-[var(--bg-base)] rounded-xl overflow-hidden">
                  <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                      <div class="flex items-center gap-2 cursor-pointer" onclick="state._expandedBook=state._expandedBook==='${b.id}'?null:'${b.id}';render()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${expandedBook?'rotate-90':''}"><polyline points="9 18 15 12 9 6"/></svg>
                        <span class="font-medium">${b.name}</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="text-sm text-[var(--text-muted)]">${done}/${total} ch</span>
                        ${totalSubs ? `<span class="text-xs text-[var(--text-muted)]">${doneSubs}/${totalSubs} topics</span>` : ''}
                        <span class="font-mono text-sm font-semibold ${pct===100?'text-[var(--growth)]':'text-[var(--focus)]'}">${pct}%</span>
                        <button onclick="removeResource('${b.id}')" class="text-[var(--text-muted)] hover:text-[var(--alert)] transition-colors">${icon.trash}</button>
                      </div>
                    </div>
                    <div class="progress-track h-2">
                      <div class="progress-fill" style="width:${pct}%;background:${pct===100?'var(--growth)':'var(--focus)'}"></div>
                    </div>
                  </div>

                  ${expandedBook ? `
                    <div class="border-t border-[var(--border-subtle)]">
                      ${b.chapters.map((ch, i) => {
                        const hasSubs = ch.subtopics && ch.subtopics.length > 0;
                        const subsDone = hasSubs ? ch.subtopics.filter(st=>st.done).length : 0;
                        const subsTotal = hasSubs ? ch.subtopics.length : 0;
                        const chExpanded = state._expandedChapter === b.id + '-' + i;
                        return `
                          <div class="border-b border-[var(--border-subtle)] last:border-0">
                            <div class="flex items-center gap-3 px-4 py-3 hover:bg-[var(--bg-elevated)] transition-colors">
                              ${hasSubs ? `
                                <button onclick="event.stopPropagation();state._expandedChapter=state._expandedChapter==='${b.id}-${i}'?null:'${b.id}-${i}';render()" class="text-[var(--text-muted)]">
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${chExpanded?'rotate-90':''}"><polyline points="9 18 15 12 9 6"/></svg>
                                </button>
                              ` : '<div class="w-[14px]"></div>'}
                              <button onclick="toggleChapter('${b.id}',${i})" class="w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${ch.done ? 'bg-[var(--growth)] border-[var(--growth)]' : 'border-[var(--text-muted)]/30 hover:border-[var(--focus)]'}">
                                ${ch.done ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                              </button>
                              <div class="flex-1 min-w-0">
                                <span class="text-sm ${ch.done?'line-through text-[var(--text-muted)]':''}">${i+1}. ${ch.name}</span>
                              </div>
                              ${hasSubs ? `<span class="text-xs text-[var(--text-muted)]">${subsDone}/${subsTotal}</span>` : ''}
                            </div>
                            ${chExpanded && hasSubs ? `
                              <div class="pl-14 pr-4 pb-3 space-y-1">
                                ${ch.subtopics.map((st, si) => `
                                  <div class="flex items-center gap-2 py-1 px-2 rounded hover:bg-[var(--bg-elevated)] transition-colors">
                                    <button onclick="toggleSubtopic('${b.id}',${i},${si})" class="w-4 h-4 rounded border flex items-center justify-center transition-all ${st.done ? 'bg-[var(--growth)] border-[var(--growth)]' : 'border-[var(--text-muted)]/30 hover:border-[var(--focus)]'}">
                                      ${st.done ? '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                                    </button>
                                    <span class="text-xs ${st.done?'line-through text-[var(--text-muted)]':''}">${st.name}</span>
                                  </div>
                                `).join('')}
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderQBankSection(qbanks) {
      return `
        <div class="card mb-6 overflow-hidden">
          <div class="glass-header flex justify-between items-center">
            <h2 class="font-semibold">${icon.helpCircle} Question Banks</h2>
            <span class="text-xs text-[var(--text-muted)]">${qbanks.reduce((s,q)=>s+q.done,0)} questions done</span>
          </div>
          <div class="p-4 space-y-3">
            ${qbanks.map(q => {
              const pct = Math.round((q.done/q.total)*100);
              return `
                <div class="bg-[var(--bg-base)] rounded-xl p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">${q.name}</span>
                    <button onclick="removeResource('${q.id}')" class="text-[var(--text-muted)] hover:text-[var(--alert)] transition-colors">${icon.trash}</button>
                  </div>
                  <div class="grid grid-cols-4 gap-4 mb-3">
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Done</div>
                      <div class="font-mono font-semibold">${q.done}/${q.total}</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Correct</div>
                      <div class="font-mono font-semibold ${q.correct>=80?'text-[var(--growth)]':q.correct>=60?'text-[var(--energy)]':'text-[var(--alert)]'}">${q.correct||0}%</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Flagged</div>
                      <div class="font-mono font-semibold">${q.flagged||0}</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Progress</div>
                      <div class="font-mono font-semibold text-[var(--focus)]">${pct}%</div>
                    </div>
                  </div>
                  <div class="progress-track h-2 mb-3">
                    <div class="progress-fill" style="width:${pct}%;background:var(--focus)"></div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="updateQBank('${q.id}','done',10)" class="btn btn-secondary text-xs py-1 flex-1">+10 Qs</button>
                    <button onclick="updateQBank('${q.id}','done',25)" class="btn btn-secondary text-xs py-1 flex-1">+25 Qs</button>
                    <button onclick="showQBankModal('${q.id}')" class="btn btn-ghost text-xs py-1">Edit Details</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderAnkiSection(anki) {
      return `
        <div class="card mb-6 overflow-hidden">
          <div class="glass-header flex justify-between items-center">
            <h2 class="font-semibold">${icon.cardStack} Anki Decks</h2>
          </div>
          <div class="p-4 space-y-3">
            ${anki.map(a => {
              const pct = Math.round((a.mature/a.total)*100);
              return `
                <div class="bg-[var(--bg-base)] rounded-xl p-4">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">${a.name}</span>
                    <button onclick="removeResource('${a.id}')" class="text-[var(--text-muted)] hover:text-[var(--alert)] transition-colors">${icon.trash}</button>
                  </div>
                  <div class="grid grid-cols-4 gap-4 mb-3">
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Mature</div>
                      <div class="font-mono font-semibold text-[var(--growth)]">${a.mature||0}</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Learning</div>
                      <div class="font-mono font-semibold text-[var(--energy)]">${a.learning||0}</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">New</div>
                      <div class="font-mono font-semibold text-[var(--text-muted)]">${a.total - (a.mature||0) - (a.learning||0)}</div>
                    </div>
                    <div>
                      <div class="text-xs text-[var(--text-muted)]">Daily Avg</div>
                      <div class="font-mono font-semibold">${a.dailyAvg||0}</div>
                    </div>
                  </div>
                  <div class="progress-track h-2 mb-3">
                    <div class="progress-fill" style="width:${pct}%;background:var(--growth)"></div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="showAnkiModal('${a.id}')" class="btn btn-secondary text-xs py-1 flex-1">Update Stats</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderVideoSection(videos) {
      return `
        <div class="card mb-6 overflow-hidden">
          <div class="glass-header flex justify-between items-center">
            <h2 class="font-semibold">${icon.videoIcon} Video Courses</h2>
            <span class="text-xs text-[var(--text-muted)]">${videos.reduce((s,v) => s + getVideoWatched(v), 0)} videos watched</span>
          </div>
          <div class="p-4 space-y-3">
            ${videos.map(v => {
              const watched = getVideoWatched(v);
              const pct = Math.round((watched/v.total)*100);
              const expandedVid = state._expandedVideo === v.id;
              return `
                <div class="bg-[var(--bg-base)] rounded-xl overflow-hidden">
                  <div class="p-4">
                    <div class="flex justify-between items-center mb-2">
                      <div class="flex items-center gap-2 cursor-pointer" onclick="state._expandedVideo=state._expandedVideo==='${v.id}'?null:'${v.id}';render()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${expandedVid?'rotate-90':''}"><polyline points="9 18 15 12 9 6"/></svg>
                        <span class="font-medium">${v.name}</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="text-sm text-[var(--text-muted)]">${watched}/${v.total} videos</span>
                        <span class="font-mono text-sm font-semibold ${pct===100?'text-[var(--growth)]':'text-[var(--focus)]'}">${pct}%</span>
                        <button onclick="removeResource('${v.id}')" class="text-[var(--text-muted)] hover:text-[var(--alert)] transition-colors">${icon.trash}</button>
                      </div>
                    </div>
                    <div class="progress-track h-2">
                      <div class="progress-fill" style="width:${pct}%;background:${pct===100?'var(--growth)':'var(--focus)'}"></div>
                    </div>
                  </div>

                  ${expandedVid && v.units ? `
                    <div class="border-t border-[var(--border-subtle)]">
                      ${v.units.map((unit, ui) => {
                        const unitWatched = unit.topics.reduce((s,t) => s + (t.watched||0), 0);
                        const unitTotal = unit.topics.reduce((s,t) => s + t.vids, 0);
                        const unitPct = Math.round((unitWatched/unitTotal)*100);
                        const unitExpanded = state._expandedUnit === v.id + '-' + ui;
                        return `
                          <div class="border-b border-[var(--border-subtle)] last:border-0">
                            <div class="flex items-center gap-3 px-4 py-3 hover:bg-[var(--bg-elevated)] transition-colors cursor-pointer" onclick="state._expandedUnit=state._expandedUnit==='${v.id}-${ui}'?null:'${v.id}-${ui}';render()">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${unitExpanded?'rotate-90':''}"><polyline points="9 18 15 12 9 6"/></svg>
                              <div class="flex-1 min-w-0">
                                <span class="text-sm font-medium">${unit.name}</span>
                              </div>
                              <div class="flex items-center gap-3">
                                <div class="progress-track h-1.5 w-20">
                                  <div class="progress-fill" style="width:${unitPct}%;background:${unitPct===100?'var(--growth)':'var(--focus)'}"></div>
                                </div>
                                <span class="text-xs text-[var(--text-muted)] font-mono w-16 text-right">${unitWatched}/${unitTotal}</span>
                                <span class="text-xs font-mono ${unitPct===100?'text-[var(--growth)]':'text-[var(--focus)]'}">${unitPct}%</span>
                              </div>
                            </div>
                            ${unitExpanded ? `
                              <div class="pl-10 pr-4 pb-3 space-y-1">
                                ${unit.topics.map((topic, ti) => {
                                  const tPct = Math.round(((topic.watched||0)/topic.vids)*100);
                                  return `
                                    <div class="flex items-center gap-3 py-1.5 px-2 rounded hover:bg-[var(--bg-elevated)] transition-colors">
                                      <div class="flex-1 min-w-0">
                                        <span class="text-xs ${tPct===100?'text-[var(--growth)]':''}">${topic.name}</span>
                                      </div>
                                      <div class="flex items-center gap-2">
                                        <button onclick="updateVideoTopic('${v.id}',${ui},${ti},-1)" class="w-5 h-5 rounded bg-[var(--bg-elevated)] hover:bg-[var(--bg-hover)] flex items-center justify-center text-xs transition-colors">-</button>
                                        <span class="text-xs font-mono w-12 text-center ${tPct===100?'text-[var(--growth)]':'text-[var(--text-muted)]'}">${topic.watched||0}/${topic.vids}</span>
                                        <button onclick="updateVideoTopic('${v.id}',${ui},${ti},1)" class="w-5 h-5 rounded bg-[var(--bg-elevated)] hover:bg-[var(--bg-hover)] flex items-center justify-center text-xs transition-colors">+</button>
                                        ${tPct===100 ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--growth)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' : `
                                          <div class="progress-track h-1 w-12">
                                            <div class="progress-fill" style="width:${tPct}%;background:var(--focus)"></div>
                                          </div>
                                        `}
                                      </div>
                                    </div>
                                  `;
                                }).join('')}
                                <div class="flex gap-2 mt-2 pt-2 border-t border-[var(--border-subtle)]">
                                  <button onclick="bulkUpdateUnit('${v.id}',${ui},'all')" class="btn btn-secondary text-xs py-1 flex-1">Mark All Watched</button>
                                  <button onclick="bulkUpdateUnit('${v.id}',${ui},'reset')" class="btn btn-ghost text-xs py-1">Reset Unit</button>
                                </div>
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  ` : expandedVid ? `
                    <div class="border-t border-[var(--border-subtle)] p-4">
                      <div class="flex gap-2">
                        <button onclick="updateVideoFlat('${v.id}',5)" class="btn btn-secondary text-xs py-1 flex-1">+5 Videos</button>
                        <button onclick="updateVideoFlat('${v.id}',10)" class="btn btn-secondary text-xs py-1 flex-1">+10 Videos</button>
                        <input type="number" min="0" max="${v.total}" value="${watched}" onchange="setVideoWatchedFlat('${v.id}',this.value)" class="input w-20 text-center text-xs py-1">
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderFLSection(fls) {
      return `
        <div class="card mb-6 overflow-hidden">
          <div class="glass-header flex justify-between items-center">
            <h2 class="font-semibold">${icon.clipboard} Full Lengths</h2>
            <span class="text-xs text-[var(--text-muted)]">Tracked in Scores tab</span>
          </div>
          <div class="p-4">
            <div class="flex flex-wrap gap-2">
              ${fls.map(f => `
                <div class="bg-[var(--bg-base)] rounded-xl px-4 py-2 flex items-center gap-3">
                  <span class="${f.completed?'text-[var(--growth)]':''}">${f.completed?icon.check:''} ${f.name}</span>
                  <button onclick="toggleFL('${f.id}')" class="text-xs ${f.completed?'text-[var(--text-muted)]':'text-[var(--focus)]'}">${f.completed?'Undo':'Mark Done'}</button>
                  <button onclick="removeResource('${f.id}')" class="text-[var(--text-muted)] hover:text-[var(--alert)]">${icon.trash}</button>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderResourceLibrary() {
      const types = ['books','qbanks','anki','videos','fulllengths'];
      const typeLabels = {books:icon.book+' Books',qbanks:icon.helpCircle+' Question Banks',anki:icon.cardStack+' Anki Decks',videos:icon.videoIcon+' Video Courses',fulllengths:icon.clipboard+' Full Lengths'};

      return `
        <div class="flex gap-2 mb-6 flex-wrap">
          <button onclick="state.resourceFilter='all';render()" class="btn ${state.resourceFilter==='all'?'btn-primary':'btn-secondary'} text-sm">All</button>
          ${types.map(t => `
            <button onclick="state.resourceFilter='${t}';render()" class="btn ${state.resourceFilter===t?'btn-primary':'btn-secondary'} text-sm">${typeLabels[t]}</button>
          `).join('')}
        </div>

        ${types.filter(t => state.resourceFilter === 'all' || state.resourceFilter === t).map(type => `
          <div class="card mb-6 overflow-hidden">
            <div class="glass-header">
              <h2 class="font-semibold">${typeLabels[type]}</h2>
            </div>
            <div class="p-4 grid ${type==='books'?'grid-cols-2':'grid-cols-3'} gap-3">
              ${RESOURCE_LIBRARY[type].map(r => {
                const isAdded = state.myResources.some(mr => mr.id === r.id);
                return `
                  <div class="bg-[var(--bg-base)] rounded-xl p-4 ${isAdded?'ring-2 ring-[var(--growth)]/50':''}">
                    <div class="flex justify-between items-start mb-2">
                      <span class="font-medium text-sm">${r.name}</span>
                      ${r.official ? '<span class="text-xs bg-[var(--growth)]/20 text-[var(--growth)] px-2 py-0.5 rounded">Official</span>' : ''}
                      ${r.section ? '<span class="text-xs bg-[var(--focus)]/20 text-[var(--focus)] px-2 py-0.5 rounded">'+r.section+'</span>' : ''}
                    </div>
                    <div class="text-xs text-[var(--text-muted)] mb-3">${r.desc || ''}${r.chapters ? ' ¬∑ ' + r.chapters.length + ' chapters' : ''}${r.totalQ ? ' ¬∑ ' + r.totalQ + ' questions' : ''}${r.totalCards ? ' ¬∑ ' + r.totalCards + ' cards' : ''}${r.totalVids ? ' ¬∑ ' + r.totalVids + ' videos' + (r.units ? ', ' + r.units.length + ' units' : '') : ''}</div>
                    ${isAdded ? `
                      <div class="flex items-center gap-2 text-[var(--growth)] text-sm"><span>${icon.check}</span> Added</div>
                    ` : `
                      <button onclick="addResourceFromLibrary('${type}','${r.id}')" class="btn btn-primary text-xs py-1 w-full">+ Add to My Resources</button>
                    `}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `).join('')}
      `;
    }

    // Resource management functions
    function addResourceFromLibrary(type, id) {
      const lib = RESOURCE_LIBRARY[type];
      const item = lib.find(r => r.id === id);
      if (!item || state.myResources.some(r => r.id === id)) return;

      let newResource;
      if (type === 'books') {
        newResource = {
          id: item.id, name: item.name, type: 'book', section: item.section,
          chapters: item.chapters.map(c => ({
            name: c.name, done: false,
            subtopics: (c.subtopics || []).map(st => ({ name: st, done: false }))
          }))
        };
      } else if (type === 'qbanks') {
        newResource = { id: item.id, name: item.name, type: 'qbank', total: item.totalQ, done: 0, correct: 0, flagged: 0 };
      } else if (type === 'anki') {
        newResource = { id: item.id, name: item.name, type: 'anki', total: item.totalCards, mature: 0, learning: 0, dailyAvg: 0 };
      } else if (type === 'videos') {
        newResource = {
          id: item.id, name: item.name, type: 'video', total: item.totalVids,
          units: item.units.map(u => ({
            name: u.name, expanded: false,
            topics: u.topics.map(t => ({ name: t.name, vids: t.vids, watched: 0 }))
          }))
        };
      } else if (type === 'fulllengths') {
        newResource = { id: item.id, name: item.name, type: 'fl', official: item.official, completed: false };
      }

      state.myResources.push(newResource);
      save();
      render();
      showToast(`Added ${item.name}`);
      addXP(10, 'Resource added');
    }

    function removeResource(id) {
      const r = state.myResources.find(x => x.id === id);
      if (!r) return;
      showModal(`
        <div class="card p-6 w-96">
          <h3 class="font-semibold text-lg mb-2">Remove ${r.name}?</h3>
          <p class="text-[var(--text-muted)] mb-6">Your progress will be lost.</p>
          <div class="flex gap-3">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="state.myResources=state.myResources.filter(x=>x.id!=='${id}');save();hideModal();render();showToast('Removed')" class="btn flex-1" style="background:var(--alert);color:white">Remove</button>
          </div>
        </div>
      `);
    }

    function toggleChapter(bookId, chapterIdx) {
      const book = state.myResources.find(r => r.id === bookId);
      if (book && book.chapters[chapterIdx]) {
        const ch = book.chapters[chapterIdx];
        ch.done = !ch.done;
        // Also toggle all subtopics when chapter is toggled
        if (ch.subtopics) {
          ch.subtopics.forEach(st => st.done = ch.done);
        }
        save();
        render();
        if (ch.done) {
          addXP(20, 'Chapter completed');
          if (book.chapters.every(c => c.done)) {
            triggerConfetti();
            showToast(`${book.name} complete! üéâ`);
            addXP(50, 'Book completed');
          }
        }
      }
    }

    function toggleSubtopic(bookId, chapterIdx, subtopicIdx) {
      const book = state.myResources.find(r => r.id === bookId);
      if (book && book.chapters[chapterIdx] && book.chapters[chapterIdx].subtopics) {
        const st = book.chapters[chapterIdx].subtopics[subtopicIdx];
        if (st) {
          st.done = !st.done;
          // Auto-complete chapter if all subtopics done
          const ch = book.chapters[chapterIdx];
          if (ch.subtopics.every(s => s.done)) {
            ch.done = true;
          } else {
            ch.done = false;
          }
          save();
          render();
          if (st.done) {
            addXP(5, 'Subtopic completed');
          }
          // Check full book completion
          if (book.chapters.every(c => c.done)) {
            triggerConfetti();
            showToast(`${book.name} complete! üéâ`);
            addXP(50, 'Book completed');
          }
        }
      }
    }

    function updateQBank(id, field, amount) {
      const qb = state.myResources.find(r => r.id === id);
      if (qb) {
        qb[field] = Math.min(qb.total, Math.max(0, (qb[field]||0) + amount));
        save();
        render();
        addXP(amount, `${amount} questions done`);
      }
    }

    function showQBankModal(id) {
      const qb = state.myResources.find(r => r.id === id);
      if (!qb) return;
      showModal(`
        <div class="card p-6 w-96">
          <h3 class="font-semibold text-lg mb-4">${qb.name}</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-[var(--text-muted)]">Questions Done</label>
              <input type="number" id="qb-done" value="${qb.done}" min="0" max="${qb.total}" class="input mt-1">
            </div>
            <div>
              <label class="text-sm text-[var(--text-muted)]">% Correct</label>
              <input type="number" id="qb-correct" value="${qb.correct||0}" min="0" max="100" class="input mt-1">
            </div>
            <div>
              <label class="text-sm text-[var(--text-muted)]">Flagged for Review</label>
              <input type="number" id="qb-flagged" value="${qb.flagged||0}" min="0" class="input mt-1">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="saveQBankModal('${id}')" class="btn btn-primary flex-1">Save</button>
          </div>
        </div>
      `);
    }

    function saveQBankModal(id) {
      const qb = state.myResources.find(r => r.id === id);
      if (qb) {
        qb.done = parseInt(document.getElementById('qb-done').value) || 0;
        qb.correct = parseInt(document.getElementById('qb-correct').value) || 0;
        qb.flagged = parseInt(document.getElementById('qb-flagged').value) || 0;
        save();
        hideModal();
        render();
      }
    }

    function showAnkiModal(id) {
      const a = state.myResources.find(r => r.id === id);
      if (!a) return;
      showModal(`
        <div class="card p-6 w-96">
          <h3 class="font-semibold text-lg mb-4">${a.name}</h3>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-[var(--text-muted)]">Mature Cards</label>
              <input type="number" id="anki-mature" value="${a.mature||0}" min="0" max="${a.total}" class="input mt-1">
            </div>
            <div>
              <label class="text-sm text-[var(--text-muted)]">Learning Cards</label>
              <input type="number" id="anki-learning" value="${a.learning||0}" min="0" class="input mt-1">
            </div>
            <div>
              <label class="text-sm text-[var(--text-muted)]">Daily Average</label>
              <input type="number" id="anki-daily" value="${a.dailyAvg||0}" min="0" class="input mt-1">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="hideModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="saveAnkiModal('${id}')" class="btn btn-primary flex-1">Save</button>
          </div>
        </div>
      `);
    }

    function saveAnkiModal(id) {
      const a = state.myResources.find(r => r.id === id);
      if (a) {
        a.mature = parseInt(document.getElementById('anki-mature').value) || 0;
        a.learning = parseInt(document.getElementById('anki-learning').value) || 0;
        a.dailyAvg = parseInt(document.getElementById('anki-daily').value) || 0;
        save();
        hideModal();
        render();
      }
    }

    // Get total watched for a video resource (handles both old flat and new unit formats)
    function getVideoWatched(v) {
      if (v.units) {
        return v.units.reduce((s, u) => s + u.topics.reduce((ts, t) => ts + (t.watched||0), 0), 0);
      }
      return v.watched || 0;
    }

    function updateVideoTopic(videoId, unitIdx, topicIdx, delta) {
      const v = state.myResources.find(r => r.id === videoId);
      if (v && v.units && v.units[unitIdx] && v.units[unitIdx].topics[topicIdx]) {
        const topic = v.units[unitIdx].topics[topicIdx];
        const oldVal = topic.watched || 0;
        topic.watched = Math.min(topic.vids, Math.max(0, oldVal + delta));
        save();
        render();
        if (delta > 0) {
          addXP(2, 'Video watched');
          if (topic.watched === topic.vids && oldVal < topic.vids) {
            showToast(`${topic.name} complete!`);
          }
        }
      }
    }

    function bulkUpdateUnit(videoId, unitIdx, action) {
      const v = state.myResources.find(r => r.id === videoId);
      if (v && v.units && v.units[unitIdx]) {
        const unit = v.units[unitIdx];
        if (action === 'all') {
          const totalAdded = unit.topics.reduce((s, t) => s + (t.vids - (t.watched||0)), 0);
          unit.topics.forEach(t => t.watched = t.vids);
          if (totalAdded > 0) addXP(totalAdded, `${unit.name} completed`);
        } else {
          unit.topics.forEach(t => t.watched = 0);
        }
        save();
        render();
        if (action === 'all') showToast(`${unit.name} fully watched!`);
      }
    }

    // Legacy flat video update (for backwards compat with old-format resources)
    function updateVideoFlat(id, amount) {
      const v = state.myResources.find(r => r.id === id);
      if (v) {
        v.watched = Math.min(v.total, Math.max(0, (v.watched||0) + amount));
        save();
        render();
        addXP(amount * 2, `${amount} videos watched`);
      }
    }
    function setVideoWatchedFlat(id, val) {
      const v = state.myResources.find(r => r.id === id);
      if (v) {
        v.watched = Math.min(v.total, Math.max(0, parseInt(val) || 0));
        save();
        render();
      }
    }

    // Keep old function names for backwards compatibility
    function updateVideo(id, amount) { updateVideoFlat(id, amount); }
    function setVideoWatched(id, val) { setVideoWatchedFlat(id, val); }

    function toggleFL(id) {
      const fl = state.myResources.find(r => r.id === id);
      if (fl) {
        fl.completed = !fl.completed;
        save();
        render();
        if (fl.completed) {
          addXP(100, 'Full length completed');
        }
      }
    }

    function getResourceSuggestions() {
      const suggestions = [];
      const hasResource = id => state.myResources.some(r => r.id === id);

      // Check test scores for weak areas
      if (state.tests.length) {
        const latest = state.tests[state.tests.length - 1];
        if (latest.bb < latest.cp && latest.bb < latest.ps && !hasResource('uworld')) {
          suggestions.push({ type: 'qbanks', id: 'uworld', name: 'UWorld MCAT', icon: icon.helpCircle, reason: 'Your B/B is lagging - UWorld has great explanations' });
        }
        if (latest.cars < 125 && !hasResource('jw-qbank')) {
          suggestions.push({ type: 'qbanks', id: 'jw-qbank', name: 'Jack Westin CARS', icon: icon.book, reason: 'CARS needs work - daily practice helps' });
        }
        if (latest.ps < latest.bb && !hasResource('milesdown')) {
          suggestions.push({ type: 'anki', id: 'milesdown', name: 'MilesDown Anki', icon: icon.cardStack, reason: 'P/S could use flashcards for terminology' });
        }
      }

      // General suggestions
      if (!hasResource('aamc-sb') && state.myResources.length > 2) {
        suggestions.push({ type: 'qbanks', id: 'aamc-sb', name: 'AAMC Section Bank', icon: icon.zap, reason: 'Must-do official AAMC practice' });
      }
      if (!hasResource('khan-mcat') && state.myResources.filter(r=>r.type==='book').length === 0) {
        suggestions.push({ type: 'videos', id: 'khan-mcat', name: 'Khan Academy', icon: icon.videoIcon, reason: 'Free video content for all sections' });
      }

      return suggestions;
    }

    // Keep old functions for backwards compatibility
    function updRes(id, d) {
      const r = state.resources.find(x=>x.id===id);
      if(r) { r.progress = Math.min(100,Math.max(0,r.progress+d)); save(); render(); }
    }
    function setRes(id, v) {
      const r = state.resources.find(x=>x.id===id);
      if(r) { r.progress = Math.min(100,Math.max(0,parseInt(v)||0)); save(); render(); }
    }

    // ===== STUDY GUIDE =====
    const STUDY_GUIDE = [
      {
        id: 'getting-started',
        title: 'Getting Started',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        articles: [
          { title: 'When Should You Take the MCAT?', body: 'Most students take the MCAT 12-18 months before they plan to matriculate to medical school. The test is offered from late January through September. Aim for a date that gives you at least 3 months of dedicated study time. If you are still finishing prerequisite courses, wait until those are done. Summer test dates (May-July) are the most popular for a reason: you can dedicate full-time hours after spring semester ends.\n\nKey dates to plan around: AMCAS opens in late May, and medical schools use rolling admissions. Taking the MCAT by late May or June means your score arrives in time to submit a complete application early, which is a real advantage.' },
          { title: 'How Long Should You Study?', body: 'The AAMC reports the average student studies 300-350 hours total. That translates to roughly:\n\n‚Ä¢ 3-month plan: 25-30 hours per week (intense, best for summer)\n‚Ä¢ 4-month plan: 20-22 hours per week (manageable during lighter semesters)\n‚Ä¢ 6-month plan: 12-15 hours per week (sustainable alongside full coursework)\n\nQuality matters more than quantity. A focused 4-hour session beats 8 hours of distracted reading. Track your hours honestly, take real breaks, and trust the process.' },
          { title: 'Building Your Study Space', body: 'Create a dedicated study environment that minimizes distractions. Keep your phone in another room. Use website blockers during study blocks. Have water, snacks, and materials ready before you start. Many students find that studying in the same spot creates a Pavlovian focus response over time.\n\nIf you study at a library, claim the same desk. If you are at home, set up a desk that is only for MCAT prep. When you sit there, your brain should know what is happening.' }
        ]
      },
      {
        id: 'study-materials',
        title: 'Study Materials & Resources',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
        articles: [
          { title: 'Content Review Books', body: 'Kaplan 7-book set is the most popular starting point. It covers every topic in enough detail for the MCAT without going overboard. The Princeton Review goes slightly deeper on some science topics but is wordier. If you are starting from scratch, Kaplan is the safest bet.\n\nDo NOT read content books cover to cover passively. Read actively: take notes, make flashcards for terms you do not know, and do the end-of-chapter questions. Most importantly, do not spend more than 4-6 weeks on pure content review before mixing in practice questions.' },
          { title: 'Question Banks', body: 'UWorld is the gold standard third-party question bank. Their explanations are best-in-class and the difficulty level is close to the real MCAT. Blueprint (formerly NextStep) is a solid second choice.\n\nThe AAMC Question Packs and Section Bank are non-negotiable. Save the Section Bank for your last 4-6 weeks because it is the closest representation of real test difficulty. Many students report the Section Bank is harder than the actual test.' },
          { title: 'Anki Flashcards', body: 'Spaced repetition is the single most evidence-backed study technique. Use Anki daily. The top community decks:\n\n‚Ä¢ MilesDown: Comprehensive, well-organized, 2800+ cards. Best all-around deck.\n‚Ä¢ JackSparrow (JS): More detailed, especially strong for B/B and C/P. Around 5500 cards.\n‚Ä¢ Premed95 P/S: The definitive P/S deck based on the 300-page Khan Academy document.\n\nDo your Anki reviews every single day, even on rest days. 20-30 minutes of reviews is a small investment that compounds dramatically over months.' },
          { title: 'Video Resources', body: 'Khan Academy MCAT videos are free and excellent, especially for P/S. They are a great supplement if a topic from your textbook is not clicking.\n\nAK Lectures covers advanced biochemistry and biology topics clearly. Organic Chemistry Tutor is clutch for C/P calculations. For CARS, there is no substitute for reading practice, but some students find the Jack Westin daily free passage helpful for building a habit.' },
          { title: 'The AAMC Materials (Essential)', body: 'These are absolutely required and should be done in the final 6-8 weeks:\n\n‚Ä¢ 4 Full-Length Practice Tests (do all four, they are the most predictive of your score)\n‚Ä¢ Section Bank (300 hard questions across C/P, B/B, CARS)\n‚Ä¢ Question Packs (additional practice by section)\n‚Ä¢ CARS Diagnostic Tool and Question Packs\n‚Ä¢ Official MCAT Sample Test (free)\n\nDo NOT burn through these early. They are your most precious resource.' }
        ]
      },
      {
        id: 'section-strategies',
        title: 'Section-Specific Strategies',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
        articles: [
          { title: 'Chemical & Physical Foundations (C/P)', body: 'C/P is the most calculation-heavy section. You need to be fast with unit conversions, logarithms, and dimensional analysis. Practice mental math regularly.\n\nHigh-yield topics: Amino acid structures and properties (appears on EVERY test), acid-base chemistry, thermodynamics, electrochem, optics basics, and orgo reactions (SN1/SN2/E1/E2). The section often tests your ability to interpret graphs and data tables, so practice reading figures quickly.\n\nTiming tip: You have 95 minutes for 59 questions. Flag hard calculation questions and come back. Do not spend 4 minutes on one question when you could answer three easier ones in that time.' },
          { title: 'CARS (Critical Analysis & Reasoning)', body: 'CARS is the hardest section to improve quickly, which is why you should start practicing early. Read one passage per day minimum, starting from day one of your prep.\n\nThe key skill is not reading speed but comprehension accuracy. Read for the author main idea and tone. Every CARS passage has an argument. Find it. Most wrong answers are wrong because they are too extreme, too narrow, or from the wrong part of the passage.\n\nStrategies that work:\n‚Ä¢ Read the passage fully before looking at questions (do not skim)\n‚Ä¢ Mentally summarize each paragraph in one sentence\n‚Ä¢ Eliminate two obviously wrong answers first, then choose between the remaining two\n‚Ä¢ Do NOT bring outside knowledge. The answer is always in the passage.\n‚Ä¢ Practice with Jack Westin daily passages and AAMC CARS packs' },
          { title: 'Biological & Biochemical Foundations (B/B)', body: 'B/B rewards deep understanding of biochemistry and molecular biology. Memorize amino acids cold (structures, properties, pKa values, one-letter codes). Know metabolic pathways (glycolysis, TCA, ETC, gluconeogenesis, fatty acid oxidation) and where they happen in the cell.\n\nHigh-yield: Enzyme kinetics (Michaelis-Menten, Lineweaver-Burk, inhibition types), DNA replication and transcription, the immune system, endocrine signaling, and lab techniques (gel electrophoresis, PCR, blotting techniques, CRISPR basics).\n\nThis section loves experimental passages. Practice interpreting data from experiments you have never seen before. Understand controls, variables, and what conclusions you can and cannot draw.' },
          { title: 'Psychological, Social & Biological Foundations (P/S)', body: 'P/S is sometimes called "CARS 2.0" because it is passage-heavy and rewards careful reading. However, it is also the most improvable section because it is largely vocabulary-based.\n\nThe 300-page Khan Academy P/S document (or the 86-page condensed version) is the backbone resource. Read it, Anki it, know every term. The Premed95 Anki deck maps perfectly to this document.\n\nHigh-yield frameworks: Theories of emotion (James-Lange, Cannon-Bard, Schachter-Singer), Erikson stages, Piaget stages, Kohlberg stages, functionalism vs conflict theory, symbolic interactionism, types of learning (classical conditioning, operant, observational), and social psychology concepts (attribution, conformity, obedience).\n\nThe real test will throw terms at you from the 300-page doc that your textbook never mentioned. Trust the doc.' }
        ]
      },
      {
        id: 'practice-tests',
        title: 'Practice Tests & Review',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
        articles: [
          { title: 'When to Start Full-Lengths', body: 'Take your first diagnostic FL within the first 1-2 weeks of studying, before you have reviewed any content. This is not to get a good score. It is to establish your baseline and identify your weakest areas so you can prioritize your study plan.\n\nAfter that, start taking one FL per week once you are about 6-8 weeks out from your test date. In the final month, aim for one FL per week using AAMC materials exclusively.' },
          { title: 'How to Review a Full-Length (The Right Way)', body: 'Reviewing a FL should take as long as taking it. Go through EVERY question, not just the ones you got wrong:\n\n‚Ä¢ Wrong answers: Why was your answer wrong? Why is the right answer right? What concept did you miss?\n‚Ä¢ Right answers you guessed on: Understand why the right answer is right. Lucky guesses do not count as knowledge.\n‚Ä¢ Right answers you were confident about: Skim these but confirm your reasoning was correct.\n\nKeep a running "FL Review" document. Track patterns: Are you consistently missing orgo? Losing points on CARS main idea questions? This data is gold for your last few weeks of targeted review.' },
          { title: 'Score Interpretation', body: 'AAMC FLs are the most predictive of your real score. Third-party FLs (Kaplan, Blueprint, etc.) tend to score 3-7 points lower than your actual MCAT score.\n\nMost students see their biggest score jump between FL1 and FL2 as they learn the AAMC question style. Your FL3 and FL4 scores are the best predictors.\n\nIf your scores are plateauing, do not just take more FLs. Go back to content review in your weak areas and do targeted practice. More tests without learning does not help.' },
          { title: 'Recommended FL Order', body: 'Save the best for last. Here is a suggested order:\n\n1. AAMC Sample (free, unscored but you can estimate) as early diagnostic\n2. Third-party FLs (Kaplan, Blueprint) during content review phase\n3. AAMC FL1 about 6-7 weeks out\n4. AAMC FL2 about 4-5 weeks out\n5. AAMC FL3 about 2-3 weeks out\n6. AAMC FL4 about 1-2 weeks out\n\nAlways take FLs under realistic conditions: timed, no phone, take the breaks, same start time as your real test.' }
        ]
      },
      {
        id: 'study-schedules',
        title: 'Study Schedules & Pacing',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        articles: [
          { title: '3-Month Intensive Plan', body: 'Best for: Summer studiers, post-graduates, anyone who can study full-time.\n\nWeeks 1-4: Content review. Read through your Kaplan books, make Anki cards, do end-of-chapter problems. 6-8 hours per day. Start daily Anki reviews and one CARS passage per day from day one.\n\nWeeks 5-8: Mixed practice. Half your time on remaining content gaps, half on UWorld or question banks. Take first AAMC FL at the start of week 5. Continue Anki daily.\n\nWeeks 9-12: Full practice mode. Weekly AAMC FLs. Section Bank. AAMC question packs. Targeted content review based on FL misses. Taper study hours in the final week.' },
          { title: '6-Month Part-Time Plan', body: 'Best for: Students studying alongside coursework or a job.\n\nMonths 1-2: Content review only. One subject area per week. Read, take notes, make cards. 2-3 hours per day on weekdays, 4-5 on weekends. CARS practice starts immediately.\n\nMonths 3-4: Transition to practice. Start UWorld alongside remaining content. Take diagnostic AAMC FL. Identify and shore up weak areas. 3-4 hours per day.\n\nMonths 5-6: Practice intensive. Weekly FLs starting month 5. AAMC materials exclusively in month 6. Section Bank, question packs, FL reviews. Taper in the final week.' },
          { title: 'How to Adjust Your Pace', body: 'Your schedule is a guideline, not a prison. Check in every two weeks:\n\n‚Ä¢ Are your practice scores improving? If yes, stay the course.\n‚Ä¢ Plateauing? Shift more time to weak areas. Do targeted content review.\n‚Ä¢ Scores dropping? You might be burned out. Take 2-3 days fully off.\n‚Ä¢ Consistently scoring at your target? You might be ready early.\n\nNever extend your study timeline past 6 months. Research shows diminishing returns beyond that point. If you are not ready, postpone and reset rather than dragging it out.' }
        ]
      },
      {
        id: 'test-day',
        title: 'Test Day Preparation',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        articles: [
          { title: 'What to Bring', body: 'Required: Valid government-issued ID (must match your AAMC registration exactly). That is it. Everything else stays in your locker.\n\nRecommended for your locker: Snacks (protein bars, nuts, fruit), water, a light jacket (testing rooms are often cold), earplugs (backup in case the provided ones are uncomfortable), and any comfort items.\n\nDo NOT bring: Notes or study materials. You will not look at them and they will just stress you out.' },
          { title: 'Timing Strategy', body: 'You have roughly 1.5 minutes per question on science sections and 1.7 minutes per question on CARS. That is tight.\n\nDevelop a flagging system during practice: Flag questions that take more than 2 minutes, finish the section, then return to flagged questions. Never leave a question blank (there is no penalty for guessing).\n\nPace checks: By question 20, you should be about 30 minutes in. By question 40, about 60 minutes in. If you are behind, start moving faster on easy questions.' },
          { title: 'Break Strategy', body: 'You get a 10-minute break after each section (30 minutes for lunch after CARS). Use every break. Get up, stretch, eat something, use the bathroom, and reset mentally.\n\nDo not think about the section you just finished. It is over. What is done is done. Focus only on what is ahead. Many students report that their worst section felt like their best, and vice versa. Trust your preparation and move forward.' },
          { title: 'The Night Before', body: 'Do NOT study the night before. Your brain needs rest to perform. Eat a normal dinner, pack your bag, lay out your clothes, set two alarms, and go to bed at your normal time.\n\nIf you cannot sleep, do not panic. One night of poor sleep does not significantly impact cognitive performance. The adrenaline on test day will carry you. Just rest your eyes and stay calm.' }
        ]
      },
      {
        id: 'mental-health',
        title: 'Mental Health & Wellness',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
        articles: [
          { title: 'Dealing with Burnout', body: 'Burnout is not laziness. It is your brain telling you it needs recovery. Signs: dreading study sessions, inability to focus, feeling like nothing sticks, irritability, loss of motivation.\n\nWhen it hits: Take 2-3 full days off. No Anki, no passages, no guilt. Exercise, see friends, do things you enjoy. When you come back, start with easy wins (Anki reviews, one passage) to rebuild momentum.\n\nPrevention: Schedule one full day off per week. Exercise regularly. Sleep 7-8 hours. Study burnout does not come from one hard week. It comes from months of ignoring your limits.' },
          { title: 'Bad Practice Test Scores', body: 'A bad FL score feels devastating. It is not. One score is a data point, not a verdict.\n\nWhat to do after a bad FL:\n1. Take the rest of the day off. Process the disappointment.\n2. Review the FL the next day with a clear head.\n3. Identify the specific topics or question types that hurt you.\n4. Make a targeted study plan for those areas.\n5. Remember: the whole point of practice tests is to find weaknesses BEFORE the real test.\n\nIf you drop 5+ points on a FL, check if external factors were at play (sick, distracted, did not sleep). Do not change your entire study plan based on one bad day.' },
          { title: 'Comparison Anxiety', body: 'Reddit, Student Doctor Network, and social media will show you people scoring 520+ who make it look easy. This is survivorship bias. You are seeing the highlight reels, not the months of struggle behind them.\n\nYour prep is yours. Your timeline is valid. Someone studying 10 hours a day is not necessarily learning more than someone studying 5 focused hours. Unfollow accounts that make you feel behind. Mute MCAT subreddits if they are hurting more than helping.\n\nThe only score that matters is the one on your real test day. Everything before that is practice.' },
          { title: 'Imposter Syndrome', body: 'Feeling like you are not smart enough for medical school is incredibly common. Almost every pre-med feels it. The MCAT can amplify this because it reduces months of effort to a three-digit number.\n\nRemember: The MCAT tests a specific set of skills that can be learned. It does not measure your worth as a future physician. Many incredible doctors were not perfect scorers.\n\nWhen imposter syndrome hits, list three things you learned this week that you did not know before. You are growing. The evidence is there, even when the feelings say otherwise.' }
        ]
      },
      {
        id: 'faqs',
        title: 'Frequently Asked Questions',
        icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
        articles: [
          { title: 'Is Kaplan/TPR enough for content review?', body: 'For most students, yes. Kaplan or TPR covers 90%+ of the content you will see on the MCAT. The remaining 10% comes from practice questions, FL reviews, and supplementary sources like Khan Academy. No single resource covers everything, and you will always encounter a few questions on test day that feel brand new. That is normal and expected.\n\nDo not fall into the trap of buying every book. Master one set thoroughly rather than skimming three.' },
          { title: 'How many full-lengths should I take?', body: 'At minimum: all 4 AAMC FLs plus the Sample Test. That is your floor.\n\nIdeal: 4 AAMC + 4-6 third-party FLs (Kaplan, Blueprint), for a total of 8-10 over your prep period. Taking one per week in the last 6-8 weeks is the sweet spot.\n\nMore than 12-15 total FLs has diminishing returns. Your time is better spent on thorough review and targeted content work.' },
          { title: 'When should I start CARS practice?', body: 'Day one. Literally the first day of your MCAT prep, do one CARS passage. CARS is a skill that develops slowly through consistent practice. Starting early and doing at least one passage per day is far more effective than cramming CARS practice in the last month.\n\nGood free resources for daily CARS: Jack Westin (one free passage daily), Khan Academy CARS passages. Save AAMC CARS question packs for the last 6-8 weeks.' },
          { title: 'What score do I need for [school]?', body: 'There is no universal cutoff. However, general guidelines:\n\n‚Ä¢ 505-509: Competitive for DO schools and lower-tier MD schools\n‚Ä¢ 510-514: Competitive for mid-tier MD schools, strong for DO\n‚Ä¢ 515-519: Competitive for most MD schools including many top-25\n‚Ä¢ 520+: Competitive everywhere, but not a guarantee anywhere\n\nRemember: The MCAT is one part of a holistic application. A 510 with incredible research, clinical experience, and a compelling story can beat a 520 with a thin application. Check the MSAR database for school-specific median scores.' },
          { title: 'Should I retake a [score]?', body: 'Ask yourself:\n1. Is my score below the median for schools I am targeting? If yes, consider retaking.\n2. Do I have clear areas for improvement? If you can identify 5-10 points of specific gains, a retake makes sense.\n3. Was test day an anomaly? If you were sick or had a personal crisis, one bad day should not define you.\n\nIf your score is within 1-2 points of your FL average, a retake is risky because you might score the same or lower. If your score was 5+ points below your FL average, there is likely room to improve.\n\nMany schools see all MCAT attempts. A significant improvement (3+ points) looks good. A lateral move or decrease does not help.' },
          { title: 'How do I stay motivated for months of studying?', body: 'Break your prep into phases with mini-milestones. Celebrate finishing content review. Celebrate your first FL. Celebrate breaking 500, then 505, then 510.\n\nRemind yourself WHY you want to be a doctor. Keep a note on your phone or a sticky note on your desk with your reason. On the hardest days, that reason is what gets you to sit down and study.\n\nFind an accountability partner. Study with a friend, join an online study group, or use this dashboard to track your streaks and hours. Seeing your own progress is motivating. You have put in more work than you think.' }
        ]
      }
    ];

    function renderGuide(el) {
      const search = state.guideSearch.toLowerCase();
      const filtered = STUDY_GUIDE.filter(section => {
        if (!search) return true;
        if (section.title.toLowerCase().includes(search)) return true;
        return section.articles.some(a => a.title.toLowerCase().includes(search) || a.body.toLowerCase().includes(search));
      });
      const guideQuote = getSmartQuote('motivation');

      el.innerHTML = `
        <div class="p-8 animate-in" style="max-width:750px;margin:0 auto">
          <div class="mb-8">
            <h1 class="text-2xl font-bold mb-2">Study Guide</h1>
            <p class="text-[var(--text-muted)]">Everything you need to know about MCAT prep, written by students who have been through it.</p>
          </div>

          <div class="mb-6">
            <input type="text" value="${state.guideSearch}" oninput="state.guideSearch=this.value;render()" placeholder="Search topics, strategies, advice..." class="input w-full text-sm" style="background:var(--surface-2);border-color:var(--border-subtle)">
          </div>

          ${filtered.length === 0 ? `
            <div class="text-center py-12 text-[var(--text-muted)]">
              <div class="text-4xl mb-3 opacity-50">${icon.helpCircle}</div>
              <p>No sections match your search.</p>
            </div>
          ` : ''}

          <div class="space-y-4">
            ${filtered.map(section => {
              const isExpanded = state.guideExpanded[section.id];
              return `
                <div class="card overflow-hidden reveal">
                  <button onclick="state.guideExpanded['${section.id}']=!state.guideExpanded['${section.id}'];render()" class="w-full text-left p-5 flex items-center gap-4 hover:bg-[var(--surface-2)] transition-colors">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:var(--focus);color:white;opacity:${isExpanded?'1':'0.7'}">
                      ${section.icon}
                    </div>
                    <div class="flex-1">
                      <h2 class="font-semibold text-[var(--text-primary)]">${section.title}</h2>
                      <p class="text-xs text-[var(--text-muted)] mt-0.5">${section.articles.length} articles</p>
                    </div>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition:transform 0.2s;transform:rotate(${isExpanded?'180':'0'}deg)"><polyline points="6 9 12 15 18 9"/></svg>
                  </button>
                  ${isExpanded ? `
                    <div class="border-t border-[var(--border-subtle)]">
                      ${section.articles.map((article, aIdx) => `
                        <div class="p-5 ${aIdx > 0 ? 'border-t border-[var(--border-subtle)]' : ''}">
                          <h3 class="font-semibold text-sm text-[var(--focus)] mb-3">${article.title}</h3>
                          <div class="text-sm text-[var(--text-secondary)] leading-relaxed space-y-3">
                            ${article.body.split('\n\n').map(para => {
                              if (para.startsWith('‚Ä¢') || para.includes('\n‚Ä¢')) {
                                const lines = para.split('\n').filter(l => l.trim());
                                return '<ul class="space-y-1 ml-1">' + lines.map(line => {
                                  const text = line.replace(/^[‚Ä¢\-]\s*/, '');
                                  return '<li class="flex gap-2"><span class="text-[var(--focus)] mt-1 flex-shrink-0">&#8226;</span><span>' + text + '</span></li>';
                                }).join('') + '</ul>';
                              }
                              if (/^\d+\./.test(para.trim())) {
                                const lines = para.split('\n').filter(l => l.trim());
                                return '<ol class="space-y-1 ml-1">' + lines.map(line => {
                                  return '<li class="flex gap-2"><span class="text-[var(--focus)] font-semibold flex-shrink-0">' + (line.match(/^(\d+)\./)?.[1] || '') + '.</span><span>' + line.replace(/^\d+\.\s*/, '') + '</span></li>';
                                }).join('') + '</ol>';
                              }
                              return '<p>' + para + '</p>';
                            }).join('')}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>

          <div class="quote-card mt-8 reveal" style="border-left:2px solid var(--focus)">
            <p class="text-sm mb-1">"${guideQuote.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${guideQuote.author}</p>
          </div>
        </div>
      `;
    }

    // ===== TIMER =====
    function renderTimer(el) {
      const cats = ['Content Review','Practice Questions','Full Length','Anki','CARS Practice','Review','Videos','Other'];
      const timerQuote = getSmartQuote('timer');
      const sessionProgress = state.pomodoroSessionCount % state.pomodoroSessionsUntilLongBreak;

      el.innerHTML = `
        <div class="p-8 max-w-md mx-auto animate-in">
          <h1 class="text-2xl font-bold mb-6 text-center">Study Timer</h1>

          <div class="card p-8 text-center mb-6">
            ${state.isBreak ? '<div class="text-sm font-semibold text-[var(--energy)] mb-2">' + icon.coffee + ' Break Time</div>' : ''}
            <div class="timer-display ${state.timerRunning?'running':''} mb-2" id="timer-val">${formatTimeLong(state.timerSeconds)}</div>
            <div class="text-sm text-[var(--text-muted)] mb-6">${state.pomodoroMode ? (state.isBreak ? 'Break' : 'Pomodoro') : 'Stopwatch'} Mode</div>

            ${state.pomodoroMode ? `
              <div class="flex justify-center gap-2 mb-6">
                ${Array.from({length: state.pomodoroSessionsUntilLongBreak}, (_, i) => `
                  <div class="w-3 h-3 rounded-full transition-all ${i < sessionProgress ? 'bg-[var(--growth)]' : 'bg-[var(--bg-base)]'}" title="Session ${i+1}"></div>
                `).join('')}
              </div>
              <div class="text-xs text-[var(--text-muted)] mb-6">
                ${state.pomodoroSessionCount} sessions today ¬∑ ${sessionProgress}/${state.pomodoroSessionsUntilLongBreak} until long break
              </div>
            ` : ''}

            <div class="flex justify-center gap-4 mb-8">
              ${state.isBreak && !state.timerRunning ? `
                <button onclick="startTimer()" class="btn btn-primary btn-icon w-16 h-16 rounded-2xl" title="Start break">${icon.play}</button>
                <button onclick="skipBreak()" class="btn btn-secondary btn-icon w-14 h-14 rounded-xl" title="Skip break">${icon.skipForward}</button>
              ` : !state.timerRunning ? `
                <button onclick="startTimer()" class="btn btn-primary btn-icon w-16 h-16 rounded-2xl">${icon.play}</button>
              ` : `
                <button onclick="pauseTimer()" class="btn btn-secondary btn-icon w-16 h-16 rounded-2xl">${icon.pause}</button>
              `}
              <button onclick="stopTimer()" class="btn btn-secondary btn-icon w-14 h-14 rounded-xl">${icon.stop}</button>
              <button onclick="enterFocusMode()" class="btn btn-secondary btn-icon w-14 h-14 rounded-xl" title="Focus Mode (F)">${icon.expand}</button>
            </div>

            <div>
              <label class="stat-label block mb-2">Category</label>
              <select onchange="state.timerCategory=this.value" class="input">
                ${cats.map(c=>`<option ${state.timerCategory===c?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="card p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
              <span class="font-semibold">Timer Mode</span>
              <button onclick="state.pomodoroMode=!state.pomodoroMode;state.isBreak=false;state.timerSeconds=state.pomodoroMode?state.pomodoroMinutes*60:0;render()" class="btn btn-secondary text-sm">
                ${state.pomodoroMode?'Use Stopwatch':'Use Pomodoro'}
              </button>
            </div>
            ${state.pomodoroMode ? `
              <div class="mb-4">
                <div class="stat-label mb-2">Work Duration</div>
                <div class="flex gap-2 mb-3">
                  ${[15,25,45,60,90].map(m=>`
                    <button onclick="state.pomodoroMinutes=${m};state.timerSeconds=${m}*60;state.isBreak=false;render()" class="btn flex-1 text-sm ${state.pomodoroMinutes===m?'btn-primary':'btn-secondary'}">${m}m</button>
                  `).join('')}
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-[var(--text-muted)]">Custom:</span>
                  <input type="number" min="1" max="180" value="${state.pomodoroMinutes}" onchange="state.pomodoroMinutes=Math.min(180,Math.max(1,parseInt(this.value)||25));state.timerSeconds=state.pomodoroMinutes*60;state.isBreak=false;save();render()" class="input w-20 text-sm text-center">
                  <span class="text-xs text-[var(--text-muted)]">min</span>
                </div>
              </div>

              <div class="mb-4">
                <div class="stat-label mb-2">Short Break</div>
                <div class="flex gap-2">
                  ${[3,5,10].map(m=>`
                    <button onclick="state.pomodoroBreakMinutes=${m};save();render()" class="btn flex-1 text-sm ${state.pomodoroBreakMinutes===m?'btn-primary':'btn-secondary'}">${m}m</button>
                  `).join('')}
                </div>
              </div>

              <div class="mb-4">
                <div class="stat-label mb-2">Long Break (every ${state.pomodoroSessionsUntilLongBreak} sessions)</div>
                <div class="flex gap-2">
                  ${[10,15,20,30].map(m=>`
                    <button onclick="state.pomodoroLongBreakMinutes=${m};save();render()" class="btn flex-1 text-sm ${state.pomodoroLongBreakMinutes===m?'btn-primary':'btn-secondary'}">${m}m</button>
                  `).join('')}
                </div>
              </div>

              <div class="flex items-center justify-between">
                <span class="text-sm">Sound notification</span>
                <button onclick="state.timerSoundEnabled=!state.timerSoundEnabled;save();render()" class="btn btn-ghost text-sm">
                  ${state.timerSoundEnabled ? icon.bell + ' On' : icon.bellOff + ' Off'}
                </button>
              </div>
            ` : ''}
          </div>

          <div class="quote-card">
            <p class="text-sm italic mb-1">"${timerQuote.text}"</p>
            <p class="text-xs text-[var(--text-muted)]">‚Äî ${timerQuote.author}</p>
          </div>
        </div>
      `;
    }

    // ===== ACHIEVEMENTS =====
    function renderAchievements(el) {
      const unlocked = ACHIEVEMENTS.filter(a => state.achievements[a.id]).length;
      const categories = [
        { id: 'all', label: 'All', icon: icon.trophy },
        { id: 'streak', label: 'Streaks', icon: icon.flame },
        { id: 'hours', label: 'Study Hours', icon: icon.clock },
        { id: 'scores', label: 'Scores', icon: icon.chart },
        { id: 'mastery', label: 'Mastery', icon: icon.target },
        { id: 'resources', label: 'Resources', icon: icon.folder },
        { id: 'special', label: 'Special', icon: icon.zap }
      ];
      const tierColors = {
        bronze: { bg: 'rgba(205,127,50,0.15)', border: 'rgba(205,127,50,0.4)', text: '#cd7f32', label: 'Bronze' },
        silver: { bg: 'rgba(192,192,192,0.15)', border: 'rgba(192,192,192,0.4)', text: '#c0c0c0', label: 'Silver' },
        gold: { bg: 'rgba(255,215,0,0.15)', border: 'rgba(255,215,0,0.4)', text: '#ffd700', label: 'Gold' },
        platinum: { bg: 'rgba(229,228,226,0.15)', border: 'rgba(180,180,255,0.4)', text: '#b4b4ff', label: 'Platinum' }
      };
      const filtered = state.achievementFilter === 'all' ? ACHIEVEMENTS : ACHIEVEMENTS.filter(a => a.cat === state.achievementFilter);
      const filteredUnlocked = filtered.filter(a => state.achievements[a.id]).length;

      el.innerHTML = `
        <div class="p-8 max-w-5xl animate-in">
          <div class="flex justify-between items-start mb-6">
            <div>
              <h1 class="text-2xl font-bold mb-1">Achievements</h1>
              <p class="text-[var(--text-muted)]">${unlocked} of ${ACHIEVEMENTS.length} unlocked ¬∑ ${Math.round(unlocked/ACHIEVEMENTS.length*100)}% complete</p>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-[var(--energy)]">${unlocked}</div>
              <div class="text-xs text-[var(--text-muted)]">Total unlocked</div>
            </div>
          </div>

          <!-- Progress bar -->
          <div class="card p-4 mb-6">
            <div class="flex items-center gap-4">
              <div class="progress-track flex-1 h-3">
                <div class="progress-fill" style="width:${Math.round(unlocked/ACHIEVEMENTS.length*100)}%;background:linear-gradient(90deg,var(--focus),var(--growth))"></div>
              </div>
              <span class="font-mono text-sm font-semibold">${Math.round(unlocked/ACHIEVEMENTS.length*100)}%</span>
            </div>
            <div class="flex justify-between mt-2 text-xs text-[var(--text-muted)]">
              <span>${unlocked} unlocked</span>
              <span>${ACHIEVEMENTS.length - unlocked} remaining</span>
            </div>
          </div>

          <!-- Category tabs -->
          <div class="flex gap-2 mb-6 flex-wrap">
            ${categories.map(c => {
              const count = c.id === 'all' ? ACHIEVEMENTS.length : ACHIEVEMENTS.filter(a => a.cat === c.id).length;
              const catUnlocked = c.id === 'all' ? unlocked : ACHIEVEMENTS.filter(a => a.cat === c.id && state.achievements[a.id]).length;
              return `
                <button onclick="state.achievementFilter='${c.id}';render()" class="btn ${state.achievementFilter===c.id?'btn-primary':'btn-secondary'} text-sm">
                  ${c.icon} ${c.label} <span class="ml-1 opacity-70">${catUnlocked}/${count}</span>
                </button>
              `;
            }).join('')}
          </div>

          <!-- Achievement grid -->
          <div class="grid grid-cols-4 gap-4">
            ${filtered.map(a => {
              const isUnlocked = state.achievements[a.id];
              const tier = tierColors[a.tier] || tierColors.bronze;
              return `
                <div class="card p-5 text-center transition-all ${isUnlocked ? 'hover:scale-[1.02]' : 'opacity-40 grayscale'}" style="${isUnlocked ? `border-color:${tier.border}` : ''}">
                  <div class="relative">
                    <div class="achievement ${isUnlocked ? '' : 'locked'} mx-auto mb-3" style="background:${isUnlocked ? tier.bg : 'linear-gradient(135deg, var(--bg-elevated), var(--bg-hover))'}">
                      ${isUnlocked ? '<div class="achievement-glow"></div>' : ''}
                      <span class="text-2xl">${a.icon}</span>
                    </div>
                    <span class="absolute -top-1 -right-1 text-xs px-1.5 py-0.5 rounded-full font-semibold" style="background:${tier.bg};color:${tier.text};border:1px solid ${tier.border}">${tier.label}</span>
                  </div>
                  <h3 class="font-semibold text-sm mb-1">${a.name}</h3>
                  <p class="text-xs text-[var(--text-muted)] mb-2">${a.desc}</p>
                  ${isUnlocked ? `<p class="text-xs font-semibold" style="color:${tier.text}">Unlocked!</p>` : '<p class="text-xs text-[var(--text-muted)] italic">Locked</p>'}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    // ===== DEMO DATA GENERATOR =====
    // Simulates "Sarah" - a pre-med student's 3-month MCAT journey
    function clearAllData() {
      if (!confirm('This will DELETE all your data permanently. Are you sure?')) return;
      localStorage.clear();
      location.reload();
    }

    // Calculate study stats for "On Track" indicator
    function getStudyStats() {
      const days = daysUntil(state.testDate);
      const totalHours = state.logs.reduce((s, l) => s + l.hours, 0);
      const avgHoursPerDay = state.logs.length ? totalHours / 90 : 0; // Assuming 90-day prep

      // Recommended: 300-400 hours total, or about 4-5 hours/day for 90 days
      const recommendedTotal = 350;
      const recommendedPerDay = days > 0 ? (recommendedTotal - totalHours) / days : 0;

      // On track if they've studied enough relative to days remaining
      const expectedProgress = Math.max(0, (90 - days) / 90);
      const actualProgress = totalHours / recommendedTotal;
      const isOnTrack = actualProgress >= expectedProgress * 0.85;

      return {
        totalHours,
        recommendedPerDay: Math.max(0, recommendedPerDay),
        isOnTrack,
        progressPercent: Math.min(100, (totalHours / recommendedTotal) * 100)
      };
    }

    // ===== INIT =====
    initParticles();
    if (!localStorage.getItem('mcat-onboarded')) {
      renderWizard();
    } else {
      render();
      checkAchievements();
      setTimeout(checkBackupReminder, 2000);
    }

    // Streak check
    if(state.lastStudyDate) {
      const y = new Date(); y.setDate(y.getDate()-1);
      if(state.lastStudyDate !== today() && state.lastStudyDate !== y.toISOString().split('T')[0]) {
        state.streak = 0; save();
      }
    }

    // Card mouse tracking
    document.addEventListener('mousemove', e => {
      document.querySelectorAll('.card').forEach(card => {
        const rect = card.getBoundingClientRect();
        card.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
        card.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
      });
    });
  </script>
</body>
</html>
